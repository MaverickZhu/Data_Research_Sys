{% extends "base.html" %}

{% block title %}匹配管理 - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="header bg-light p-5 rounded-3 mb-4">
        <h1 class="display-4"><i class="fas fa-tasks"></i> 匹配管理</h1>
        <p class="lead text-muted">启动、监控和管理您的数据匹配任务。</p>
    </div>

    <!-- 导航标签 -->
    <ul class="nav nav-tabs nav-fill mb-4" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="start-tab" data-bs-toggle="tab" data-bs-target="#start-panel" type="button" role="tab">启动匹配</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="progress-tab" data-bs-toggle="tab" data-bs-target="#progress-panel" type="button" role="tab">进度监控</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks-panel" type="button" role="tab">任务管理</button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        <!-- 启动匹配面板 -->
        <div class="tab-pane fade show active" id="start-panel" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">发起新任务</h5>
                    <div class="alert alert-info mt-3">
                        <strong>匹配说明：</strong>系统将对消防监督管理系统和消防隐患安全排查系统中的单位数据进行智能关联匹配。
                    </div>

                    <form id="matching-form">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="match-type" class="form-label">匹配类型</label>
                                <select id="match-type" class="form-select">
                                    <option value="both">智能匹配（精确+模糊）</option>
                                    <option value="exact">仅精确匹配</option>
                                    <option value="fuzzy">仅模糊匹配</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="batch-size" class="form-label">批处理大小</label>
                                <select id="batch-size" class="form-select">
                                    <option value="100" selected>标准（100条/批）</option>
                                    <option value="200">较大（200条/批）</option>
                                    <option value="500">超大（500条/批）</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="match-mode" class="form-label">匹配模式</label>
                                <select id="match-mode" class="form-select">
                                    <option value="incremental">增量匹配（推荐）</option>
                                    <option value="full">全量匹配（清空后）</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                            <button type="button" class="btn btn-primary btn-lg" onclick="startOptimizedMatching()">
                                <i class="fas fa-rocket"></i> 开始智能匹配
                            </button>
                        </div>
                    </form>
                </div>
            </div>

             <!-- 进度显示 -->
             <div id="progress-container" class="mt-4" style="display: none;">
                <div class="card">
                    <div class="card-body">
                         <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">匹配进度</h5>
                            <button type="button" class="btn btn-danger btn-sm" onclick="stopMatching()">
                                <i class="fas fa-stop-circle"></i> 停止任务
                            </button>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div id="progress-fill" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                <span id="progress-percent-text">0%</span>
                            </div>
                        </div>
                        <div class="row text-center mt-3">
                            <div class="col">
                                <div class="fs-4 fw-bold" id="processed-count">0</div>
                                <div class="text-muted">已处理</div>
                            </div>
                             <div class="col">
                                <div class="fs-4 fw-bold" id="matched-count">0</div>
                                <div class="text-muted">匹配成功</div>
                            </div>
                            <div class="col">
                                <div class="fs-4 fw-bold" id="match-rate">0%</div>
                                <div class="text-muted">匹配率</div>
                            </div>
                            <div class="col">
                                <div class="fs-4 fw-bold" id="elapsed-time">0s</div>
                                <div class="text-muted">已用时间</div>
                            </div>
                            <div class="col">
                                <div class="fs-4 fw-bold" id="remaining-time">-</div>
                                <div class="text-muted">预计剩余</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- 进度监控面板 -->
        <div class="tab-pane fade" id="progress-panel" role="tabpanel">
             <div class="card">
                <div class="card-body">
                    <h5 class="card-title">实时进度监控</h5>
                    <div id="monitoring-content">
                        <p class="text-muted">暂无运行中的匹配任务。</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 任务管理面板 -->
        <div class="tab-pane fade" id="tasks-panel" role="tabpanel">
             <div class="card">
                <div class="card-body">
                    <h5 class="card-title">任务管理</h5>
                    <div id="task-list" class="task-list">
                        <!-- 任务列表将通过JavaScript动态加载 -->
                        <p class="text-muted">功能开发中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 决策分析模态框 -->
<div class="modal fade" id="details-modal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-info-circle"></i> 决策分析</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="modal-unit-info" class="mb-4"></div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-success-subtle">
                                ✅ 支持匹配的理由 (加分项)
                            </div>
                            <ul id="positive-evidence" class="list-group list-group-flush"></ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                             <div class="card-header bg-danger-subtle">
                                ⚠️ 反对匹配的理由 (减分项)
                            </div>
                            <ul id="negative-evidence" class="list-group list-group-flush"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentTaskId = null;
    let progressInterval = null;

    // 显示面板
    function showPanel(panelName) {
        // 隐藏所有面板
        document.querySelectorAll('.content-panel').forEach(panel => {
            panel.classList.remove('active');
        });
        
        // 移除所有标签的active状态
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // 显示选中的面板
        document.getElementById(panelName + '-panel').classList.add('active');
        
        // 激活对应的标签
        event.target.classList.add('active');
    }

    // 启动优化匹配
    async function startOptimizedMatching() {
        const matchType = document.getElementById('match-type').value;
        const batchSize = parseInt(document.getElementById('batch-size').value);
        const matchMode = document.getElementById('match-mode').value;
        
        try {
            const response = await fetch('/api/start_optimized_matching', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    match_type: matchType,
                    batch_size: batchSize,
                    mode: matchMode
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                currentTaskId = result.task_id;
                document.getElementById('progress-container').style.display = 'block';
                
                // 开始监控进度
                startOptimizedProgressMonitoring();
                
                showAlert('success', `智能匹配任务启动成功！模式: ${matchMode}, 任务ID: ${result.task_id}`);
            } else {
                showAlert('error', '启动失败: ' + result.error);
            }
        } catch (error) {
            showAlert('error', '请求失败: ' + error.message);
        }
    }

    // 清空并重新匹配
    async function clearAndRestart() {
        if (!confirm('确认要清空所有匹配结果并重新开始匹配吗？此操作不可撤销！')) {
            return;
        }
        
        try {
            // 先清空匹配结果
            const clearResponse = await fetch('/api/clear_match_results', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    confirm: true
                })
            });
            
            const clearResult = await clearResponse.json();
            
            if (clearResult.success) {
                showAlert('success', `已清空 ${clearResult.deleted_count} 条匹配结果`);
                
                // 设置为全量匹配模式
                document.getElementById('match-mode').value = 'full';
                
                // 启动匹配
                setTimeout(() => {
                    startOptimizedMatching();
                }, 1000);
            } else {
                showAlert('error', '清空失败: ' + clearResult.error);
            }
        } catch (error) {
            showAlert('error', '请求失败: ' + error.message);
        }
    }

    // 启动匹配（保留旧版本兼容性）
    async function startMatching() {
        return startOptimizedMatching();
    }

    // 停止匹配
    async function stopMatching() {
        if (!currentTaskId) return;
        
        try {
            const response = await fetch(`/api/stop_optimized_matching/${currentTaskId}`, {
                method: 'POST'
            });
            
            const result = await response.json();
            
            if (result.success) {
                stopProgressMonitoring();
                showAlert('success', '智能匹配任务已停止');
            } else {
                showAlert('error', '停止失败: ' + result.message);
            }
        } catch (error) {
            showAlert('error', '请求失败: ' + error.message);
        }
    }

    // 开始优化进度监控
    function startOptimizedProgressMonitoring() {
        if (progressInterval) clearInterval(progressInterval);
        
        progressInterval = setInterval(async () => {
            if (!currentTaskId) return;
            
            try {
                const response = await fetch(`/api/optimized_task_progress/${currentTaskId}`);
                const progress = await response.json();
                
                updateProgressDisplay(progress);
                
                // 如果任务完成，停止监控
                if (progress.status === 'completed' || progress.status === 'error' || progress.status === 'stopped') {
                    stopProgressMonitoring();
                    
                    if (progress.status === 'completed') {
                        showAlert('success', '智能匹配任务完成！');
                    } else if (progress.status === 'stopped') {
                        showAlert('warning', '匹配任务已停止');
                    } else {
                        showAlert('error', '匹配任务出错');
                    }
                }
            } catch (error) {
                console.error('获取进度失败:', error);
            }
        }, 2000); // 每2秒更新一次
    }

    // 开始进度监控（保留旧版本兼容性）
    function startProgressMonitoring() {
        return startOptimizedProgressMonitoring();
    }

    // 停止进度监控
    function stopProgressMonitoring() {
        if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
        }
    }

    // 更新进度显示
    function updateProgressDisplay(progress) {
        const percent = progress.progress_percent || 0;
        document.getElementById('progress-fill').style.width = percent + '%';
        document.getElementById('progress-fill').setAttribute('aria-valuenow', percent);
        document.getElementById('progress-percent-text').textContent = percent.toFixed(2) + '%';
        
        document.getElementById('processed-count').textContent = (progress.processed_records || 0).toLocaleString();
        document.getElementById('matched-count').textContent = (progress.matched_records || 0).toLocaleString();
        document.getElementById('match-rate').textContent = (progress.match_rate || 0).toFixed(2) + '%';
        document.getElementById('elapsed-time').textContent = Math.round(progress.elapsed_time || 0) + 's';
        
        const remainingTime = progress.estimated_remaining_time || 0;
        if (remainingTime > 0) {
            document.getElementById('remaining-time').textContent = Math.round(remainingTime) + 's';
        } else {
            document.getElementById('remaining-time').textContent = '-';
        }
    }

    // 显示提示信息
    function showAlert(type, message) {
        // 移除现有的提示
        const existingAlert = document.querySelector('.alert-dynamic');
        if (existingAlert) {
            existingAlert.remove();
        }
        
        // 创建新的提示
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dynamic`;
        alert.innerHTML = `<strong>${type === 'success' ? '成功' : '错误'}：</strong>${message}`;
        
        // 插入到表单前面
        const form = document.getElementById('matching-form');
        form.parentNode.insertBefore(alert, form);
        
        // 3秒后自动移除
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }

    // 示例：加载并渲染模糊匹配结果
    async function loadFuzzyReviewResults() {
        try {
            // 调用后端API获取待审核的模糊匹配结果
            const response = await fetch('/api/fuzzy_review_results');
            const data = await response.json();
            const tbody = document.getElementById('fuzzy-review-tbody');
            tbody.innerHTML = '';
            
            if (data.results && data.results.length > 0) {
                document.getElementById('fuzzy-review-container').style.display = 'block';
                
                // 存储匹配结果数据，供按钮点击时使用
                window.fuzzyMatchResults = data.results;
                
                data.results.forEach((row, idx) => {
                    // 字段得分与权重展示
                    let scoreHtml = '';
                    let weightHtml = '';
                    if(row.field_similarities){
                        for(const k in row.field_similarities){
                            if(k==='__meta__') continue;
                            const fs = row.field_similarities[k];
                            scoreHtml += `<div>${k}: ${(fs.similarity*100).toFixed(1)}%</div>`;
                            weightHtml += `<div>${k}: ${(fs.weight*100).toFixed(1)}%</div>`;
                        }
                    }
                    
                    // 动态阈值
                    let threshold = row.field_similarities && row.field_similarities.__meta__ ? row.field_similarities.__meta__.dynamic_threshold : '-';
                    
                    // 操作按钮
                    let opHtml = `
                        <button class='btn btn-success btn-sm me-2' onclick='confirmMatch(${idx})' title='确认关联'>
                            <i class='fas fa-check'></i>
                        </button> 
                        <button class='btn btn-danger btn-sm' onclick='rejectMatch(${idx})' title='拒绝关联'>
                            <i class='fas fa-times'></i>
                        </button>
                        <button class='btn btn-info btn-sm' onclick='showDetails("${row.match_id}")' title='查看分析'>
                            <i class='fas fa-info-circle'></i>
                        </button>`;
                    
                    // 仅名称一致高分提示
                    if(row.field_similarities && row.field_similarities.__meta__ && row.field_similarities.__meta__.available_fields && row.field_similarities.__meta__.available_fields.length===1 && row.field_similarities.__meta__.available_fields[0]==='unit_name'){
                        opHtml += `<div style='color:#e67e22;font-weight:bold;margin-top:5px;'>⚠️ 仅名称一致，建议人工核查</div>`;
                    }
                    
                    tbody.innerHTML += `
                        <tr id='review-row-${idx}'>
                            <td>${row.primary_unit_name||'-'}</td>
                            <td>${row.matched_unit_name||'-'}</td>
                            <td>${scoreHtml}</td>
                            <td>${weightHtml}</td>
                            <td>${threshold}</td>
                            <td><span class='badge bg-primary'>${(row.similarity_score*100).toFixed(1)}%</span></td>
                            <td>${opHtml}</td>
                        </tr>`;
                });
            } else {
                document.getElementById('fuzzy-review-container').style.display = 'none';
            }
        } catch (error) {
            console.error('加载模糊匹配审核结果失败:', error);
            showAlert('error', '加载审核结果失败: ' + error.message);
        }
    }

    // 新增：显示详情模态框
    async function showDetails(matchId) {
        const modalElement = document.getElementById('details-modal');
        const detailsModal = new bootstrap.Modal(modalElement);
        
        const unitInfo = document.getElementById('modal-unit-info');
        const positiveList = document.getElementById('positive-evidence');
        const negativeList = document.getElementById('negative-evidence');

        // 重置内容
        unitInfo.innerHTML = '<p class="text-center text-muted">加载中...</p>';
        positiveList.innerHTML = '';
        negativeList.innerHTML = '';
        
        detailsModal.show();

        try {
            const response = await fetch(`/api/match_result_details/${matchId}`);
            const result = await response.json();

            if (result.success) {
                const details = result.details;
                unitInfo.innerHTML = `
                    <p><strong>源单位:</strong> ${details.unit_name}</p>
                    <p><strong>目标单位:</strong> ${details.matched_unit_name}</p>
                    <p><strong>最终得分:</strong> <span class="badge bg-primary fs-6">${(details.similarity_score * 100).toFixed(1)}%</span></p>
                    <hr>`;

                const explanation = details.match_details.explanation || {};
                const positive = explanation.positive || ['无明确加分项'];
                const negative = explanation.negative || ['无明确减分项'];

                positive.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.innerHTML = `<i class="fas fa-check-circle text-success me-2"></i>${item}`;
                    positiveList.appendChild(li);
                });

                negative.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.innerHTML = `<i class="fas fa-exclamation-triangle text-danger me-2"></i>${item}`;
                    negativeList.appendChild(li);
                });

            } else {
                unitInfo.innerHTML = `<div class="alert alert-danger">加载详情失败: ${result.message}</div>`;
            }
        } catch (error) {
            unitInfo.innerHTML = `<div class="alert alert-danger">请求失败: ${error.message}</div>`;
        }
    }

    // 点击模态框外部关闭
    window.onclick = function(event) {
        const modal = document.getElementById('details-modal');
        if (event.target == modal) {
            closeModal();
        }
    }

    // 确认关联
    async function confirmMatch(idx) {
        if (!window.fuzzyMatchResults || !window.fuzzyMatchResults[idx]) {
            showAlert('error', '无效的匹配记录索引');
            return;
        }
        
        const matchResult = window.fuzzyMatchResults[idx];
        const matchId = matchResult.match_id;
        
        if (!matchId) {
            showAlert('error', '缺少匹配记录ID');
            return;
        }
        
        try {
            // 显示确认对话框
            const confirmed = confirm(`确定要确认关联以下记录吗？\n\n源单位：${matchResult.primary_unit_name}\n目标单位：${matchResult.matched_unit_name}\n相似度：${(matchResult.similarity_score*100).toFixed(1)}%`);
            
            if (!confirmed) {
                return;
            }
            
            // 禁用按钮，防止重复点击
            const row = document.getElementById(`review-row-${idx}`);
            const buttons = row.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);
            
            // 调用后端API确认关联
            const response = await fetch('/api/confirm_association', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    match_id: matchId
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // 更新行状态
                row.style.backgroundColor = '#d4edda';
                row.innerHTML = row.innerHTML.replace(
                    /<td>.*?<\/td>$/,
                    '<td><span class="badge bg-success">已确认关联</span></td>'
                );
                
                showAlert('success', '关联确认成功');
                
                // 3秒后移除该行
                setTimeout(() => {
                    row.style.transition = 'opacity 0.5s';
                    row.style.opacity = '0';
                    setTimeout(() => row.remove(), 500);
                }, 3000);
                
            } else {
                // 重新启用按钮
                buttons.forEach(btn => btn.disabled = false);
                showAlert('error', '确认关联失败: ' + (result.error || result.message));
            }
            
        } catch (error) {
            console.error('确认关联失败:', error);
            showAlert('error', '确认关联失败: ' + error.message);
            
            // 重新启用按钮
            const row = document.getElementById(`review-row-${idx}`);
            const buttons = row.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = false);
        }
    }
    
    // 拒绝关联
    async function rejectMatch(idx) {
        if (!window.fuzzyMatchResults || !window.fuzzyMatchResults[idx]) {
            showAlert('error', '无效的匹配记录索引');
            return;
        }
        
        const matchResult = window.fuzzyMatchResults[idx];
        const matchId = matchResult.match_id;
        
        if (!matchId) {
            showAlert('error', '缺少匹配记录ID');
            return;
        }
        
        try {
            // 显示确认对话框
            const reason = prompt(`确定要拒绝关联以下记录吗？\n\n源单位：${matchResult.primary_unit_name}\n目标单位：${matchResult.matched_unit_name}\n相似度：${(matchResult.similarity_score*100).toFixed(1)}%\n\n请输入拒绝原因（可选）:`);
            
            if (reason === null) {
                return; // 用户取消
            }
            
            // 禁用按钮，防止重复点击
            const row = document.getElementById(`review-row-${idx}`);
            const buttons = row.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);
            
            // 调用后端API拒绝关联
            const response = await fetch('/api/reject_association', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    match_id: matchId,
                    reason: reason || '人工审核拒绝关联'
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // 更新行状态
                row.style.backgroundColor = '#f8d7da';
                row.innerHTML = row.innerHTML.replace(
                    /<td>.*?<\/td>$/,
                    '<td><span class="badge bg-danger">已拒绝关联</span></td>'
                );
                
                showAlert('success', '关联拒绝成功');
                
                // 3秒后移除该行
                setTimeout(() => {
                    row.style.transition = 'opacity 0.5s';
                    row.style.opacity = '0';
                    setTimeout(() => row.remove(), 500);
                }, 3000);
                
            } else {
                // 重新启用按钮
                buttons.forEach(btn => btn.disabled = false);
                showAlert('error', '拒绝关联失败: ' + (result.error || result.message));
            }
            
        } catch (error) {
            console.error('拒绝关联失败:', error);
            showAlert('error', '拒绝关联失败: ' + error.message);
            
            // 重新启用按钮
            const row = document.getElementById(`review-row-${idx}`);
            const buttons = row.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = false);
        }
    }

    // 页面加载后自动拉取
    document.addEventListener('DOMContentLoaded', loadFuzzyReviewResults);

    // 页面加载完成后的初始化
    document.addEventListener('DOMContentLoaded', function() {
        console.log('匹配管理页面加载完成');
    });

    // 清除匹配结果
    async function clearMatchResults() {
        if (!confirm('确定要清除所有匹配结果吗？此操作不可恢复！')) {
            return;
        }
        
        try {
            const resp = await fetch('/api/clear_match_results', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const result = await resp.json();
            
            if (result.success) {
                alert(`成功清除 ${result.deleted_count} 条匹配结果记录`);
                // 刷新统计信息
                if (typeof loadStatistics === 'function') loadStatistics();
            } else {
                alert('清除失败: ' + (result.message || result.error));
            }
        } catch (e) {
            console.error('清除匹配结果失败:', e);
            alert('清除匹配结果失败: ' + e.message);
        }
    }
</script>
{% endblock %} 