<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ¹é…ç»“æœ - æ¶ˆé˜²å•ä½å»ºç­‘æ•°æ®å…³è”ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 16px;
        }

        .controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .form-control {
            padding: 10px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .results-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 13px;
            min-width: 1400px;
        }

        .results-table th,
        .results-table td {
            padding: 12px 8px;
            text-align: left;
            border: 1px solid #ecf0f1;
            vertical-align: top;
        }

        .results-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .match-type {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
        }

        .match-exact {
            background: #27ae60;
            color: white;
        }

        .match-fuzzy {
            background: #3498db;
            color: white;
        }

        .match-none {
            background: #95a5a6;
            color: white;
        }

        .dual-content {
            line-height: 1.4;
        }

        .source-data {
            color: #2c3e50;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .target-data {
            color: #7f8c8d;
            font-size: 12px;
        }

        .data-label {
            font-size: 10px;
            color: #95a5a6;
            font-weight: normal;
        }

        .confidence-score {
            font-weight: bold;
            padding: 3px 6px;
            border-radius: 8px;
            font-size: 12px;
        }

        .confidence-high { background: #d4edda; color: #155724; }
        .confidence-medium { background: #fff3cd; color: #856404; }
        .confidence-low { background: #f8d7da; color: #721c24; }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            gap: 10px;
        }

        .pagination button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 5px;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
        }

        .no-data {
            color: #bdc3c7;
            font-style: italic;
        }

        .table-wrapper {
            max-height: 600px;
            overflow-y: auto;
        }

        /* å®¡æ ¸çŠ¶æ€ç¼–è¾‘æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 400px;
            border-radius: 8px;
        }

        .modal-header {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-body {
            margin-bottom: 15px;
        }

        .modal-body div {
            margin-bottom: 15px;
        }

        .modal-body label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .modal-body select,
        .modal-body textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .modal-footer {
            border-top: 1px solid #eee;
            padding-top: 15px;
            text-align: right;
        }

        .modal-footer button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            margin-right: 10px;
            cursor: pointer;
        }

        /* å®¡æ ¸ç¡®è®¤å¯¹è¯æ¡† */
        .confirm-dialog {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }

        .confirm-content {
            background-color: #fefefe;
            margin: 20% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 350px;
            border-radius: 8px;
            text-align: center;
        }

        .confirm-content h4 {
            margin-top: 0;
            color: #333;
        }

        .confirm-content p {
            margin: 20px 0;
            color: #666;
        }

        .confirm-content button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            margin-right: 10px;
            cursor: pointer;
        }

        .confirm-content button:last-child {
            background: #28a745;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="header">
            <h1>ğŸ“Š åŒ¹é…ç»“æœ</h1>
            <p>æ¶ˆé˜²å•ä½å»ºç­‘æ•°æ®å…³è”åŒ¹é…ç»“æœæŸ¥çœ‹ä¸ç®¡ç†</p>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls">
            <label>åŒ¹é…ç±»å‹:</label>
            <select id="match-type-filter" class="form-control">
                <option value="">å…¨éƒ¨</option>
                <option value="exact">ç²¾ç¡®åŒ¹é…</option>
                <option value="fuzzy">æ¨¡ç³ŠåŒ¹é…</option>
                <option value="none">æœªåŒ¹é…</option>
            </select>

            <label>æ¯é¡µæ˜¾ç¤º:</label>
            <select id="per-page" class="form-control">
                <option value="20">20æ¡</option>
                <option value="50">50æ¡</option>
                <option value="100">100æ¡</option>
            </select>

            <button class="btn btn-primary" onclick="loadResults()">ğŸ” æŸ¥è¯¢</button>
            <button class="btn btn-secondary" onclick="exportResults()">ğŸ“¥ å¯¼å‡º</button>
            <button class="btn btn-secondary" onclick="location.href='/'">ğŸ  è¿”å›é¦–é¡µ</button>
        </div>

        <!-- ç»“æœå®¹å™¨ -->
        <div class="results-container">
            <div id="loading" class="loading">
                æ­£åœ¨åŠ è½½åŒ¹é…ç»“æœ...
            </div>

            <div id="results-content" style="display: none;">
                <div id="results-summary"></div>
                
                <div class="table-wrapper">
                    <table id="results-table" class="results-table">
                        <thead>
                            <tr>
                                <th style="width: 150px;">æºå•ä½åç§°</th>
                                <th style="width: 150px;">ç›®æ ‡å•ä½åç§°</th>
                                <th style="width: 100px;">åŒ¹é…ç±»å‹</th>
                                <th style="width: 80px;">åŒ¹é…åº¦</th>
                                <th style="width: 200px;">å•ä½åœ°å€</th>
                                <th style="width: 120px;">æ³•å®šä»£è¡¨äºº</th>
                                <th style="width: 120px;">æ¶ˆé˜²å®‰å…¨ç®¡ç†äºº</th>
                                <th style="width: 120px;">åŒ¹é…æ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody">
                        </tbody>
                    </table>
                </div>

                <div id="pagination" class="pagination">
                </div>
            </div>
        </div>

        <!-- å®¡æ ¸çŠ¶æ€ç¼–è¾‘æ¨¡æ€æ¡† -->
        <div id="reviewModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4);">
            <div class="modal-content" style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 400px; border-radius: 8px;">
                <div class="modal-header" style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #333;">äººå·¥å®¡æ ¸</h3>
                    <span class="close" onclick="closeReviewModal()" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">å®¡æ ¸ç»“æœ:</label>
                        <select id="reviewStatusSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">è¯·é€‰æ‹©å®¡æ ¸ç»“æœ</option>
                            <option value="approved">âœ… å®¡æ ¸é€šè¿‡</option>
                            <option value="rejected">âŒ å®¡æ ¸æœªé€šè¿‡</option>
                            <option value="pending">â³ å¾…å®¡æ ¸</option>
                        </select>
                    </div>
                    <div id="reviewNotesDiv" style="margin-bottom: 15px; display: none;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">å®¡æ ¸å¤‡æ³¨:</label>
                        <textarea id="reviewNotesInput" placeholder="è¯·è¾“å…¥å®¡æ ¸å¤‡æ³¨æˆ–æœªé€šè¿‡åŸå› ..." style="width: 100%; height: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">å•ä½ä¿¡æ¯:</label>
                        <div id="reviewUnitInfo" style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 14px;"></div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #eee; padding-top: 15px; text-align: right;">
                    <button onclick="closeReviewModal()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px; cursor: pointer;">å–æ¶ˆ</button>
                    <button onclick="confirmReview()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">ç¡®è®¤</button>
                </div>
            </div>
        </div>

        <!-- å®¡æ ¸ç¡®è®¤å¯¹è¯æ¡† -->
        <div id="confirmDialog" class="modal" style="display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4);">
            <div class="modal-content" style="background-color: #fefefe; margin: 20% auto; padding: 20px; border: 1px solid #888; width: 350px; border-radius: 8px; text-align: center;">
                <h4 style="margin-top: 0; color: #333;">ç¡®è®¤å®¡æ ¸æ“ä½œ</h4>
                <p id="confirmMessage" style="margin: 20px 0; color: #666;"></p>
                <div style="margin-top: 20px;">
                    <button onclick="closeConfirmDialog()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px; cursor: pointer;">å–æ¶ˆ</button>
                    <button onclick="executeReview()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">ç¡®è®¤</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½ç»“æœ
        document.addEventListener('DOMContentLoaded', function() {
            loadResults();
        });

        // åŠ è½½åŒ¹é…ç»“æœ
        async function loadResults() {
            const matchType = document.getElementById('match-type-filter').value;
            const perPage = document.getElementById('per-page').value;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('results-content').style.display = 'none';

            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    per_page: perPage
                });

                if (matchType) {
                    params.append('match_type', matchType);
                }

                const response = await fetch(`/api/match_results?${params}`);
                const data = await response.json();

                if (response.ok) {
                    displayResults(data);
                } else {
                    showError('åŠ è½½ç»“æœå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                showError('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        // å®‰å…¨è·å–å­—æ®µå€¼ï¼Œé¿å…æ˜¾ç¤º"-"
        function safeGetValue(value, defaultText = 'æš‚æ— æ•°æ®') {
            if (value === null || value === undefined || value === '' || value === '-') {
                return `<span class="no-data">${defaultText}</span>`;
            }
            return value;
        }

        // å®‰å…¨è·å–çº¯æ–‡æœ¬å€¼ï¼Œç”¨äºJavaScriptå‚æ•°ä¼ é€’
        function safeGetText(value, defaultText = 'æš‚æ— æ•°æ®') {
            if (value === null || value === undefined || value === '' || value === '-') {
                return defaultText;
            }
            return String(value).replace(/'/g, "\\'").replace(/"/g, '\\"');
        }

        // æ ¼å¼åŒ–åŒè¡Œæ˜¾ç¤ºå†…å®¹
        function formatDualContent(sourceValue, targetValue, sourceLabel = 'æº', targetLabel = 'ç›®æ ‡') {
            const source = sourceValue && sourceValue !== '-' ? sourceValue : 'æš‚æ— æ•°æ®';
            const target = targetValue && targetValue !== '-' ? targetValue : 'æš‚æ— æ•°æ®';
            
            return `
                <div class="dual-content">
                    <div class="source-data">
                        <span class="data-label">${sourceLabel}:</span> ${source}
                    </div>
                    <div class="target-data">
                        <span class="data-label">${targetLabel}:</span> ${target}
                    </div>
                </div>
            `;
        }

        // è·å–ç½®ä¿¡åº¦æ ·å¼
        function getConfidenceClass(score) {
            if (score >= 0.8) return 'confidence-high';
            if (score >= 0.6) return 'confidence-medium';
            return 'confidence-low';
        }

        // æ ¼å¼åŒ–åŒ¹é…æ—¶é—´
        function formatMatchTime(matchTime, updatedTime, createdTime) {
            // ä¼˜å…ˆä½¿ç”¨match_timeï¼Œç„¶åæ˜¯updated_timeï¼Œæœ€åæ˜¯created_time
            const timeValue = matchTime || updatedTime || createdTime;
            
            if (!timeValue) {
                return safeGetValue(null, 'æœªè®°å½•');
            }
            
            try {
                const date = new Date(timeValue);
                if (isNaN(date.getTime())) {
                    return safeGetValue(null, 'æ—¶é—´æ ¼å¼é”™è¯¯');
                }
                
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            } catch (error) {
                console.error('æ—¶é—´æ ¼å¼åŒ–é”™è¯¯:', error);
                return safeGetValue(null, 'æ—¶é—´è§£æå¤±è´¥');
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results-content').style.display = 'block';

            // æ˜¾ç¤ºæ‘˜è¦
            const summary = document.getElementById('results-summary');
            summary.innerHTML = `
                <p><strong>æ€»è®¡:</strong> ${data.total || 0} æ¡ç»“æœ | 
                <strong>å½“å‰é¡µ:</strong> ${data.page || 1}/${data.pages || 1}</p>
            `;

            // æ˜¾ç¤ºè¡¨æ ¼æ•°æ®
            const tbody = document.getElementById('results-tbody');
            tbody.innerHTML = '';

            if (data.results && data.results.length > 0) {
                data.results.forEach(result => {
                    const row = document.createElement('tr');
                    
                    // è®¡ç®—åŒ¹é…åº¦æ˜¾ç¤º - ä¼˜å…ˆæ˜¾ç¤ºäººå·¥å®¡æ ¸çŠ¶æ€ï¼Œä½†å¯¹äºé«˜ç›¸ä¼¼åº¦ä¼˜å…ˆæ˜¾ç¤ºåˆ†æ•°
                    const reviewStatus = result.review_status;
                    const similarityScore = result.similarity_score || 0;
                    const matchType = result.match_type || '';
                    const confidenceClass = getConfidenceClass(similarityScore);
                    const matchId = result._id || result.match_id;
                    
                    let similarityDisplay;
                    let isEditable = false;  // æ˜¯å¦å¯ç¼–è¾‘
                    
                    // å¯¹äºå·²å®¡æ ¸çš„è®°å½•ï¼Œä¼˜å…ˆæ˜¾ç¤ºå®¡æ ¸çŠ¶æ€ï¼Œä½†ä»ç„¶æ”¯æŒä¿®æ”¹
                    if (reviewStatus === 'approved') {
                        similarityDisplay = `<span class="confidence-score confidence-high">âœ… äººå·¥å®¡æ ¸é€šè¿‡</span>`;
                        isEditable = true;  // å·²å®¡æ ¸é€šè¿‡çš„è®°å½•ä¹Ÿå¯ä»¥ä¿®æ”¹
                    } else if (reviewStatus === 'rejected') {
                        const reviewNotes = result.review_notes || '';
                        const notesText = reviewNotes ? ` (${reviewNotes})` : '';
                        similarityDisplay = `<span class="confidence-score confidence-low">âŒ äººå·¥å®¡æ ¸æœªé€šè¿‡${notesText}</span>`;
                        isEditable = true;  // å·²å®¡æ ¸æœªé€šè¿‡çš„è®°å½•ä¹Ÿå¯ä»¥ä¿®æ”¹
                    } 
                    // ç‰¹æ®Šå¤„ç†æ¨¡ç³ŠåŒ¹é…(å®Œç¾)ç±»å‹ - æ— è®ºç›¸ä¼¼åº¦åˆ†æ•°å¦‚ä½•éƒ½æ˜¾ç¤º100%
                    else if (matchType === 'fuzzy_perfect') {
                        similarityDisplay = `<span class="confidence-score confidence-high">100.0%</span>`;
                        // å¦‚æœæ˜¯å¾…å®¡æ ¸çŠ¶æ€ï¼Œä»ç„¶å¯ä»¥è¿›è¡Œäººå·¥å®¡æ ¸
                        if (reviewStatus === 'pending') {
                            isEditable = true;
                        }
                    }
                    // å¯¹äºæœ‰ç›¸ä¼¼åº¦åˆ†æ•°çš„è®°å½•ï¼Œæ˜¾ç¤ºåˆ†æ•°
                    else if (similarityScore > 0) {
                        // é«˜ç›¸ä¼¼åº¦è®°å½•æ˜¾ç¤º100%
                        if (similarityScore >= 0.99) {
                            similarityDisplay = `<span class="confidence-score confidence-high">100.0%</span>`;
                        } else {
                            similarityDisplay = `<span class="confidence-score ${confidenceClass}">${(similarityScore * 100).toFixed(1)}%</span>`;
                        }
                        
                        // å¦‚æœæ˜¯å¾…å®¡æ ¸çš„æ¨¡ç³ŠåŒ¹é…ï¼Œåœ¨åˆ†æ•°åæ·»åŠ å¾…å®¡æ ¸æ ‡è¯†å’Œç¼–è¾‘æŒ‰é’®
                        if (reviewStatus === 'pending' && (matchType.includes('fuzzy') || matchType === 'fuzzy')) {
                            similarityDisplay += ` <small style="color: #f39c12;">(å¾…å®¡æ ¸)</small>`;
                            isEditable = true;
                        }
                    }
                    // å¯¹äºç²¾ç¡®åŒ¹é…ä½†æ²¡æœ‰ç›¸ä¼¼åº¦åˆ†æ•°çš„è®°å½•
                    else if (matchType && (matchType.includes('exact') || matchType === 'exact')) {
                        similarityDisplay = `<span class="confidence-score confidence-high">ç²¾ç¡®åŒ¹é…</span>`;
                    }
                    // å¯¹äºå¾…å®¡æ ¸çš„æ¨¡ç³ŠåŒ¹é…ä½†æ²¡æœ‰åˆ†æ•°çš„è®°å½•
                    else if (reviewStatus === 'pending' && (matchType.includes('fuzzy') || matchType === 'fuzzy')) {
                        similarityDisplay = `<span class="confidence-score confidence-medium">â³ å¾…äººå·¥å®¡æ ¸</span>`;
                        isEditable = true;
                    }
                    // å…¶ä»–æƒ…å†µ
                    else {
                        similarityDisplay = safeGetValue(null, 'æœªè¯„åˆ†');
                    }

                    // å¦‚æœå¯ç¼–è¾‘ï¼Œæ·»åŠ ç¼–è¾‘æŒ‰é’®
                    if (isEditable && matchId) {
                        const primaryName = safeGetText(result.primary_unit_name || result.source_unit_name);
                        const matchedName = safeGetText(result.matched_unit_name || result.target_unit_name);
                        const currentStatus = reviewStatus || 'pending';
                        
                        // æ ¹æ®å½“å‰çŠ¶æ€è®¾ç½®æŒ‰é’®æ–‡æœ¬å’Œæ ·å¼
                        let buttonText = 'å®¡æ ¸';
                        let buttonStyle = 'background: #007bff; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 12px; cursor: pointer; margin-left: 5px;';
                        let buttonTitle = 'ç‚¹å‡»è¿›è¡Œäººå·¥å®¡æ ¸';
                        
                        if (reviewStatus === 'approved') {
                            buttonText = 'ä¿®æ”¹';
                            buttonStyle = 'background: #28a745; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 12px; cursor: pointer; margin-left: 5px;';
                            buttonTitle = 'ç‚¹å‡»ä¿®æ”¹å®¡æ ¸çŠ¶æ€';
                        } else if (reviewStatus === 'rejected') {
                            buttonText = 'ä¿®æ”¹';
                            buttonStyle = 'background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 12px; cursor: pointer; margin-left: 5px;';
                            buttonTitle = 'ç‚¹å‡»ä¿®æ”¹å®¡æ ¸çŠ¶æ€';
                        }
                        
                        similarityDisplay += ` <button onclick="openReviewModal('${matchId}', '${primaryName}', '${matchedName}', '${currentStatus}')" 
                            style="${buttonStyle}" 
                            title="${buttonTitle}">${buttonText}</button>`;
                    }

                    row.innerHTML = `
                        <td>${safeGetValue(result.primary_unit_name || result.source_unit_name)}</td>
                        <td>${safeGetValue(result.matched_unit_name || result.target_unit_name)}</td>
                        <td><span class="match-type match-${result.match_type || 'none'}">${getMatchTypeText(result.match_type)}</span></td>
                        <td>${similarityDisplay}</td>
                        <td>${formatDualContent(
                            result.primary_unit_address || result.source_address,
                            result.matched_unit_address || result.target_address,
                            'æºåœ°å€', 'ç›®æ ‡åœ°å€'
                        )}</td>
                        <td>${formatDualContent(
                            result.primary_legal_person || result.source_legal_person,
                            result.matched_legal_person || result.target_legal_person,
                            'æºæ³•äºº', 'ç›®æ ‡æ³•äºº'
                        )}</td>
                        <td>${formatDualContent(
                            result.primary_security_manager || result.source_security_manager,
                            result.matched_security_manager || result.target_security_manager,
                            'æºç®¡ç†äºº', 'ç›®æ ‡ç®¡ç†äºº'
                        )}</td>
                        <td>${formatMatchTime(result.match_time, result.updated_time, result.created_time)}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #7f8c8d; padding: 40px;">æš‚æ— åŒ¹é…ç»“æœ</td></tr>';
            }

            // æ›´æ–°åˆ†é¡µ
            updatePagination(data.page || 1, data.pages || 1);
        }

        // è·å–åŒ¹é…ç±»å‹æ–‡æœ¬
        function getMatchTypeText(type) {
            const typeMap = {
                'exact': 'ç²¾ç¡®åŒ¹é…',
                'exact_credit_code': 'ç²¾ç¡®åŒ¹é…(ä¿¡ç”¨ä»£ç )',
                'exact_unit_name': 'ç²¾ç¡®åŒ¹é…(å•ä½åç§°)',
                'fuzzy': 'æ¨¡ç³ŠåŒ¹é…',
                'fuzzy_credit_code': 'æ¨¡ç³ŠåŒ¹é…(ä¿¡ç”¨ä»£ç )',
                'fuzzy_unit_name': 'æ¨¡ç³ŠåŒ¹é…(å•ä½åç§°)',
                'fuzzy_legal_person': 'æ¨¡ç³ŠåŒ¹é…(æ³•å®šä»£è¡¨äºº)',
                'fuzzy_address': 'æ¨¡ç³ŠåŒ¹é…(åœ°å€)',
                'fuzzy_comprehensive': 'æ¨¡ç³ŠåŒ¹é…(ç»¼åˆ)',
                'fuzzy_perfect': 'æ¨¡ç³ŠåŒ¹é…(å®Œç¾)',
                'fuzzy_high': 'æ¨¡ç³ŠåŒ¹é…(é«˜)',
                'fuzzy_medium': 'æ¨¡ç³ŠåŒ¹é…(ä¸­)',
                'fuzzy_low': 'æ¨¡ç³ŠåŒ¹é…(ä½)',
                'none': 'æœªåŒ¹é…',
                'manual': 'äººå·¥åŒ¹é…'
            };
            return typeMap[type] || (type || 'æœªçŸ¥ç±»å‹');
        }

        // æ›´æ–°åˆ†é¡µ
        function updatePagination(page, pages) {
            currentPage = page;
            totalPages = pages;

            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (pages <= 1) return;

            // ä¸Šä¸€é¡µ
            if (page > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.textContent = 'ä¸Šä¸€é¡µ';
                prevBtn.onclick = () => {
                    currentPage = page - 1;
                    loadResults();
                };
                pagination.appendChild(prevBtn);
            }

            // é¡µç 
            const startPage = Math.max(1, page - 2);
            const endPage = Math.min(pages, page + 2);

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = i === page ? 'active' : '';
                pageBtn.onclick = () => {
                    currentPage = i;
                    loadResults();
                };
                pagination.appendChild(pageBtn);
            }

            // ä¸‹ä¸€é¡µ
            if (page < pages) {
                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'ä¸‹ä¸€é¡µ';
                nextBtn.onclick = () => {
                    currentPage = page + 1;
                    loadResults();
                };
                pagination.appendChild(nextBtn);
            }
        }

        // å¯¼å‡ºç»“æœ
        async function exportResults() {
            const matchType = document.getElementById('match-type-filter').value;

            try {
                const params = new URLSearchParams({
                    format: 'csv'
                });

                if (matchType) {
                    params.append('match_type', matchType);
                }

                const response = await fetch(`/api/export_results?${params}`);
                const data = await response.json();

                if (data.success) {
                    alert('å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶è·¯å¾„: ' + data.file_path);
                } else {
                    alert('å¯¼å‡ºå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results-content').innerHTML = `
                <div style="text-align: center; padding: 50px; color: #e74c3c;">
                    <h3>åŠ è½½å¤±è´¥</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="loadResults()">é‡è¯•</button>
                </div>
            `;
            document.getElementById('results-content').style.display = 'block';
        }

        // å…¨å±€å˜é‡å­˜å‚¨å½“å‰å®¡æ ¸ä¿¡æ¯
        let currentReviewData = {};

        // æ‰“å¼€å®¡æ ¸æ¨¡æ€æ¡†
        function openReviewModal(matchId, primaryUnitName, matchedUnitName, currentStatus) {
            currentReviewData = {
                matchId: matchId,
                primaryUnitName: primaryUnitName,
                matchedUnitName: matchedUnitName,
                currentStatus: currentStatus
            };

            // è®¾ç½®å•ä½ä¿¡æ¯
            document.getElementById('reviewUnitInfo').innerHTML = `
                <div><strong>æºå•ä½:</strong> ${primaryUnitName}</div>
                <div><strong>åŒ¹é…å•ä½:</strong> ${matchedUnitName}</div>
            `;

            // è®¾ç½®å½“å‰çŠ¶æ€
            document.getElementById('reviewStatusSelect').value = currentStatus || 'pending';
            
            // æ ¹æ®å½“å‰çŠ¶æ€æ˜¾ç¤º/éšè—å¤‡æ³¨æ¡†
            toggleReviewNotes();
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('reviewModal').style.display = 'block';
        }

        // å…³é—­å®¡æ ¸æ¨¡æ€æ¡†
        function closeReviewModal() {
            document.getElementById('reviewModal').style.display = 'none';
            document.getElementById('reviewNotesInput').value = '';
            currentReviewData = {};
        }

        // å®¡æ ¸çŠ¶æ€å˜åŒ–æ—¶çš„å¤„ç†
        document.addEventListener('DOMContentLoaded', function() {
            const reviewStatusSelect = document.getElementById('reviewStatusSelect');
            if (reviewStatusSelect) {
                reviewStatusSelect.addEventListener('change', toggleReviewNotes);
            }
        });

        // åˆ‡æ¢å¤‡æ³¨æ¡†æ˜¾ç¤º
        function toggleReviewNotes() {
            const status = document.getElementById('reviewStatusSelect').value;
            const notesDiv = document.getElementById('reviewNotesDiv');
            
            if (status === 'rejected') {
                notesDiv.style.display = 'block';
                document.getElementById('reviewNotesInput').setAttribute('required', 'required');
                document.getElementById('reviewNotesInput').placeholder = 'è¯·è¾“å…¥å®¡æ ¸æœªé€šè¿‡çš„åŸå› ...';
            } else if (status === 'approved') {
                notesDiv.style.display = 'block';
                document.getElementById('reviewNotesInput').removeAttribute('required');
                document.getElementById('reviewNotesInput').placeholder = 'å¯é€‰ï¼šè¾“å…¥å®¡æ ¸å¤‡æ³¨...';
            } else {
                notesDiv.style.display = 'none';
                document.getElementById('reviewNotesInput').removeAttribute('required');
            }
        }

        // ç¡®è®¤å®¡æ ¸
        function confirmReview() {
            const status = document.getElementById('reviewStatusSelect').value;
            const notes = document.getElementById('reviewNotesInput').value.trim();
            
            if (!status) {
                alert('è¯·é€‰æ‹©å®¡æ ¸ç»“æœ');
                return;
            }
            
            if (status === 'rejected' && !notes) {
                alert('å®¡æ ¸æœªé€šè¿‡æ—¶å¿…é¡»å¡«å†™åŸå› ');
                return;
            }

            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            const statusText = {
                'approved': 'âœ… å®¡æ ¸é€šè¿‡',
                'rejected': 'âŒ å®¡æ ¸æœªé€šè¿‡',
                'pending': 'â³ å¾…å®¡æ ¸'
            };
            
            let message = `ç¡®è®¤å°† "${currentReviewData.primaryUnitName}" çš„å®¡æ ¸çŠ¶æ€è®¾ç½®ä¸º "${statusText[status]}"ï¼Ÿ`;
            if (notes) {
                message += `\nå¤‡æ³¨: ${notes}`;
            }
            
            document.getElementById('confirmMessage').innerHTML = message.replace(/\n/g, '<br>');
            document.getElementById('confirmDialog').style.display = 'block';
        }

        // å…³é—­ç¡®è®¤å¯¹è¯æ¡†
        function closeConfirmDialog() {
            document.getElementById('confirmDialog').style.display = 'none';
        }

        // æ‰§è¡Œå®¡æ ¸æ“ä½œ
        async function executeReview() {
            const status = document.getElementById('reviewStatusSelect').value;
            const notes = document.getElementById('reviewNotesInput').value.trim();
            
            try {
                // å…³é—­ç¡®è®¤å¯¹è¯æ¡†
                closeConfirmDialog();
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const loadingMessage = document.createElement('div');
                loadingMessage.innerHTML = '<div style="text-align: center; padding: 20px;">æ­£åœ¨ä¿å­˜å®¡æ ¸ç»“æœ...</div>';
                loadingMessage.style.position = 'fixed';
                loadingMessage.style.top = '50%';
                loadingMessage.style.left = '50%';
                loadingMessage.style.transform = 'translate(-50%, -50%)';
                loadingMessage.style.background = 'white';
                loadingMessage.style.border = '1px solid #ddd';
                loadingMessage.style.borderRadius = '8px';
                loadingMessage.style.zIndex = '1002';
                loadingMessage.id = 'loadingMessage';
                document.body.appendChild(loadingMessage);

                const response = await fetch('/api/update_review_status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        match_id: currentReviewData.matchId,
                        review_status: status,
                        review_notes: notes,
                        reviewer: 'web_user'
                    })
                });

                const result = await response.json();
                
                // ç§»é™¤åŠ è½½æ¶ˆæ¯
                const loadingEl = document.getElementById('loadingMessage');
                if (loadingEl) {
                    loadingEl.remove();
                }

                if (result.success) {
                    // å…³é—­æ¨¡æ€æ¡†
                    closeReviewModal();
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    alert('å®¡æ ¸çŠ¶æ€æ›´æ–°æˆåŠŸï¼');
                    
                    // é‡æ–°åŠ è½½ç»“æœ
                    loadResults();
                } else {
                    alert('å®¡æ ¸çŠ¶æ€æ›´æ–°å¤±è´¥: ' + (result.error || result.message));
                }
            } catch (error) {
                // ç§»é™¤åŠ è½½æ¶ˆæ¯
                const loadingEl = document.getElementById('loadingMessage');
                if (loadingEl) {
                    loadingEl.remove();
                }
                
                closeConfirmDialog();
                alert('å®¡æ ¸æ“ä½œå¤±è´¥: ' + error.message);
                console.error('å®¡æ ¸æ“ä½œå¤±è´¥:', error);
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const reviewModal = document.getElementById('reviewModal');
            const confirmDialog = document.getElementById('confirmDialog');
            
            if (event.target === reviewModal) {
                closeReviewModal();
            } else if (event.target === confirmDialog) {
                closeConfirmDialog();
            }
        }
    </script>
</body>
</html> 