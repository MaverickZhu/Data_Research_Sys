{% extends "base.html" %}

{% block title %}ç”¨æˆ·æ•°æ®æ™ºèƒ½åŒ¹é… - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="header bg-gradient-primary text-white p-5 rounded-3 mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-4 mb-3"><i class="fas fa-brain"></i> ç”¨æˆ·æ•°æ®æ™ºèƒ½åŒ¹é…</h1>
                <p class="lead">åŸºäºæ‚¨ä¸Šä¼ çš„æ•°æ®å’Œå­—æ®µæ˜ å°„é…ç½®ï¼Œä½¿ç”¨æˆç†Ÿçš„åŒ¹é…ç®—æ³•è¿›è¡Œæ™ºèƒ½æ•°æ®å…³è”</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="feature-badge">
                    <span class="badge bg-light text-primary fs-6">
                        <i class="fas fa-sparkles"></i> æ™ºèƒ½ç®—æ³•é©±åŠ¨
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- é…ç½®ä¿¡æ¯å¡ç‰‡ -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-cog"></i> å­—æ®µæ˜ å°„é…ç½®ä¿¡æ¯</h5>
        </div>
        <div class="card-body">
            <div id="config-loading" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">åŠ è½½é…ç½®ä¸­...</span>
                </div>
                <p class="mt-2">æ­£åœ¨åŠ è½½æ‚¨çš„å­—æ®µæ˜ å°„é…ç½®...</p>
            </div>
            
            <div id="config-content" style="display: none;">
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-item">
                            <label class="fw-bold text-muted">é…ç½®ID:</label>
                            <span id="config-id" class="ms-2">-</span>
                        </div>
                        <div class="info-item">
                            <label class="fw-bold text-muted">æºæ•°æ®è¡¨:</label>
                            <span id="source-table" class="ms-2 badge bg-primary">-</span>
                        </div>
                        <div class="info-item">
                            <label class="fw-bold text-muted">ç›®æ ‡æ•°æ®è¡¨:</label>
                            <div id="target-tables" class="ms-2 mt-1">-</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item">
                            <label class="fw-bold text-muted">åˆ›å»ºæ—¶é—´:</label>
                            <span id="created-at" class="ms-2">-</span>
                        </div>
                        <div class="info-item">
                            <label class="fw-bold text-muted">æ˜ å°„å­—æ®µæ•°:</label>
                            <span id="mapping-count" class="ms-2 badge bg-success">-</span>
                        </div>
                        <div class="info-item">
                            <label class="fw-bold text-muted">æ•°æ®é‡ç»Ÿè®¡:</label>
                            <div id="data-stats" class="ms-2 mt-1">
                                <small class="text-muted">æ­£åœ¨ç»Ÿè®¡...</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ˜ å°„è¯¦æƒ… -->
                <div class="mt-4">
                    <h6><i class="fas fa-list"></i> å­—æ®µæ˜ å°„è¯¦æƒ…</h6>
                    <div class="table-responsive" style="max-height: 300px;">
                        <table class="table table-sm table-striped table-hover">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th width="25%">æºå­—æ®µ</th>
                                    <th width="25%">ç›®æ ‡å­—æ®µ</th>
                                    <th width="20%">ç›®æ ‡è¡¨</th>
                                    <th width="15%">ç›¸ä¼¼åº¦</th>
                                    <th width="15%">æ•°æ®ç±»å‹</th>
                                </tr>
                            </thead>
                            <tbody id="mapping-list">
                                <tr><td colspan="5" class="text-center text-muted">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŒ¹é…ç®—æ³•é€‰æ‹©å’Œå‚æ•°é…ç½® -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-magic"></i> æ™ºèƒ½åŒ¹é…é…ç½®</h5>
        </div>
        <div class="card-body">
            <form id="matching-form">
                <div class="row g-3">
                    <!-- åŒ¹é…ç®—æ³•é€‰æ‹© -->
                    <div class="col-md-3">
                        <label for="algorithm-type" class="form-label">
                            <i class="fas fa-robot"></i> åŒ¹é…ç®—æ³•
                        </label>
                        <select id="algorithm-type" class="form-select">
                            <option value="dual_validation" selected>åŒé‡éªŒè¯åŒ¹é…ç®—æ³• (æ¨è)</option>
                            <option value="optimized">ä¼˜åŒ–åŒ¹é…ç®—æ³•</option>
                            <option value="exact">ç²¾ç¡®åŒ¹é…ç®—æ³•</option>
                            <option value="fuzzy">æ¨¡ç³ŠåŒ¹é…ç®—æ³•</option>
                            <option value="hybrid">æ··åˆåŒ¹é…ç®—æ³•</option>
                        </select>
                        <div class="form-text">é€‰æ‹©æœ€é€‚åˆæ‚¨æ•°æ®çš„åŒ¹é…ç®—æ³•</div>
                    </div>

                    <!-- ç›¸ä¼¼åº¦é˜ˆå€¼ -->
                    <div class="col-md-3">
                        <label for="similarity-threshold" class="form-label">
                            <i class="fas fa-percentage"></i> ç›¸ä¼¼åº¦é˜ˆå€¼
                        </label>
                        <select id="similarity-threshold" class="form-select">
                            <option value="0.6">å®½æ¾ (60%)</option>
                            <option value="0.7" selected>æ ‡å‡† (70%)</option>
                            <option value="0.8">ä¸¥æ ¼ (80%)</option>
                            <option value="0.9">éå¸¸ä¸¥æ ¼ (90%)</option>
                        </select>
                        <div class="form-text">è®¾ç½®åŒ¹é…çš„æœ€ä½ç›¸ä¼¼åº¦è¦æ±‚</div>
                    </div>

                    <!-- æ‰¹å¤„ç†å¤§å° -->
                    <div class="col-md-3">
                        <label for="batch-size" class="form-label">
                            <i class="fas fa-layer-group"></i> æ‰¹å¤„ç†å¤§å°
                        </label>
                        <select id="batch-size" class="form-select">
                            <option value="100">å°æ‰¹é‡ (100æ¡/æ‰¹)</option>
                            <option value="200">æ ‡å‡† (200æ¡/æ‰¹)</option>
                            <option value="500" selected>å¤§æ‰¹é‡ (500æ¡/æ‰¹)</option>
                            <option value="1000">è¶…å¤§æ‰¹é‡ (1000æ¡/æ‰¹)</option>
                        </select>
                        <div class="form-text">æ ¹æ®æ•°æ®é‡å’Œæ€§èƒ½éœ€æ±‚é€‰æ‹©</div>
                    </div>

                    <!-- æœ€å¤§ç»“æœæ•° -->
                    <div class="col-md-3">
                        <label for="max-results" class="form-label">
                            <i class="fas fa-list-ol"></i> æœ€å¤§ç»“æœæ•°
                        </label>
                        <select id="max-results" class="form-select">
                            <option value="5">å‰5ä¸ªåŒ¹é…</option>
                            <option value="10" selected>å‰10ä¸ªåŒ¹é…</option>
                            <option value="20">å‰20ä¸ªåŒ¹é…</option>
                            <option value="50">å‰50ä¸ªåŒ¹é…</option>
                        </select>
                        <div class="form-text">æ¯ä¸ªæºè®°å½•è¿”å›çš„æœ€å¤§åŒ¹é…æ•°</div>
                    </div>
                </div>
                
                <!-- é«˜çº§é€‰é¡¹ -->
                <div class="mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="fas fa-sliders-h"></i> é«˜çº§é€‰é¡¹</h6>
                        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#advanced-options">
                            <i class="fas fa-chevron-down"></i> å±•å¼€/æ”¶èµ·
                        </button>
                    </div>
                    
                    <div class="collapse" id="advanced-options">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enable-preprocessing" checked>
                                    <label class="form-check-label" for="enable-preprocessing">
                                        æ•°æ®é¢„å¤„ç†ä¼˜åŒ–
                                    </label>
                                    <div class="form-text">è‡ªåŠ¨æ¸…ç†å’Œæ ‡å‡†åŒ–æ•°æ®</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enable-caching" checked>
                                    <label class="form-check-label" for="enable-caching">
                                        ç»“æœç¼“å­˜åŠ é€Ÿ
                                    </label>
                                    <div class="form-text">ç¼“å­˜åŒ¹é…ç»“æœæå‡æ€§èƒ½</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enable-parallel" checked>
                                    <label class="form-check-label" for="enable-parallel">
                                        å¹¶è¡Œå¤„ç†åŠ é€Ÿ
                                    </label>
                                    <div class="form-text">å¤šçº¿ç¨‹å¹¶è¡Œæå‡é€Ÿåº¦</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="mt-4 d-flex gap-3">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-rocket"></i> å¯åŠ¨æ™ºèƒ½åŒ¹é…
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-lg" onclick="previewMatching()">
                        <i class="fas fa-eye"></i> é¢„è§ˆåŒ¹é…
                    </button>
                    <button type="button" class="btn btn-outline-info btn-lg" onclick="exportConfig()">
                        <i class="fas fa-download"></i> å¯¼å‡ºé…ç½®
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-lg" onclick="viewHistory()">
                        <i class="fas fa-history"></i> å†å²ä»»åŠ¡
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- åŒ¹é…ä»»åŠ¡çŠ¶æ€é¢æ¿ -->
    <div class="card mt-4 shadow-sm" id="task-status-panel" style="display: none;">
        <div class="card-header bg-warning text-dark">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-tasks"></i> åŒ¹é…ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€</h5>
                <span id="task-id-display" class="badge bg-dark">-</span>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <!-- è¿›åº¦æ¡ -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold">æ‰§è¡Œè¿›åº¦</span>
                            <span id="progress-percentage" class="badge bg-primary">0%</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                 role="progressbar" style="width: 0%">
                                <span id="progress-text">å‡†å¤‡ä¸­...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- çŠ¶æ€ä¿¡æ¯ -->
                    <div class="row text-center">
                        <div class="col-3">
                            <div class="stat-item">
                                <h4 id="processed-count" class="text-primary mb-0">0</h4>
                                <small class="text-muted">å·²å¤„ç†</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="stat-item">
                                <h4 id="total-count" class="text-info mb-0">0</h4>
                                <small class="text-muted">æ€»æ•°é‡</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="stat-item">
                                <h4 id="matches-count" class="text-success mb-0">0</h4>
                                <small class="text-muted">åŒ¹é…æ•°</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="stat-item">
                                <h4 id="elapsed-time" class="text-warning mb-0">0s</h4>
                                <small class="text-muted">è€—æ—¶</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <p id="status-message" class="mb-1 fw-bold text-primary">å‡†å¤‡å¯åŠ¨åŒ¹é…ä»»åŠ¡...</p>
                        <p id="current-operation" class="mb-0 text-muted small">ç­‰å¾…å¼€å§‹</p>
                    </div>
                </div>
                
                <div class="col-md-4 text-end">
                    <div class="d-grid gap-2">
                        <button id="pause-task-btn" class="btn btn-outline-warning" onclick="pauseTask()" style="display: none;">
                            <i class="fas fa-pause"></i> æš‚åœä»»åŠ¡
                        </button>
                        <button id="stop-task-btn" class="btn btn-outline-danger" onclick="stopTask()" style="display: none;">
                            <i class="fas fa-stop"></i> åœæ­¢ä»»åŠ¡
                        </button>
                        <button id="view-results-btn" class="btn btn-primary" onclick="viewResults()" style="display: none;">
                            <i class="fas fa-chart-bar"></i> æŸ¥çœ‹ç»“æœ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- é¢„è§ˆç»“æœæ¨¡æ€æ¡† -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-eye"></i> åŒ¹é…é¢„è§ˆç»“æœ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="preview-content">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">æ­£åœ¨ç”Ÿæˆé¢„è§ˆ...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary" onclick="startFullMatching()">å¯åŠ¨å®Œæ•´åŒ¹é…</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentConfigId = null;
let currentTaskId = null;
let progressTimer = null;
let startTime = null;
// å­˜å‚¨æœ€åå®Œæˆçš„ä»»åŠ¡ä¿¡æ¯ï¼Œç”¨äºæŸ¥çœ‹ç»“æœ
let lastCompletedTaskId = null;
let lastCompletedConfigId = null;

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // ä»URLå‚æ•°è·å–é…ç½®ID
    const urlParams = new URLSearchParams(window.location.search);
    currentConfigId = urlParams.get('config_id');
    
    if (currentConfigId) {
        loadMappingConfig();
    } else {
        showError('ç¼ºå°‘é…ç½®IDå‚æ•°ï¼Œè¯·ä»å­—æ®µæ˜ å°„é¡µé¢æ­£ç¡®è·³è½¬');
        setTimeout(() => {
            window.location.href = '/user_driven_field_mapping';
        }, 3000);
    }
    
    // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
    document.getElementById('matching-form').addEventListener('submit', startMatching);
});

// åŠ è½½æ˜ å°„é…ç½®ä¿¡æ¯
async function loadMappingConfig() {
    try {
        const response = await fetch(`/api/get_field_mapping_config?config_id=${currentConfigId}`);
        const data = await response.json();
        
        if (data.success) {
            const config = data.config;
            
            // éšè—åŠ è½½æç¤ºï¼Œæ˜¾ç¤ºå†…å®¹
            document.getElementById('config-loading').style.display = 'none';
            document.getElementById('config-content').style.display = 'block';
            
            // æ›´æ–°é…ç½®ä¿¡æ¯
            document.getElementById('config-id').textContent = config.config_id;
            document.getElementById('source-table').textContent = config.source_table;
            document.getElementById('created-at').textContent = new Date(config.created_at).toLocaleString();
            document.getElementById('mapping-count').textContent = config.mappings.length;
            
            // æ˜¾ç¤ºç›®æ ‡è¡¨
            const targetTablesDiv = document.getElementById('target-tables');
            targetTablesDiv.innerHTML = '';
            config.target_tables.forEach(table => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-secondary me-1';
                badge.textContent = table;
                targetTablesDiv.appendChild(badge);
            });
            
            // æ›´æ–°æ˜ å°„è¯¦æƒ…è¡¨æ ¼
            const tbody = document.getElementById('mapping-list');
            tbody.innerHTML = '';
            
            config.mappings.forEach(mapping => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><code>${mapping.source_field}</code></td>
                    <td><code>${mapping.target_field}</code></td>
                    <td><span class="badge bg-info">${mapping.target_table}</span></td>
                    <td><span class="badge bg-primary">${(mapping.similarity_score * 100).toFixed(1)}%</span></td>
                    <td><small class="text-muted">${mapping.data_type || 'auto'}</small></td>
                `;
                tbody.appendChild(row);
            });
            
            // åŠ è½½æ•°æ®ç»Ÿè®¡
            loadDataStatistics(config);
            
        } else {
            showError('åŠ è½½é…ç½®å¤±è´¥: ' + data.error);
        }
    } catch (error) {
        showError('åŠ è½½é…ç½®æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
    }
}

// åŠ è½½æ•°æ®ç»Ÿè®¡
async function loadDataStatistics(config) {
    try {
        const tables = [config.source_table, ...config.target_tables];
        const tableParams = tables.join(',');
        
        // ä½¿ç”¨è½»é‡çº§æ¨¡å¼å’ŒæŒ‡å®šè¡¨åæ¥ä¼˜åŒ–åŠ è½½é€Ÿåº¦
        const response = await fetch(`/api/database_tables?lightweight=true&tables=${encodeURIComponent(tableParams)}`);
        const data = await response.json();
        
        if (data.success) {
            const statsDiv = document.getElementById('data-stats');
            let statsHtml = '';
            
            if (data.lightweight_mode) {
                // è½»é‡çº§æ¨¡å¼ï¼šæ˜¾ç¤ºè¡¨åå’Œå­—æ®µæ•°
                data.tables.forEach(table => {
                    const isSource = table.name === config.source_table;
                    const badgeClass = isSource ? 'bg-primary' : 'bg-secondary';
                    statsHtml += `<span class="badge ${badgeClass} me-1">${table.name}: ${table.fields}å­—æ®µ</span><br>`;
                });
                statsHtml += `<small class="text-info mt-1 d-block">å¿«é€ŸåŠ è½½æ¨¡å¼ - å·²ä¼˜åŒ–é¡µé¢åŠ è½½é€Ÿåº¦</small>`;
            } else {
                // å®Œæ•´æ¨¡å¼ï¼šæ˜¾ç¤ºè®°å½•æ•°ç»Ÿè®¡
                let totalRecords = 0;
                data.tables.forEach(table => {
                    totalRecords += table.count;
                    const isSource = table.name === config.source_table;
                    const badgeClass = isSource ? 'bg-primary' : 'bg-secondary';
                    statsHtml += `<span class="badge ${badgeClass} me-1">${table.name}: ${table.count.toLocaleString()}</span><br>`;
                });
                statsHtml += `<small class="text-success mt-1 d-block">æ€»è®¡: ${totalRecords.toLocaleString()} æ¡è®°å½•</small>`;
            }
            
            statsDiv.innerHTML = statsHtml;
        }
    } catch (error) {
        console.warn('åŠ è½½æ•°æ®ç»Ÿè®¡å¤±è´¥:', error);
        document.getElementById('data-stats').innerHTML = '<small class="text-muted">ç»Ÿè®¡ä¿¡æ¯åŠ è½½å¤±è´¥</small>';
    }
}

// å¯åŠ¨åŒ¹é…ä»»åŠ¡
async function startMatching(event) {
    event.preventDefault();
    
    if (!currentConfigId) {
        showError('é…ç½®IDä¸å­˜åœ¨');
        return;
    }
    
    // é˜²é‡å¤æäº¤æ£€æŸ¥
    const startBtn = document.getElementById('start-matching-btn');
    if (startBtn && startBtn.disabled) {
        showError('ä»»åŠ¡æ­£åœ¨å¯åŠ¨ä¸­ï¼Œè¯·å‹¿é‡å¤æäº¤');
        return;
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²æœ‰è¿›è¡Œä¸­çš„ä»»åŠ¡
    if (currentTaskId) {
        showError('å·²æœ‰ä»»åŠ¡åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆæˆ–åœæ­¢å½“å‰ä»»åŠ¡');
        return;
    }
    
    const matchingParams = {
        config_id: currentConfigId,
        algorithm_type: document.getElementById('algorithm-type').value,
        similarity_threshold: parseFloat(document.getElementById('similarity-threshold').value),
        batch_size: parseInt(document.getElementById('batch-size').value),
        max_results: parseInt(document.getElementById('max-results').value),
        enable_preprocessing: document.getElementById('enable-preprocessing').checked,
        enable_caching: document.getElementById('enable-caching').checked,
        enable_parallel: document.getElementById('enable-parallel').checked
    };
    
    // ç¦ç”¨å¼€å§‹æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
    if (startBtn) {
        startBtn.disabled = true;
        startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å¯åŠ¨ä¸­...';
    }
    
    try {
        const response = await fetch('/api/start_user_data_matching', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(matchingParams)
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentTaskId = data.task_id;
            startTime = Date.now();
            showSuccess('åŒ¹é…ä»»åŠ¡å¯åŠ¨æˆåŠŸï¼ä»»åŠ¡ID: ' + currentTaskId);
            
            // æ˜¾ç¤ºä»»åŠ¡çŠ¶æ€é¢æ¿
            document.getElementById('task-status-panel').style.display = 'block';
            document.getElementById('task-id-display').textContent = currentTaskId;
            document.getElementById('stop-task-btn').style.display = 'block';
            document.getElementById('pause-task-btn').style.display = 'block';
            
            // æ»šåŠ¨åˆ°çŠ¶æ€é¢æ¿
            document.getElementById('task-status-panel').scrollIntoView({ behavior: 'smooth' });
            
            // å¼€å§‹ç›‘æ§è¿›åº¦
            startProgressMonitoring();
        } else {
            showError('å¯åŠ¨åŒ¹é…ä»»åŠ¡å¤±è´¥: ' + data.error);
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            if (startBtn) {
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fas fa-play"></i> å¼€å§‹åŒ¹é…';
            }
        }
    } catch (error) {
        showError('å¯åŠ¨ä»»åŠ¡æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        if (startBtn) {
            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="fas fa-play"></i> å¼€å§‹åŒ¹é…';
        }
    }
}

// å¼€å§‹è¿›åº¦ç›‘æ§
function startProgressMonitoring() {
    progressTimer = setInterval(async () => {
        try {
            const response = await fetch(`/api/user_matching_progress?task_id=${currentTaskId}`);
            const data = await response.json();
            
            if (data.success) {
                const progress = data.progress;
                const status = data.status;
                
                // æ›´æ–°è¿›åº¦æ¡
                const progressBar = document.getElementById('progress-bar');
                const percentage = progress.percentage || 0;
                progressBar.style.width = percentage + '%';
                document.getElementById('progress-percentage').textContent = percentage + '%';
                document.getElementById('progress-text').textContent = `${percentage}%`;
                
                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                document.getElementById('processed-count').textContent = progress.processed || 0;
                document.getElementById('total-count').textContent = progress.total || 0;
                document.getElementById('matches-count').textContent = progress.matches || 0;
                
                // æ›´æ–°è€—æ—¶
                if (startTime) {
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    document.getElementById('elapsed-time').textContent = elapsed + 's';
                }
                
                // æ›´æ–°çŠ¶æ€ä¿¡æ¯
                document.getElementById('status-message').textContent = getStatusMessage(status);
                document.getElementById('current-operation').textContent = progress.current_operation || 'å¤„ç†ä¸­...';
                
                // å¦‚æœä»»åŠ¡å®Œæˆ
                if (status === 'completed' || status === 'failed' || status === 'stopped') {
                    clearInterval(progressTimer);
                    document.getElementById('stop-task-btn').style.display = 'none';
                    document.getElementById('pause-task-btn').style.display = 'none';
                    
                    if (status === 'completed') {
                        document.getElementById('view-results-btn').style.display = 'block';
                        showSuccess(`åŒ¹é…ä»»åŠ¡å®Œæˆï¼å…±æ‰¾åˆ° ${progress.matches} ä¸ªåŒ¹é…ç»“æœ`);
                        progressBar.className = 'progress-bar bg-success';
                        
                        // ä¿å­˜ä»»åŠ¡IDç”¨äºè·³è½¬å’Œåç»­æŸ¥çœ‹ç»“æœï¼ˆåœ¨é‡ç½®ä¹‹å‰ï¼‰
                        const completedTaskId = currentTaskId;
                        const completedConfigId = currentConfigId;
                        lastCompletedTaskId = completedTaskId;
                        lastCompletedConfigId = completedConfigId;
                        
                        // è‡ªåŠ¨è·³è½¬åˆ°ç»“æœé¡µé¢
                        setTimeout(() => {
                            window.location.href = `/user_matching_results?task_id=${completedTaskId}&config_id=${completedConfigId}`;
                        }, 3000);
                    } else if (status === 'failed') {
                        showError('åŒ¹é…ä»»åŠ¡å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                        progressBar.className = 'progress-bar bg-danger';
                    } else if (status === 'stopped') {
                        showInfo('åŒ¹é…ä»»åŠ¡å·²åœæ­¢');
                        progressBar.className = 'progress-bar bg-warning';
                    }
                    
                    // åœ¨æ‰€æœ‰å®ŒæˆçŠ¶æ€ä¸‹é‡ç½®ä»»åŠ¡IDå’ŒæŒ‰é’®çŠ¶æ€
                    currentTaskId = null;
                    currentConfigId = null;
                    const startBtn = document.getElementById('start-matching-btn');
                    if (startBtn) {
                        startBtn.disabled = false;
                        startBtn.innerHTML = '<i class="fas fa-play"></i> å¼€å§‹åŒ¹é…';
                    }
                }
            }
        } catch (error) {
            console.error('è·å–è¿›åº¦å¤±è´¥:', error);
        }
    }, 2000); // æ¯2ç§’æ›´æ–°ä¸€æ¬¡
}

// è·å–çŠ¶æ€æ¶ˆæ¯
function getStatusMessage(status) {
    const statusMessages = {
        'running': 'ğŸš€ åŒ¹é…ä»»åŠ¡æ­£åœ¨æ‰§è¡Œä¸­...',
        'completed': 'âœ… åŒ¹é…ä»»åŠ¡å·²å®Œæˆï¼',
        'failed': 'âŒ åŒ¹é…ä»»åŠ¡æ‰§è¡Œå¤±è´¥',
        'stopped': 'â¹ï¸ åŒ¹é…ä»»åŠ¡å·²åœæ­¢',
        'paused': 'â¸ï¸ åŒ¹é…ä»»åŠ¡å·²æš‚åœ'
    };
    return statusMessages[status] || 'ğŸ“Š ä»»åŠ¡çŠ¶æ€æ›´æ–°ä¸­...';
}

// åœæ­¢ä»»åŠ¡
async function stopTask() {
    if (!currentTaskId) return;
    
    try {
        const response = await fetch(`/api/stop_user_matching_task?task_id=${currentTaskId}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            clearInterval(progressTimer);
            showInfo('ä»»åŠ¡åœæ­¢è¯·æ±‚å·²å‘é€');
        } else {
            showError('åœæ­¢ä»»åŠ¡å¤±è´¥: ' + data.error);
        }
    } catch (error) {
        showError('åœæ­¢ä»»åŠ¡æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
    }
}

// æš‚åœä»»åŠ¡
async function pauseTask() {
    // æš‚åœåŠŸèƒ½çš„å®ç°
    showInfo('æš‚åœåŠŸèƒ½å¼€å‘ä¸­');
}

// æŸ¥çœ‹ç»“æœ
function viewResults() {
    // ä¼˜å…ˆä½¿ç”¨æœ€åå®Œæˆçš„ä»»åŠ¡ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å½“å‰ä»»åŠ¡ä¿¡æ¯
    const taskId = lastCompletedTaskId || currentTaskId;
    const configId = lastCompletedConfigId || currentConfigId;
    
    if (taskId && configId) {
        window.location.href = `/user_matching_results?task_id=${taskId}&config_id=${configId}`;
    } else {
        showError('æ²¡æœ‰å¯æŸ¥çœ‹çš„åŒ¹é…ç»“æœï¼Œè¯·å…ˆå®Œæˆä¸€ä¸ªåŒ¹é…ä»»åŠ¡');
    }
}

// é¢„è§ˆåŒ¹é…
async function previewMatching() {
    if (!currentConfigId) {
        showError('é…ç½®IDä¸å­˜åœ¨');
        return;
    }
    
    const params = {
        config_id: currentConfigId,
        preview_count: 5,
        algorithm_type: document.getElementById('algorithm-type').value,
        similarity_threshold: parseFloat(document.getElementById('similarity-threshold').value)
    };
    
    try {
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const modal = new bootstrap.Modal(document.getElementById('previewModal'));
        modal.show();
        
        const response = await fetch('/api/preview_user_data_matching', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(params)
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayPreviewResults(data.preview_results);
        } else {
            document.getElementById('preview-content').innerHTML = 
                `<div class="alert alert-danger">é¢„è§ˆå¤±è´¥: ${data.error}</div>`;
        }
    } catch (error) {
        document.getElementById('preview-content').innerHTML = 
            `<div class="alert alert-danger">é¢„è§ˆæ—¶å‘ç”Ÿé”™è¯¯: ${error.message}</div>`;
    }
}

// æ˜¾ç¤ºé¢„è§ˆç»“æœ
function displayPreviewResults(results) {
    let html = `<div class="alert alert-info">é¢„è§ˆç»“æœï¼ˆå‰${results.length}æ¡ï¼‰</div>`;
    
    if (results.length === 0) {
        html += '<div class="alert alert-warning">æœªæ‰¾åˆ°åŒ¹é…ç»“æœï¼Œè¯·è°ƒæ•´åŒ¹é…å‚æ•°</div>';
    } else {
        html += '<div class="table-responsive"><table class="table table-striped"><thead><tr>';
        html += '<th>æºè®°å½•</th><th>åŒ¹é…è®°å½•</th><th>ç›¸ä¼¼åº¦</th><th>åŒ¹é…å­—æ®µ</th>';
        html += '</tr></thead><tbody>';
        
        results.forEach(result => {
            html += `<tr>
                <td><code>${JSON.stringify(result.source_record).substring(0, 100)}...</code></td>
                <td><code>${JSON.stringify(result.matched_record).substring(0, 100)}...</code></td>
                <td><span class="badge bg-primary">${(result.similarity * 100).toFixed(1)}%</span></td>
                <td><small>${result.matched_fields.join(', ')}</small></td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
    }
    
    document.getElementById('preview-content').innerHTML = html;
}

// å¯åŠ¨å®Œæ•´åŒ¹é…ï¼ˆä»é¢„è§ˆæ¨¡æ€æ¡†ï¼‰
function startFullMatching() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('previewModal'));
    modal.hide();
    document.getElementById('matching-form').dispatchEvent(new Event('submit'));
}

// å¯¼å‡ºé…ç½®
function exportConfig() {
    if (!currentConfigId) {
        showError('é…ç½®IDä¸å­˜åœ¨');
        return;
    }
    
    const config = {
        config_id: currentConfigId,
        algorithm_type: document.getElementById('algorithm-type').value,
        similarity_threshold: parseFloat(document.getElementById('similarity-threshold').value),
        batch_size: parseInt(document.getElementById('batch-size').value),
        max_results: parseInt(document.getElementById('max-results').value),
        advanced_options: {
            enable_preprocessing: document.getElementById('enable-preprocessing').checked,
            enable_caching: document.getElementById('enable-caching').checked,
            enable_parallel: document.getElementById('enable-parallel').checked
        },
        exported_at: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `matching_config_${currentConfigId}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showSuccess('é…ç½®å·²å¯¼å‡ºåˆ°æ–‡ä»¶');
}

// æŸ¥çœ‹å†å²
function viewHistory() {
    window.location.href = '/user_matching_history?config_id=' + currentConfigId;
}

// å·¥å…·å‡½æ•°
function showSuccess(message) {
    console.log('Success:', message);
    // å¯ä»¥æ·»åŠ æ›´å¥½çš„æç¤ºç»„ä»¶
    alert('âœ… ' + message);
}

function showError(message) {
    console.error('Error:', message);
    alert('âŒ é”™è¯¯: ' + message);
}

function showInfo(message) {
    console.info('Info:', message);
    alert('â„¹ï¸ ' + message);
}
</script>

<style>
.header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
}

.feature-badge .badge {
    font-size: 0.9rem;
    padding: 8px 12px;
}

.info-item {
    margin-bottom: 10px;
}

.info-item label {
    font-size: 0.9rem;
    margin-bottom: 0;
}

.card {
    border: none;
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.form-text {
    font-size: 0.8rem;
}

.stat-item h4 {
    font-weight: 700;
    font-size: 1.8rem;
}

.progress {
    background-color: #e9ecef;
    border-radius: 10px;
}

.progress-bar {
    border-radius: 10px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
}

.table th {
    font-weight: 600;
    font-size: 0.9rem;
}

.table td {
    vertical-align: middle;
    font-size: 0.9rem;
}

.btn {
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-1px);
}

.btn-lg {
    padding: 12px 24px;
    font-size: 1rem;
}

.modal-xl {
    max-width: 90%;
}

#task-status-panel {
    border-left: 4px solid #ffc107;
}

.spinner-border {
    width: 2rem;
    height: 2rem;
}

code {
    background-color: #f8f9fa;
    padding: 2px 4px;
    border-radius: 3px;
    font-size: 0.85em;
}

@media (max-width: 768px) {
    .header h1 {
        font-size: 2rem;
    }
    
    .stat-item h4 {
        font-size: 1.4rem;
    }
    
    .btn-lg {
        padding: 10px 20px;
        font-size: 0.9rem;
    }
}
</style>
{% endblock %}
