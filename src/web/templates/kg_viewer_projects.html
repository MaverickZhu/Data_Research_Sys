<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŒ‰é¡¹ç›®æµè§ˆçŸ¥è¯†å›¾è°±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .project-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #007bff;
        }
        .project-card.selected {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
        }
        .entity-item, .relation-item {
            border-left: 4px solid #007bff;
            transition: all 0.2s;
        }
        .entity-item:hover, .relation-item:hover {
            background-color: #f8f9fa;
            border-left-color: #28a745;
        }
        .view-toggle {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            color: white;
            font-weight: bold;
        }
        .view-toggle.active {
            background: linear-gradient(45deg, #28a745, #20c997);
        }
    </style>
</head>
<body>
    {% extends "base.html" %}
    
    {% block content %}
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- é¡¹ç›®é€‰æ‹©é¢æ¿ -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-folder-open me-2"></i>
                            é¡¹ç›®åˆ—è¡¨
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="projects-list" class="list-group list-group-flush">
                            <div class="list-group-item text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">åŠ è½½é¡¹ç›®ä¸­...</span>
                                </div>
                                <div class="mt-2">åŠ è½½é¡¹ç›®ä¸­...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- è§†å›¾åˆ‡æ¢ -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">è§†å›¾æ¨¡å¼</h6>
                    </div>
                    <div class="card-body">
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn view-toggle active" id="project-view-btn" onclick="switchViewMode('project')">
                                <i class="fas fa-layer-group me-1"></i>
                                é¡¹ç›®è§†å›¾
                            </button>
                            <button type="button" class="btn view-toggle" id="global-view-btn" onclick="switchViewMode('global')">
                                <i class="fas fa-globe me-1"></i>
                                å…¨å±€è§†å›¾
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ä¸»å†…å®¹åŒºåŸŸ -->
            <div class="col-md-9">
                <!-- é¡¹ç›®ä¿¡æ¯å’Œç»Ÿè®¡ -->
                <div id="project-info" class="row mb-4" style="display: none;">
                    <div class="col-md-12">
                        <div class="stats-card p-4">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h3 id="project-title" class="mb-1">é¡¹ç›®åç§°</h3>
                                    <p id="project-description" class="mb-0 opacity-75">é€‰æ‹©ä¸€ä¸ªé¡¹ç›®æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="d-flex justify-content-end align-items-center gap-3">
                                        <div class="text-center">
                                            <div id="project-entities-count" class="h4 mb-0">-</div>
                                            <small>å®ä½“æ•°é‡</small>
                                        </div>
                                        <div class="text-center">
                                            <div id="project-relations-count" class="h4 mb-0">-</div>
                                            <small>å…³ç³»æ•°é‡</small>
                                        </div>
                                        <div class="text-center">
                                            <div id="project-triples-count" class="h4 mb-0">-</div>
                                            <small>ä¸‰å…ƒç»„æ•°é‡</small>
                                        </div>
                                        <div class="ms-3">
                                            <button id="delete-project-btn" class="btn btn-outline-danger btn-sm" onclick="showDeleteConfirmation()" style="display: none;">
                                                <i class="fas fa-trash-alt me-1"></i>
                                                åˆ é™¤å›¾è°±
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ•°æ®å±•ç¤ºåŒºåŸŸ -->
                <div class="row">
                    <!-- å®ä½“åˆ—è¡¨ -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-circle text-primary me-2"></i>
                                    å®ä½“åˆ—è¡¨
                                </h5>
                                <small id="entities-count" class="text-muted">0 ä¸ªå®ä½“</small>
                            </div>
                            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                <div id="entities-list">
                                    <div class="text-center py-4 text-muted">
                                        <i class="fas fa-folder-open fa-2x mb-2"></i>
                                        <div>è¯·é€‰æ‹©ä¸€ä¸ªé¡¹ç›®</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å…³ç³»åˆ—è¡¨ -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-arrow-right text-success me-2"></i>
                                    å…³ç³»åˆ—è¡¨
                                </h5>
                                <small id="relations-count" class="text-muted">0 ä¸ªå…³ç³»</small>
                            </div>
                            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                <div id="relations-list">
                                    <div class="text-center py-4 text-muted">
                                        <i class="fas fa-project-diagram fa-2x mb-2"></i>
                                        <div>è¯·é€‰æ‹©ä¸€ä¸ªé¡¹ç›®</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                    <h5>åŠ è½½é¡¹ç›®æ•°æ®ä¸­...</h5>
                    <p class="text-muted mb-0">è¯·ç¨å€™ï¼Œæ­£åœ¨è·å–çŸ¥è¯†å›¾è°±æ•°æ®</p>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ç¡®è®¤åˆ é™¤çŸ¥è¯†å›¾è°±
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>âš ï¸ è­¦å‘Šï¼š</strong>æ­¤æ“ä½œä¸å¯é€†ï¼åˆ é™¤åå°†æ— æ³•æ¢å¤ã€‚
                    </div>
                    <p>æ‚¨å³å°†åˆ é™¤é¡¹ç›® <strong id="delete-project-name">-</strong> çš„æ‰€æœ‰çŸ¥è¯†å›¾è°±æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š</p>
                    <ul id="delete-preview-list">
                        <li>å®ä½“æ•°æ®ï¼š<span id="delete-entities-count">-</span> ä¸ª</li>
                        <li>å…³ç³»æ•°æ®ï¼š<span id="delete-relations-count">-</span> ä¸ª</li>
                        <li>æ¶‰åŠå›¾è°±ï¼š<span id="delete-graphs-list">-</span></li>
                    </ul>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="confirmDelete">
                        <label class="form-check-label text-danger" for="confirmDelete">
                            æˆ‘ç¡®è®¤è¦åˆ é™¤æ­¤é¡¹ç›®çš„çŸ¥è¯†å›¾è°±æ•°æ®
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="executeDelete()" disabled>
                        <i class="fas fa-trash-alt me-1"></i>
                        ç¡®è®¤åˆ é™¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤è¿›åº¦æ¨¡æ€æ¡† -->
    <div class="modal fade" id="deleteProgressModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-danger mb-3" role="status">
                        <span class="visually-hidden">åˆ é™¤ä¸­...</span>
                    </div>
                    <h5>æ­£åœ¨åˆ é™¤çŸ¥è¯†å›¾è°±...</h5>
                    <p class="text-muted mb-0">è¯·ç¨å€™ï¼Œæ­£åœ¨æ¸…ç†æ•°æ®</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å…¨å±€çŠ¶æ€
        let currentProject = null;
        let currentViewMode = 'project'; // 'project' æˆ– 'global'
        let allProjects = [];
        let loadingModal = null;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('æŒ‰é¡¹ç›®æµè§ˆçŸ¥è¯†å›¾è°±é¡µé¢åŠ è½½å®Œæˆ');
            
            // ç«‹å³å¼ºåˆ¶éšè—ä»»ä½•æ®‹ç•™çš„åŠ è½½çŠ¶æ€
            setTimeout(() => {
                console.log('ğŸ”§ æ‰§è¡Œå¼ºåˆ¶æ¨¡æ€æ¡†æ¸…ç†...');
                const loadingModal = document.getElementById('loadingModal');
                if (loadingModal) {
                    loadingModal.style.display = 'none';
                    loadingModal.classList.remove('show', 'fade');
                    loadingModal.setAttribute('aria-hidden', 'true');
                }
                document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                document.body.classList.remove('modal-open');
                document.body.style.paddingRight = '';
                document.body.style.overflow = '';
                console.log('âœ… å¼ºåˆ¶æ¸…ç†å®Œæˆ');
            }, 50);
            
            // åˆå§‹åŒ–Bootstrap Modal
            loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'), {
                keyboard: false,
                backdrop: 'static'
            });
            
            // åŠ è½½é¡¹ç›®åˆ—è¡¨
            loadProjects();
            
            // å®šæœŸæ£€æŸ¥å¹¶æ¸…ç†ä»»ä½•æ®‹ç•™çš„åŠ è½½çŠ¶æ€
            setInterval(() => {
                const modalVisible = document.querySelector('#loadingModal[style*="block"]') || 
                                   document.querySelector('#loadingModal.show') ||
                                   document.querySelector('.modal-backdrop');
                if (modalVisible) {
                    console.log('ğŸ”§ æ£€æµ‹åˆ°æ®‹ç•™æ¨¡æ€æ¡†ï¼Œæ‰§è¡Œæ¸…ç†...');
                    hideLoading();
                }
            }, 2000);
        });

        // åŠ è½½é¡¹ç›®åˆ—è¡¨
        async function loadProjects() {
            try {
                console.log('å¼€å§‹åŠ è½½é¡¹ç›®åˆ—è¡¨...');
                
                const response = await fetch('/api/kg/projects');
                if (!response.ok) {
                    throw new Error(`é¡¹ç›®åˆ—è¡¨APIå¤±è´¥: ${response.status}`);
                }
                
                const data = await response.json();
                allProjects = data.projects || [];
                
                console.log('é¡¹ç›®åˆ—è¡¨åŠ è½½æˆåŠŸ:', allProjects);
                
                renderProjectsList();
                
            } catch (error) {
                console.error('åŠ è½½é¡¹ç›®åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('projects-list').innerHTML = `
                    <div class="list-group-item text-center py-4 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <div>åŠ è½½é¡¹ç›®å¤±è´¥</div>
                        <small>${error.message}</small>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="loadProjects()">
                                <i class="fas fa-redo me-1"></i>é‡è¯•
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“é¡¹ç›®åˆ—è¡¨
        function renderProjectsList() {
            const container = document.getElementById('projects-list');
            
            if (allProjects.length === 0) {
                container.innerHTML = `
                    <div class="list-group-item text-center py-4 text-muted">
                        <i class="fas fa-folder-open fa-2x mb-2"></i>
                        <div>æš‚æ— é¡¹ç›®</div>
                        <small>è¯·å…ˆæ„å»ºçŸ¥è¯†å›¾è°±</small>
                    </div>
                `;
                return;
            }
            
            const html = allProjects.map(project => `
                <div class="list-group-item list-group-item-action project-card" 
                     onclick="selectProject('${project.project_name}')">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${project.project_name}</h6>
                            <div class="d-flex gap-3 text-muted small">
                                ${project.has_global_graph ? `<span><i class="fas fa-globe me-1"></i>${project.global_entities}</span>` : ''}
                                ${project.has_project_graph ? `<span><i class="fas fa-layer-group me-1"></i>${project.project_entities}</span>` : ''}
                            </div>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">
                                ${project.has_global_graph && project.has_project_graph ? 'åŒæ¨¡å¼' : 
                                  project.has_global_graph ? 'å…¨å±€' : 'é¡¹ç›®'}
                            </small>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // é€‰æ‹©é¡¹ç›®
        async function selectProject(projectName) {
            if (currentProject === projectName) return;
            
            console.log(`é€‰æ‹©é¡¹ç›®: ${projectName}, è§†å›¾æ¨¡å¼: ${currentViewMode}`);
            
            // æ›´æ–°UIçŠ¶æ€
            document.querySelectorAll('.project-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            currentProject = projectName;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading();
            
            try {
                // åŠ è½½é¡¹ç›®æ•°æ®
                await loadProjectData(projectName);
                
                // æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
                document.getElementById('project-info').style.display = 'block';
                document.getElementById('project-title').textContent = projectName;
                document.getElementById('project-description').textContent = 
                    `å½“å‰æŸ¥çœ‹æ¨¡å¼: ${currentViewMode === 'global' ? 'å…¨å±€è§†å›¾ï¼ˆå¸¦é¡¹ç›®æ ‡ç­¾ï¼‰' : 'é¡¹ç›®è§†å›¾ï¼ˆç‹¬ç«‹æ•°æ®ï¼‰'}`;
                
                // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                document.getElementById('delete-project-btn').style.display = 'block';
                
            } catch (error) {
                console.error('åŠ è½½é¡¹ç›®æ•°æ®å¤±è´¥:', error);
                showError(`åŠ è½½é¡¹ç›®æ•°æ®å¤±è´¥: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // åŠ è½½é¡¹ç›®æ•°æ®
        async function loadProjectData(projectName) {
            console.log(`å¼€å§‹åŠ è½½é¡¹ç›®æ•°æ®: ${projectName}`);
            
            // å¹¶è¡ŒåŠ è½½ç»Ÿè®¡ä¿¡æ¯å’Œå®ä½“æ•°æ®
            const [statsResponse, entitiesResponse] = await Promise.all([
                fetch(`/api/kg/projects/${projectName}/stats?global=${currentViewMode === 'global'}`),
                fetch(`/api/kg/projects/${projectName}/entities?limit=100&global=${currentViewMode === 'global'}`)
            ]);

            if (!statsResponse.ok || !entitiesResponse.ok) {
                throw new Error(`APIè¯·æ±‚å¤±è´¥: stats=${statsResponse.status}, entities=${entitiesResponse.status}`);
            }

            const stats = await statsResponse.json();
            const entities = await entitiesResponse.json();

            console.log('é¡¹ç›®æ•°æ®åŠ è½½æˆåŠŸ:', { stats, entities });

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('project-entities-count').textContent = stats.total_entities || 0;
            document.getElementById('project-relations-count').textContent = stats.total_relations || 0;
            document.getElementById('project-triples-count').textContent = stats.total_triples || 0;

            // æ›´æ–°å®ä½“åˆ—è¡¨
            renderEntitiesList(entities.entities || []);
            document.getElementById('entities-count').textContent = `${entities.entities?.length || 0} ä¸ªå®ä½“`;

            // æš‚æ—¶æ˜¾ç¤ºå…³ç³»ä¸ºç©ºï¼ˆåç»­å¯ä»¥æ·»åŠ å…³ç³»APIï¼‰
            document.getElementById('relations-list').innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-project-diagram fa-2x mb-2"></i>
                    <div>å…³ç³»æ•°æ®å¼€å‘ä¸­</div>
                </div>
            `;
            document.getElementById('relations-count').textContent = '0 ä¸ªå…³ç³»';
        }

        // æ¸²æŸ“å®ä½“åˆ—è¡¨
        function renderEntitiesList(entities) {
            const container = document.getElementById('entities-list');
            
            console.log('å¼€å§‹æ¸²æŸ“å®ä½“åˆ—è¡¨:', entities);
            
            if (entities.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-circle fa-2x mb-2"></i>
                        <div>æš‚æ— å®ä½“æ•°æ®</div>
                    </div>
                `;
                return;
            }
            
            try {
                const html = entities.map((entity, index) => {
                    // å®‰å…¨å¤„ç†å®ä½“ç±»å‹
                    let entityType = 'UNKNOWN';
                    try {
                        if (typeof entity.type === 'string') {
                            entityType = entity.type;
                        } else if (entity.type && typeof entity.type === 'object') {
                            entityType = entity.type.value || entity.type.name || JSON.stringify(entity.type);
                        }
                    } catch (typeError) {
                        console.warn(`å¤„ç†å®ä½“ç±»å‹å¤±è´¥ (${index}):`, typeError, entity);
                        entityType = 'ERROR';
                    }

                    return `
                        <div class="entity-item p-3 mb-2 rounded" onclick="selectEntity('${entity.id}')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="fw-bold text-primary">${entity.label || entity.id}</div>
                                    <div class="small text-muted mt-1">
                                        <span class="badge bg-secondary me-2">${entityType}</span>
                                        ${entity.project_name ? `<span class="badge bg-info">${entity.project_name}</span>` : ''}
                                    </div>
                                </div>
                                <div class="text-end">
                                    <small class="confidence text-muted">
                                        ${entity.confidence ? (entity.confidence * 100).toFixed(1) + '%' : ''}
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = html;
                console.log('å®ä½“åˆ—è¡¨æ¸²æŸ“å®Œæˆ');
                
            } catch (error) {
                console.error('æ¸²æŸ“å®ä½“åˆ—è¡¨æ—¶å‡ºé”™:', error);
                container.innerHTML = `
                    <div class="text-center py-4 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <div>æ¸²æŸ“å®ä½“åˆ—è¡¨å¤±è´¥</div>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        // åˆ‡æ¢è§†å›¾æ¨¡å¼
        function switchViewMode(mode) {
            if (currentViewMode === mode) return;
            
            console.log(`åˆ‡æ¢è§†å›¾æ¨¡å¼: ${currentViewMode} -> ${mode}`);
            
            currentViewMode = mode;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.view-toggle').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${mode}-view-btn`).classList.add('active');
            
            // å¦‚æœæœ‰é€‰ä¸­çš„é¡¹ç›®ï¼Œé‡æ–°åŠ è½½æ•°æ®
            if (currentProject) {
                selectProject(currentProject);
            }
        }

        // é€‰æ‹©å®ä½“
        function selectEntity(entityId) {
            console.log('é€‰æ‹©å®ä½“:', entityId);
            // è¿™é‡Œå¯ä»¥æ·»åŠ å®ä½“è¯¦æƒ…æ˜¾ç¤ºé€»è¾‘
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            if (loadingModal) {
                loadingModal.show();
            }
        }

        // éšè—åŠ è½½çŠ¶æ€ï¼ˆå¼ºåˆ¶éšè—ï¼‰
        function hideLoading() {
            console.log('ğŸ”§ å¼€å§‹éšè—åŠ è½½æ¨¡æ€æ¡†...');
            
            try {
                // 1. å°è¯•Bootstrapæ–¹å¼éšè—
                if (loadingModal) {
                    loadingModal.hide();
                }
                
                // 2. å¼ºåˆ¶DOMéšè—
                const modalElement = document.getElementById('loadingModal');
                if (modalElement) {
                    modalElement.style.display = 'none';
                    modalElement.classList.remove('show', 'fade');
                    modalElement.setAttribute('aria-hidden', 'true');
                    modalElement.removeAttribute('aria-modal');
                    modalElement.removeAttribute('role');
                }
                
                // 3. æ¸…ç†èƒŒæ™¯é®ç½©
                document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                
                // 4. æ¢å¤bodyçŠ¶æ€
                document.body.classList.remove('modal-open');
                document.body.style.paddingRight = '';
                document.body.style.overflow = '';
                
                console.log('âœ… åŠ è½½æ¨¡æ€æ¡†éšè—å®Œæˆ');
                
            } catch (error) {
                console.error('éšè—åŠ è½½æ¨¡æ€æ¡†æ—¶å‡ºé”™:', error);
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            // å¯ä»¥æ·»åŠ é”™è¯¯æç¤ºé€»è¾‘
            console.error('é”™è¯¯:', message);
        }

        // åˆ é™¤åŠŸèƒ½ç›¸å…³
        let deleteConfirmModal = null;
        let deleteProgressModal = null;

        // åˆå§‹åŒ–åˆ é™¤ç›¸å…³æ¨¡æ€æ¡†
        document.addEventListener('DOMContentLoaded', function() {
            deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            deleteProgressModal = new bootstrap.Modal(document.getElementById('deleteProgressModal'));
            
            // ç›‘å¬ç¡®è®¤å¤é€‰æ¡†å˜åŒ–
            document.getElementById('confirmDelete').addEventListener('change', function() {
                document.getElementById('confirmDeleteBtn').disabled = !this.checked;
            });
        });

        // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
        async function showDeleteConfirmation() {
            if (!currentProject) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¡¹ç›®');
                return;
            }

            try {
                // è·å–åˆ é™¤é¢„è§ˆä¿¡æ¯
                const response = await fetch('/api/kg/delete/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        project_name: currentProject
                    })
                });

                if (!response.ok) {
                    throw new Error(`è·å–åˆ é™¤é¢„è§ˆå¤±è´¥: ${response.status}`);
                }

                const data = await response.json();
                const preview = data.preview;

                // å¡«å……åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
                document.getElementById('delete-project-name').textContent = currentProject;
                document.getElementById('delete-entities-count').textContent = preview.entities_to_delete || 0;
                document.getElementById('delete-relations-count').textContent = preview.relations_to_delete || 0;
                document.getElementById('delete-graphs-list').textContent = (preview.graphs_affected || []).join(', ');

                // é‡ç½®ç¡®è®¤çŠ¶æ€
                document.getElementById('confirmDelete').checked = false;
                document.getElementById('confirmDeleteBtn').disabled = true;

                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                deleteConfirmModal.show();

            } catch (error) {
                console.error('è·å–åˆ é™¤é¢„è§ˆå¤±è´¥:', error);
                alert(`è·å–åˆ é™¤é¢„è§ˆå¤±è´¥: ${error.message}`);
            }
        }

        // æ‰§è¡Œåˆ é™¤æ“ä½œ
        async function executeDelete() {
            if (!currentProject) {
                return;
            }

            try {
                // éšè—ç¡®è®¤å¯¹è¯æ¡†ï¼Œæ˜¾ç¤ºè¿›åº¦å¯¹è¯æ¡†
                deleteConfirmModal.hide();
                deleteProgressModal.show();

                // æ‰§è¡Œåˆ é™¤
                const response = await fetch(`/api/kg/delete/project/${encodeURIComponent(currentProject)}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`åˆ é™¤å¤±è´¥: ${response.status}`);
                }

                const result = await response.json();

                // éšè—è¿›åº¦å¯¹è¯æ¡†
                deleteProgressModal.hide();

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                alert(`âœ… é¡¹ç›® "${currentProject}" çš„çŸ¥è¯†å›¾è°±å·²æˆåŠŸåˆ é™¤ï¼`);

                // é‡ç½®ç•Œé¢çŠ¶æ€
                currentProject = null;
                document.getElementById('project-info').style.display = 'none';
                document.getElementById('delete-project-btn').style.display = 'none';

                // é‡æ–°åŠ è½½é¡¹ç›®åˆ—è¡¨
                await loadProjects();

                console.log('åˆ é™¤æ“ä½œå®Œæˆ:', result);

            } catch (error) {
                // éšè—è¿›åº¦å¯¹è¯æ¡†
                deleteProgressModal.hide();
                
                console.error('åˆ é™¤æ“ä½œå¤±è´¥:', error);
                alert(`âŒ åˆ é™¤å¤±è´¥: ${error.message}`);
            }
        }


    </script>
    {% endblock %}
</body>
</html>
