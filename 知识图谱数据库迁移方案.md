# çŸ¥è¯†å›¾è°±æ•°æ®åº“è¿ç§»æ–¹æ¡ˆ
## 2025å¹´8æœˆ14æ—¥

### ğŸ¯ **è¿ç§»ç›®æ ‡**
ä»MongoDBè¿ç§»åˆ°FalkorDBï¼Œå®ç°çŸ¥è¯†å›¾è°±å­˜å‚¨å’ŒæŸ¥è¯¢æ€§èƒ½çš„æ ¹æœ¬æ€§æå‡ã€‚

### ğŸ“Š **æ€§èƒ½ç›®æ ‡**
- **å½“å‰æ€§èƒ½**: 17.5æ¡/ç§’ (MongoDB)
- **ç›®æ ‡æ€§èƒ½**: 1000+æ¡/ç§’ (FalkorDB)
- **é¢„æœŸæå‡**: 57å€æ€§èƒ½æå‡

### ğŸ—ï¸ **æŠ€æœ¯æ¶æ„å¯¹æ¯”**

#### MongoDBæ–¹æ¡ˆ (å½“å‰)
```
åŸå§‹æ•°æ® â†’ å®ä½“æŠ½å– â†’ MongoDBå­˜å‚¨ â†’ å¤æ‚æŸ¥è¯¢ â†’ ç»“æœè¿”å›
```
**é—®é¢˜**:
- å›¾æŸ¥è¯¢éœ€è¦å¤šæ¬¡JOINæ“ä½œ
- ç¼ºä¹å›¾éå†ä¼˜åŒ–
- ä¸‰å…ƒç»„å­˜å‚¨æ ¼å¼å¤æ‚

#### FalkorDBæ–¹æ¡ˆ (ç›®æ ‡)
```
åŸå§‹æ•°æ® â†’ å®ä½“æŠ½å– â†’ FalkorDBå›¾å­˜å‚¨ â†’ CypheræŸ¥è¯¢ â†’ é«˜é€Ÿè¿”å›
```
**ä¼˜åŠ¿**:
- åŸç”Ÿå›¾éå†ç®—æ³•
- GraphBLASçŸ©é˜µè¿ç®—
- å†…å­˜çº§æŸ¥è¯¢æ€§èƒ½

### ğŸš€ **å®æ–½è®¡åˆ’**

#### **ç¬¬ä¸€é˜¶æ®µ: ç¯å¢ƒæ­å»º (1å¤©)**

**1.1 FalkorDB Dockeréƒ¨ç½²**
```bash
# åˆ›å»ºæ•°æ®ç›®å½•
mkdir -p ./docker/falkordb/data

# å¯åŠ¨FalkorDB (å¸¦Webç•Œé¢)
docker run -d \
  --name knowledge-graph-db \
  -p 6379:6379 \
  -p 3000:3000 \
  -v ./docker/falkordb/data:/var/lib/falkordb/data \
  --restart unless-stopped \
  falkordb/falkordb:edge
```

**1.2 Pythonå®¢æˆ·ç«¯å®‰è£…**
```bash
pip install falkordb-py
```

**1.3 è¿æ¥æµ‹è¯•**
```python
from falkordb import FalkorDB

# è¿æ¥FalkorDB
db = FalkorDB(host='localhost', port=6379)
g = db.select_graph('knowledge_graph')

# æµ‹è¯•æŸ¥è¯¢
result = g.query("RETURN 'Hello FalkorDB!'")
print(result.result_set[0][0])
```

#### **ç¬¬äºŒé˜¶æ®µ: æ•°æ®æ¨¡å‹è®¾è®¡ (1å¤©)**

**2.1 å›¾æ¨¡å‹å®šä¹‰**
```cypher
// å®ä½“èŠ‚ç‚¹ç±»å‹
CREATE INDEX FOR (e:Entity) ON (e.id)
CREATE INDEX FOR (e:Entity) ON (e.type)
CREATE INDEX FOR (e:Entity) ON (e.label)

// ç»„ç»‡å®ä½“
CREATE (org:Organization {
  id: $entity_id,
  label: $entity_label,
  type: 'ORGANIZATION',
  confidence: $confidence,
  source_table: $source_table,
  properties: $properties
})

// å…³ç³»ç±»å‹
CREATE INDEX FOR ()-[r:SIMILAR_TO]-() ON (r.confidence)
CREATE INDEX FOR ()-[r:LOCATED_IN]-() ON (r.confidence)
CREATE INDEX FOR ()-[r:BELONGS_TO]-() ON (r.confidence)
```

**2.2 æ•°æ®è½¬æ¢è„šæœ¬**
```python
class MongoToFalkorDBMigrator:
    def __init__(self):
        self.mongo_client = get_db_manager()
        self.falkor_db = FalkorDB(host='localhost', port=6379)
        self.graph = self.falkor_db.select_graph('knowledge_graph')
    
    def migrate_entities(self):
        """è¿ç§»å®ä½“æ•°æ®"""
        entities = self.mongo_client.get_collection('kg_entities')
        batch_size = 1000
        
        for batch in self.batch_iterator(entities.find(), batch_size):
            cypher_queries = []
            for entity in batch:
                query = f"""
                CREATE (e:Entity {{
                    id: '{entity['id']}',
                    label: '{entity['label']}',
                    type: '{entity['type']}',
                    confidence: {entity['confidence']},
                    source_table: '{entity['source_table']}',
                    properties: {json.dumps(entity['properties'])}
                }})
                """
                cypher_queries.append(query)
            
            # æ‰¹é‡æ‰§è¡Œ
            batch_query = ";\n".join(cypher_queries)
            self.graph.query(batch_query)
    
    def migrate_relations(self):
        """è¿ç§»å…³ç³»æ•°æ®"""
        relations = self.mongo_client.get_collection('kg_relations')
        batch_size = 500
        
        for batch in self.batch_iterator(relations.find(), batch_size):
            cypher_queries = []
            for relation in batch:
                query = f"""
                MATCH (s:Entity {{id: '{relation['subject_id']}'}})
                MATCH (o:Entity {{id: '{relation['object_id']}'}})
                CREATE (s)-[r:{relation['predicate_type']} {{
                    confidence: {relation['confidence']},
                    evidence: {json.dumps(relation.get('evidence', []))},
                    created_time: '{relation['created_time']}'
                }}]->(o)
                """
                cypher_queries.append(query)
            
            batch_query = ";\n".join(cypher_queries)
            self.graph.query(batch_query)
```

#### **ç¬¬ä¸‰é˜¶æ®µ: æ•°æ®è¿ç§»æ‰§è¡Œ (2å¤©)**

**3.1 è¿ç§»è„šæœ¬å¼€å‘**
```python
# scripts/migrate_to_falkordb.py
import sys
sys.path.append('src')

from database.connection import get_db_manager
from falkordb import FalkorDB
import json
from datetime import datetime

def main():
    print("ğŸš€ å¼€å§‹çŸ¥è¯†å›¾è°±æ•°æ®è¿ç§»...")
    
    migrator = MongoToFalkorDBMigrator()
    
    # ç¬¬1æ­¥: è¿ç§»å®ä½“
    print("ğŸ“Š è¿ç§»å®ä½“æ•°æ®...")
    migrator.migrate_entities()
    
    # ç¬¬2æ­¥: è¿ç§»å…³ç³»
    print("ğŸ”— è¿ç§»å…³ç³»æ•°æ®...")
    migrator.migrate_relations()
    
    # ç¬¬3æ­¥: éªŒè¯æ•°æ®
    print("âœ… éªŒè¯è¿ç§»ç»“æœ...")
    migrator.validate_migration()
    
    print("ğŸ‰ è¿ç§»å®Œæˆ!")

if __name__ == "__main__":
    main()
```

**3.2 æ‰§è¡Œè¿ç§»**
```bash
python scripts/migrate_to_falkordb.py
```

#### **ç¬¬å››é˜¶æ®µ: ç³»ç»Ÿé›†æˆ (3å¤©)**

**4.1 æ•°æ®åº“è¿æ¥å±‚é‡æ„**
```python
# src/database/falkor_connection.py
from falkordb import FalkorDB
from typing import List, Dict, Any

class FalkorDBManager:
    def __init__(self):
        self.db = FalkorDB(host='localhost', port=6379)
        self.graph = self.db.select_graph('knowledge_graph')
    
    def query_entities(self, entity_type: str = None, limit: int = 100) -> List[Dict]:
        """æŸ¥è¯¢å®ä½“"""
        if entity_type:
            query = f"""
            MATCH (e:Entity {{type: '{entity_type}'}})
            RETURN e
            LIMIT {limit}
            """
        else:
            query = f"""
            MATCH (e:Entity)
            RETURN e
            LIMIT {limit}
            """
        
        result = self.graph.query(query)
        return [self._node_to_dict(record[0]) for record in result.result_set]
    
    def query_relations(self, relation_type: str = None, limit: int = 100) -> List[Dict]:
        """æŸ¥è¯¢å…³ç³»"""
        if relation_type:
            query = f"""
            MATCH (s:Entity)-[r:{relation_type}]->(o:Entity)
            RETURN s, r, o
            LIMIT {limit}
            """
        else:
            query = f"""
            MATCH (s:Entity)-[r]->(o:Entity)
            RETURN s, r, o
            LIMIT {limit}
            """
        
        result = self.graph.query(query)
        return [self._relation_to_dict(record[0], record[1], record[2]) 
                for record in result.result_set]
    
    def search_similar_entities(self, entity_id: str, min_confidence: float = 0.8) -> List[Dict]:
        """æœç´¢ç›¸ä¼¼å®ä½“"""
        query = f"""
        MATCH (e1:Entity {{id: '{entity_id}'}})-[r:SIMILAR_TO]-(e2:Entity)
        WHERE r.confidence >= {min_confidence}
        RETURN e2, r.confidence
        ORDER BY r.confidence DESC
        """
        
        result = self.graph.query(query)
        return [{'entity': self._node_to_dict(record[0]), 'confidence': record[1]} 
                for record in result.result_set]
```

**4.2 APIå±‚é€‚é…**
```python
# src/web/app.py ä¸­çš„ä¿®æ”¹
from database.falkor_connection import FalkorDBManager

# æ›¿æ¢åŸæœ‰çš„MongoDBè¿æ¥
falkor_db = FalkorDBManager()

@app.route('/api/kg/entities', methods=['GET'])
def get_kg_entities():
    """è·å–çŸ¥è¯†å›¾è°±å®ä½“"""
    try:
        entity_type = request.args.get('type')
        limit = int(request.args.get('limit', 100))
        offset = int(request.args.get('offset', 0))
        
        entities = falkor_db.query_entities(entity_type=entity_type, limit=limit)
        
        return jsonify({
            'entities': entities,
            'total': len(entities),
            'limit': limit,
            'offset': offset,
            'status': 'success'
        })
    except Exception as e:
        logger.error(f"æŸ¥è¯¢å®ä½“å¤±è´¥: {str(e)}")
        return jsonify({'error': str(e)}), 500

@app.route('/api/kg/relations', methods=['GET'])
def get_kg_relations():
    """è·å–çŸ¥è¯†å›¾è°±å…³ç³»"""
    try:
        relation_type = request.args.get('type')
        limit = int(request.args.get('limit', 100))
        
        relations = falkor_db.query_relations(relation_type=relation_type, limit=limit)
        
        return jsonify({
            'relations': relations,
            'total': len(relations),
            'limit': limit,
            'status': 'success'
        })
    except Exception as e:
        logger.error(f"æŸ¥è¯¢å…³ç³»å¤±è´¥: {str(e)}")
        return jsonify({'error': str(e)}), 500
```

#### **ç¬¬äº”é˜¶æ®µ: æ€§èƒ½æµ‹è¯•ä¸ä¼˜åŒ– (2å¤©)**

**5.1 æ€§èƒ½æµ‹è¯•è„šæœ¬**
```python
# scripts/performance_test_falkordb.py
import time
from database.falkor_connection import FalkorDBManager

def test_query_performance():
    """æµ‹è¯•æŸ¥è¯¢æ€§èƒ½"""
    db = FalkorDBManager()
    
    # æµ‹è¯•1: å®ä½“æŸ¥è¯¢
    start_time = time.time()
    entities = db.query_entities(limit=10000)
    entity_time = time.time() - start_time
    print(f"å®ä½“æŸ¥è¯¢ (10000æ¡): {entity_time:.2f}ç§’, {len(entities)/entity_time:.2f} æ¡/ç§’")
    
    # æµ‹è¯•2: å…³ç³»æŸ¥è¯¢
    start_time = time.time()
    relations = db.query_relations(limit=10000)
    relation_time = time.time() - start_time
    print(f"å…³ç³»æŸ¥è¯¢ (10000æ¡): {relation_time:.2f}ç§’, {len(relations)/relation_time:.2f} æ¡/ç§’")
    
    # æµ‹è¯•3: ç›¸ä¼¼æ€§æœç´¢
    if entities:
        start_time = time.time()
        similar = db.search_similar_entities(entities[0]['id'])
        similar_time = time.time() - start_time
        print(f"ç›¸ä¼¼æ€§æœç´¢: {similar_time:.2f}ç§’")

if __name__ == "__main__":
    test_query_performance()
```

**5.2 æ€§èƒ½ä¼˜åŒ–é…ç½®**
```bash
# FalkorDBé…ç½®ä¼˜åŒ–
docker run -d \
  --name knowledge-graph-db \
  -p 6379:6379 \
  -p 3000:3000 \
  -v ./docker/falkordb/data:/var/lib/falkordb/data \
  --memory=4g \
  --cpus=2 \
  --restart unless-stopped \
  falkordb/falkordb:edge \
  --maxmemory 3gb \
  --maxmemory-policy allkeys-lru
```

### ğŸ¯ **é¢„æœŸæ”¶ç›Š**

#### **æ€§èƒ½æå‡**
- **æŸ¥è¯¢é€Ÿåº¦**: ä»17.5æ¡/ç§’ â†’ 1000+æ¡/ç§’ (57å€æå‡)
- **å“åº”æ—¶é—´**: ä»ç§’çº§ â†’ æ¯«ç§’çº§
- **å¹¶å‘èƒ½åŠ›**: æ˜¾è‘—æå‡

#### **åŠŸèƒ½å¢å¼º**
- **å›¾éå†**: åŸç”Ÿæ”¯æŒå¤æ‚å›¾æŸ¥è¯¢
- **è·¯å¾„åˆ†æ**: å¤šè·³å…³ç³»æŸ¥è¯¢
- **ç›¸ä¼¼æ€§æœç´¢**: åŸºäºå›¾ç»“æ„çš„æ™ºèƒ½æ¨è
- **å®æ—¶åˆ†æ**: æ”¯æŒå®æ—¶å›¾åˆ†æ

#### **è¿ç»´ä¼˜åŠ¿**
- **éƒ¨ç½²ç®€å•**: Dockerä¸€é”®éƒ¨ç½²
- **ç›‘æ§å®Œå–„**: Redisç”Ÿæ€å·¥å…·æ”¯æŒ
- **å¤‡ä»½æ¢å¤**: æ ‡å‡†Rediså¤‡ä»½æ–¹æ¡ˆ

### ğŸ”§ **é£é™©æ§åˆ¶**

#### **å›æ»šæ–¹æ¡ˆ**
1. ä¿ç•™åŸMongoDBæ•°æ®ä½œä¸ºå¤‡ä»½
2. åŒå†™æœºåˆ¶ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
3. åˆ†é˜¶æ®µåˆ‡æ¢ï¼Œé™ä½é£é™©

#### **æµ‹è¯•ç­–ç•¥**
1. åŠŸèƒ½æµ‹è¯•: ç¡®ä¿æ‰€æœ‰APIæ­£å¸¸å·¥ä½œ
2. æ€§èƒ½æµ‹è¯•: éªŒè¯æ€§èƒ½æå‡ç›®æ ‡
3. å‹åŠ›æµ‹è¯•: ç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§
4. æ•°æ®ä¸€è‡´æ€§æµ‹è¯•: éªŒè¯è¿ç§»å‡†ç¡®æ€§

### ğŸ“… **å®æ–½æ—¶é—´è¡¨**

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | è´Ÿè´£äºº |
|------|------|----------|--------|
| ç¬¬1é˜¶æ®µ | ç¯å¢ƒæ­å»º | 1å¤© | å¼€å‘å›¢é˜Ÿ |
| ç¬¬2é˜¶æ®µ | æ•°æ®æ¨¡å‹è®¾è®¡ | 1å¤© | æ¶æ„å¸ˆ |
| ç¬¬3é˜¶æ®µ | æ•°æ®è¿ç§» | 2å¤© | å¼€å‘å›¢é˜Ÿ |
| ç¬¬4é˜¶æ®µ | ç³»ç»Ÿé›†æˆ | 3å¤© | å¼€å‘å›¢é˜Ÿ |
| ç¬¬5é˜¶æ®µ | æµ‹è¯•ä¼˜åŒ– | 2å¤© | æµ‹è¯•å›¢é˜Ÿ |
| **æ€»è®¡** | **å®Œæ•´è¿ç§»** | **9å¤©** | **å…¨å›¢é˜Ÿ** |

### ğŸ‰ **ç»“è®º**

FalkorDBä½œä¸ºä¸“ä¸ºGraphRAGå’ŒçŸ¥è¯†å›¾è°±ä¼˜åŒ–çš„æ•°æ®åº“ï¼Œå°†ä¸ºæ‚¨çš„æ™ºèƒ½å…³è”åŒ¹é…ç³»ç»Ÿå¸¦æ¥é©å‘½æ€§çš„æ€§èƒ½æå‡ã€‚é€šè¿‡è¿™ä¸ªè¿ç§»æ–¹æ¡ˆï¼Œæ‚¨å°†è·å¾—:

1. **57å€æ€§èƒ½æå‡** - ä»17.5æ¡/ç§’åˆ°1000+æ¡/ç§’
2. **åŸç”Ÿå›¾æŸ¥è¯¢èƒ½åŠ›** - å¤æ‚å…³ç³»æŸ¥è¯¢æ¯«ç§’çº§å“åº”
3. **ç®€åŒ–çš„æ¶æ„** - æ¶ˆé™¤å¤æ‚çš„ä¸‰å…ƒç»„å­˜å‚¨é—®é¢˜
4. **æ›´å¥½çš„æ‰©å±•æ€§** - ä¸ºæœªæ¥çš„GraphRAGåŠŸèƒ½æ‰“ä¸‹åšå®åŸºç¡€

è¿™ä¸ªæ–¹æ¡ˆä¸ä»…è§£å†³äº†å½“å‰çš„æ€§èƒ½ç“¶é¢ˆï¼Œæ›´ä¸ºæ‚¨çš„ç³»ç»Ÿå‘æ™ºèƒ½çŸ¥è¯†å¹³å°çš„æ¼”è¿›å¥ å®šäº†æŠ€æœ¯åŸºç¡€ã€‚
