{% extends "base.html" %}

{% block title %}智能字段映射 - 用户主导模式{% endblock %}

{% block extra_css %}
<style>
    .mapping-workspace {
        max-width: 1600px;
        margin: 20px auto;
        padding: 20px;
    }
    
    .workflow-steps {
        display: flex;
        justify-content: center;
        margin: 30px 0;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .step {
        display: flex;
        align-items: center;
        padding: 10px 20px;
        background: #f8f9fa;
        color: #6c757d;
        border-radius: 25px;
        margin: 0 5px;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .step.active {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        transform: scale(1.05);
    }
    
    .step.completed {
        background: linear-gradient(135deg, #28a745, #1e7e34);
        color: white;
    }
    
    .step-icon {
        margin-right: 8px;
        font-size: 16px;
    }
    
    /* 表格选择区域 */
    .table-selection {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 30px 0;
    }
    
    .table-selector {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        border-left: 5px solid #007bff;
    }
    
    .table-selector.target {
        border-left-color: #28a745;
    }
    
    .selector-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .selector-icon {
        font-size: 24px;
        margin-right: 10px;
        color: #007bff;
    }
    
    .selector-header.target .selector-icon {
        color: #28a745;
    }
    
    .table-list {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .table-item {
        padding: 12px 16px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        margin: 8px 0;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f8f9fa;
    }
    
    .table-item:hover {
        border-color: #007bff;
        background: #e3f2fd;
    }
    
    .table-item.selected {
        border-color: #007bff;
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        color: #1565c0;
        font-weight: 600;
    }
    
    .table-item.target.selected {
        border-color: #28a745;
        background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
        color: #2e7d32;
    }
    
    .table-meta {
        font-size: 12px;
        color: #6c757d;
        margin-top: 5px;
    }
    
    /* 字段映射区域 */
    .mapping-workspace-main {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin: 30px 0;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        min-height: 600px;
    }
    
    .mapping-header {
        text-align: center;
        margin-bottom: 30px;
    }
    
    .mapping-layout {
        display: grid;
        grid-template-columns: 1fr 120px 1fr;
        gap: 20px;
        align-items: start;
    }
    
    .field-panel {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        min-height: 500px;
    }
    
    .field-panel.source {
        border-left: 4px solid #007bff;
    }
    
    .field-panel.target {
        border-left: 4px solid #28a745;
    }
    
    .panel-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #dee2e6;
    }
    
    .panel-icon {
        font-size: 20px;
        margin-right: 10px;
    }
    
    .panel-header.source {
        color: #007bff;
    }
    
    .panel-header.target {
        color: #28a745;
    }
    
    .field-list {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .field-item {
        padding: 12px 15px;
        margin: 6px 0;
        background: white;
        border: 2px solid transparent;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .field-item:hover {
        border-color: #007bff;
        transform: translateX(3px);
        box-shadow: 0 2px 8px rgba(0,123,255,0.2);
    }
    
    .field-item.target:hover {
        border-color: #28a745;
        box-shadow: 0 2px 8px rgba(40,167,69,0.2);
    }
    
    .field-item.selected {
        border-color: #007bff;
        background: linear-gradient(135deg, #e3f2fd, #ffffff);
        color: #1565c0;
        font-weight: 600;
    }
    
    .field-item.target.selected {
        border-color: #28a745;
        background: linear-gradient(135deg, #e8f5e8, #ffffff);
        color: #2e7d32;
    }
    
    .field-item.mapped {
        border-color: #ffc107;
        background: linear-gradient(135deg, #fff3cd, #ffffff);
        color: #856404;
    }
    
    .field-name {
        font-weight: 600;
        margin-bottom: 4px;
    }
    
    .field-type {
        font-size: 12px;
        color: #6c757d;
        background: #e9ecef;
        padding: 2px 8px;
        border-radius: 12px;
        display: inline-block;
    }
    
    .similarity-score {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #17a2b8;
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 10px;
        font-weight: 600;
    }
    
    .similarity-score.high {
        background: #28a745;
    }
    
    .similarity-score.medium {
        background: #ffc107;
        color: #212529;
    }
    
    .similarity-score.low {
        background: #dc3545;
    }
    
    /* 映射连接区域 */
    .mapping-connector {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px 0;
    }
    
    .mapping-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .mapping-btn {
        padding: 10px 15px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 100px;
    }
    
    .mapping-btn.create {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
    }
    
    .mapping-btn.create:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(40,167,69,0.3);
    }
    
    .mapping-btn.remove {
        background: linear-gradient(135deg, #dc3545, #e74c3c);
        color: white;
    }
    
    .mapping-btn.remove:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220,53,69,0.3);
    }
    
    .mapping-btn.auto {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
    }
    
    .mapping-btn.auto:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,123,255,0.3);
    }
    
    .mapping-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    /* 映射关系显示 */
    .mapping-relations {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .mapping-relation {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        margin: 5px 0;
        background: white;
        border-radius: 6px;
        border-left: 4px solid #28a745;
    }
    
    .relation-fields {
        display: flex;
        align-items: center;
        flex: 1;
    }
    
    .relation-source {
        color: #007bff;
        font-weight: 600;
        margin-right: 10px;
    }
    
    .relation-arrow {
        margin: 0 10px;
        color: #6c757d;
    }
    
    .relation-target {
        color: #28a745;
        font-weight: 600;
        margin-left: 10px;
    }
    
    .relation-remove {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .relation-remove:hover {
        background: #c82333;
    }
    
    /* 操作按钮区域 */
    .action-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 30px;
        padding: 20px 0;
        border-top: 2px solid #e9ecef;
    }
    
    .action-btn {
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 120px;
    }
    
    .action-btn.primary {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
    }
    
    .action-btn.success {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
    }
    
    .action-btn.secondary {
        background: linear-gradient(135deg, #6c757d, #5a6268);
        color: white;
    }
    
    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .action-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    /* 响应式设计 */
    @media (max-width: 1200px) {
        .mapping-layout {
            grid-template-columns: 1fr;
            gap: 30px;
        }
        
        .mapping-connector {
            order: 3;
        }
        
        .field-panel.target {
            order: 2;
        }
    }
    
    /* 加载动画 */
    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: #6c757d;
    }
    
    .loading i {
        margin-right: 10px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="mapping-workspace">
    <!-- 工作流步骤指示器 -->
    <div class="workflow-steps">
        <div class="step active" id="step-1">
            <i class="fas fa-table step-icon"></i>
            <span>选择数据表</span>
        </div>
        <div class="step" id="step-2">
            <i class="fas fa-columns step-icon"></i>
            <span>映射字段</span>
        </div>
        <div class="step" id="step-3">
            <i class="fas fa-check-circle step-icon"></i>
            <span>确认配置</span>
        </div>
    </div>
    
    <!-- 步骤1: 数据表选择 -->
    <div id="table-selection-step" class="step-content">
        <div class="table-selection">
            <!-- 源表选择 -->
            <div class="table-selector">
                <div class="selector-header">
                    <i class="fas fa-database selector-icon"></i>
                    <div>
                        <h4 style="margin: 0;">选择源数据表</h4>
                        <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 14px;">选择一个作为映射源的数据表</p>
                    </div>
                </div>
                <div class="table-list" id="source-table-list">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <span>正在加载数据表...</span>
                    </div>
                </div>
            </div>
            
            <!-- 目标表选择 -->
            <div class="table-selector target">
                <div class="selector-header target">
                    <i class="fas fa-crosshairs selector-icon"></i>
                    <div>
                        <h4 style="margin: 0;">选择目标数据表</h4>
                        <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 14px;">选择一个或多个目标数据表</p>
                    </div>
                </div>
                <div class="table-list" id="target-table-list">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <span>正在加载数据表...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="action-btn primary" id="proceed-to-mapping" disabled>
                <i class="fas fa-arrow-right"></i> 开始字段映射
            </button>
        </div>
    </div>
    
    <!-- 步骤2: 字段映射 -->
    <div id="field-mapping-step" class="step-content" style="display: none;">
        <div class="mapping-workspace-main">
            <div class="mapping-header">
                <h3 id="mapping-title">字段映射配置</h3>
                <p style="color: #6c757d; margin: 10px 0 0 0;">
                    左侧选择源字段，右侧选择目标字段，点击中间按钮创建映射关系。系统会提供相似性建议供参考。
                </p>
            </div>
            
            <div class="mapping-layout">
                <!-- 源字段面板 -->
                <div class="field-panel source">
                    <div class="panel-header source">
                        <i class="fas fa-list panel-icon"></i>
                        <div>
                            <h5 style="margin: 0;">源字段</h5>
                            <p style="margin: 5px 0 0 0; font-size: 12px; font-weight: normal;" id="source-table-name">请选择源表</p>
                        </div>
                    </div>
                    <div class="field-list" id="source-fields">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            <span>请先选择数据表</span>
                        </div>
                    </div>
                </div>
                
                <!-- 映射连接器 -->
                <div class="mapping-connector">
                    <div class="mapping-actions">
                        <button class="mapping-btn create" id="create-mapping" disabled title="创建映射关系">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="mapping-btn remove" id="remove-mapping" disabled title="删除映射关系">
                            <i class="fas fa-times"></i>
                        </button>
                        <button class="mapping-btn auto" id="auto-suggest" disabled title="智能建议">
                            <i class="fas fa-magic"></i>
                        </button>
                    </div>
                    
                    <div style="text-align: center; color: #6c757d; font-size: 12px;">
                        <div>映射操作</div>
                        <div style="margin-top: 5px;">
                            <i class="fas fa-arrow-left"></i>
                            <i class="fas fa-arrow-right"></i>
                        </div>
                    </div>
                </div>
                
                <!-- 目标字段面板 -->
                <div class="field-panel target">
                    <div class="panel-header target">
                        <i class="fas fa-bullseye panel-icon"></i>
                        <div>
                            <h5 style="margin: 0;">目标字段</h5>
                            <p style="margin: 5px 0 0 0; font-size: 12px; font-weight: normal;" id="target-table-name">请选择目标表</p>
                        </div>
                    </div>
                    <div class="field-list" id="target-fields">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            <span>请先选择数据表</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 映射关系显示 -->
            <div class="mapping-relations" id="mapping-relations">
                <h6 style="margin: 0 0 15px 0; color: #6c757d;">
                    <i class="fas fa-link"></i> 映射关系 (<span id="mapping-count">0</span>)
                </h6>
                <div id="relations-list">
                    <p style="text-align: center; color: #6c757d; margin: 20px 0;">尚未创建任何映射关系</p>
                </div>
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="action-btn secondary" id="back-to-tables">
                <i class="fas fa-arrow-left"></i> 返回表选择
            </button>
            <button class="action-btn success" id="confirm-mapping" disabled>
                <i class="fas fa-check"></i> 确认映射配置
            </button>
        </div>
    </div>
    
    <!-- 步骤3: 确认配置 -->
    <div id="confirmation-step" class="step-content" style="display: none;">
        <div class="mapping-workspace-main">
            <div class="mapping-header">
                <h3><i class="fas fa-check-circle" style="color: #28a745;"></i> 映射配置确认</h3>
                <p style="color: #6c757d; margin: 10px 0 0 0;">
                    请确认以下映射配置，确认后将保存配置并可用于数据匹配。
                </p>
            </div>
            
            <div id="configuration-summary">
                <!-- 配置摘要将在这里显示 -->
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="action-btn secondary" id="back-to-mapping">
                <i class="fas fa-edit"></i> 修改映射
            </button>
            <button class="action-btn success" id="save-configuration">
                <i class="fas fa-save"></i> 保存配置
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 全局变量
let selectedSourceTable = null;
let selectedTargetTables = [];
let currentTargetTable = null;
let sourceFields = [];
let targetFields = [];
let selectedSourceField = null;
let selectedTargetField = null;
let mappingRelations = [];
let allTables = [];

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    loadDatabaseTables();
    initializeEventListeners();
});

// 加载数据库表列表
async function loadDatabaseTables() {
    try {
        const response = await fetch('/api/database_tables');
        const data = await response.json();
        
        if (data.success) {
            allTables = data.tables;
            displayTableLists(data.tables);
        } else {
            showError('加载数据表失败: ' + data.error);
        }
    } catch (error) {
        showError('加载数据表时发生错误: ' + error.message);
    }
}

// 显示表列表
function displayTableLists(tables) {
    const sourceList = document.getElementById('source-table-list');
    const targetList = document.getElementById('target-table-list');
    
    const tableHtml = tables.map(table => `
        <div class="table-item" data-table="${table.name}" onclick="selectTable('${table.name}', this)">
            <div class="table-name">${table.name}</div>
            <div class="table-meta">
                ${table.count.toLocaleString()} 条记录 | ${table.fields} 个字段
            </div>
        </div>
    `).join('');
    
    sourceList.innerHTML = tableHtml;
    
    // 目标表列表（支持多选）
    const targetTableHtml = tables.map(table => `
        <div class="table-item target" data-table="${table.name}" onclick="selectTargetTable('${table.name}', this)">
            <div class="table-name">${table.name}</div>
            <div class="table-meta">
                ${table.count.toLocaleString()} 条记录 | ${table.fields} 个字段
            </div>
        </div>
    `).join('');
    
    targetList.innerHTML = targetTableHtml;
}

// 选择源表
function selectTable(tableName, element) {
    // 清除之前的选择
    document.querySelectorAll('#source-table-list .table-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // 选中当前表
    element.classList.add('selected');
    selectedSourceTable = tableName;
    
    updateProceedButton();
}

// 选择目标表（支持多选）
function selectTargetTable(tableName, element) {
    if (element.classList.contains('selected')) {
        // 取消选择
        element.classList.remove('selected');
        selectedTargetTables = selectedTargetTables.filter(t => t !== tableName);
    } else {
        // 选择表
        element.classList.add('selected');
        if (!selectedTargetTables.includes(tableName)) {
            selectedTargetTables.push(tableName);
        }
    }
    
    updateProceedButton();
}

// 更新进入映射步骤的按钮状态
function updateProceedButton() {
    const proceedBtn = document.getElementById('proceed-to-mapping');
    const canProceed = selectedSourceTable && selectedTargetTables.length > 0;
    
    proceedBtn.disabled = !canProceed;
    
    if (canProceed) {
        proceedBtn.innerHTML = `
            <i class="fas fa-arrow-right"></i> 
            开始映射 (${selectedSourceTable} → ${selectedTargetTables.length}个目标表)
        `;
    } else {
        proceedBtn.innerHTML = '<i class="fas fa-arrow-right"></i> 开始字段映射';
    }
}

// 初始化事件监听器
function initializeEventListeners() {
    // 进入映射步骤
    document.getElementById('proceed-to-mapping').addEventListener('click', proceedToMapping);
    
    // 返回表选择
    document.getElementById('back-to-tables').addEventListener('click', backToTableSelection);
    
    // 映射操作按钮
    document.getElementById('create-mapping').addEventListener('click', createMapping);
    document.getElementById('remove-mapping').addEventListener('click', removeMapping);
    document.getElementById('auto-suggest').addEventListener('click', autoSuggestMappings);
    
    // 确认映射
    document.getElementById('confirm-mapping').addEventListener('click', confirmMapping);
    
    // 返回映射步骤
    document.getElementById('back-to-mapping').addEventListener('click', backToMapping);
    
    // 保存配置
    document.getElementById('save-configuration').addEventListener('click', saveConfiguration);
}

// 进入映射步骤
async function proceedToMapping() {
    // 更新步骤指示器
    updateStepIndicator(2);
    
    // 切换显示内容
    document.getElementById('table-selection-step').style.display = 'none';
    document.getElementById('field-mapping-step').style.display = 'block';
    
    // 加载第一个目标表的字段
    if (selectedTargetTables.length > 0) {
        currentTargetTable = selectedTargetTables[0];
        await loadTableFields();
    }
}

// 加载表字段
async function loadTableFields() {
    try {
        // 调试信息
        console.log('加载表字段:', {
            selectedSourceTable: selectedSourceTable,
            currentTargetTable: currentTargetTable
        });
        
        if (!selectedSourceTable || !currentTargetTable) {
            showError('表名未正确设置: ' + JSON.stringify({
                selectedSourceTable: selectedSourceTable,
                currentTargetTable: currentTargetTable
            }));
            return;
        }
        
        // 更新界面显示
        document.getElementById('source-table-name').textContent = selectedSourceTable;
        document.getElementById('target-table-name').textContent = currentTargetTable;
        document.getElementById('mapping-title').textContent = 
            `${selectedSourceTable} → ${currentTargetTable}`;
        
        // 显示加载状态
        document.getElementById('source-fields').innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><span>正在加载字段...</span></div>';
        document.getElementById('target-fields').innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><span>正在加载字段...</span></div>';
        
        // 并行加载源表和目标表的字段
        const [sourceResponse, targetResponse] = await Promise.all([
            fetch('/api/get_table_fields', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ table_name: selectedSourceTable })
            }),
            fetch('/api/get_table_fields', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ table_name: currentTargetTable })
            })
        ]);
        
        const sourceData = await sourceResponse.json();
        const targetData = await targetResponse.json();
        
        console.log('API响应:', {
            sourceData: sourceData,
            targetData: targetData
        });
        
        if (sourceData.success && targetData.success) {
            sourceFields = sourceData.fields;
            targetFields = targetData.fields;
            
            console.log('字段数据:', {
                sourceFields: sourceFields,
                targetFields: targetFields
            });
            
            displayFields();
            
            // 启用映射操作按钮
            document.getElementById('auto-suggest').disabled = false;
        } else {
            throw new Error('字段加载失败');
        }
        
    } catch (error) {
        showError('加载字段时发生错误: ' + error.message);
    }
}

// 显示字段列表
function displayFields() {
    displaySourceFields();
    displayTargetFields();
}

// 显示源字段
function displaySourceFields() {
    const container = document.getElementById('source-fields');
    
    const fieldsHtml = sourceFields.map(field => `
        <div class="field-item" data-field="${field.name}" onclick="selectSourceField('${field.name}', this)">
            <div class="field-name">${field.name}</div>
            <span class="field-type">${field.type}</span>
        </div>
    `).join('');
    
    container.innerHTML = fieldsHtml;
}

// 显示目标字段
function displayTargetFields() {
    const container = document.getElementById('target-fields');
    
    const fieldsHtml = targetFields.map(field => {
        const similarity = calculateSimilarity(selectedSourceField, field.name);
        let similarityHtml = '';
        
        if (selectedSourceField && similarity > 0.3) {
            const scoreClass = similarity > 0.8 ? 'high' : similarity > 0.6 ? 'medium' : 'low';
            similarityHtml = `<span class="similarity-score ${scoreClass}">${Math.round(similarity * 100)}%</span>`;
        }
        
        return `
            <div class="field-item target" data-field="${field.name}" onclick="selectTargetField('${field.name}', this)">
                <div class="field-name">${field.name}</div>
                <span class="field-type">${field.type}</span>
                ${similarityHtml}
            </div>
        `;
    }).join('');
    
    container.innerHTML = fieldsHtml;
}

// 选择源字段
function selectSourceField(fieldName, element) {
    // 清除之前的选择
    document.querySelectorAll('#source-fields .field-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // 选中当前字段
    element.classList.add('selected');
    selectedSourceField = fieldName;
    
    // 重新显示目标字段（显示相似性分数）
    displayTargetFields();
    
    updateMappingButtons();
}

// 选择目标字段
function selectTargetField(fieldName, element) {
    // 清除之前的选择
    document.querySelectorAll('#target-fields .field-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // 选中当前字段
    element.classList.add('selected');
    selectedTargetField = fieldName;
    
    updateMappingButtons();
}

// 更新映射按钮状态
function updateMappingButtons() {
    const createBtn = document.getElementById('create-mapping');
    const removeBtn = document.getElementById('remove-mapping');
    
    const canCreate = selectedSourceField && selectedTargetField && 
                     !mappingExists(selectedSourceField, selectedTargetField);
    const canRemove = selectedSourceField && selectedTargetField && 
                     mappingExists(selectedSourceField, selectedTargetField);
    
    createBtn.disabled = !canCreate;
    removeBtn.disabled = !canRemove;
}

// 检查映射是否已存在
function mappingExists(sourceField, targetField) {
    return mappingRelations.some(relation => 
        relation.source === sourceField && 
        relation.target === targetField &&
        relation.targetTable === currentTargetTable
    );
}

// 创建映射关系
function createMapping() {
    if (!selectedSourceField || !selectedTargetField) return;
    
    const relation = {
        source: selectedSourceField,
        target: selectedTargetField,
        targetTable: currentTargetTable,
        similarity: calculateSimilarity(selectedSourceField, selectedTargetField)
    };
    
    mappingRelations.push(relation);
    
    // 更新界面
    updateFieldStates();
    displayMappingRelations();
    updateMappingButtons();
    updateConfirmButton();
    
    // 清除选择
    clearFieldSelections();
}

// 删除映射关系
function removeMapping() {
    if (!selectedSourceField || !selectedTargetField) return;
    
    mappingRelations = mappingRelations.filter(relation => 
        !(relation.source === selectedSourceField && 
          relation.target === selectedTargetField &&
          relation.targetTable === currentTargetTable)
    );
    
    // 更新界面
    updateFieldStates();
    displayMappingRelations();
    updateMappingButtons();
    updateConfirmButton();
}

// 智能建议映射
async function autoSuggestMappings() {
    try {
        const response = await fetch('/api/suggest_field_mappings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                source_table: selectedSourceTable,
                target_table: currentTargetTable,
                source_fields: sourceFields.map(f => f.name),
                target_fields: targetFields.map(f => f.name)
            })
        });
        
        const data = await response.json();
        
        if (data.success && data.suggestions.length > 0) {
            // 显示建议对话框
            showSuggestionDialog(data.suggestions);
        } else {
            showInfo('未找到合适的映射建议');
        }
    } catch (error) {
        showError('获取映射建议时发生错误: ' + error.message);
    }
}

// 计算字段名相似度（简单实现）
function calculateSimilarity(field1, field2) {
    if (!field1 || !field2) return 0;
    
    field1 = field1.toLowerCase();
    field2 = field2.toLowerCase();
    
    // 完全匹配
    if (field1 === field2) return 1.0;
    
    // 包含关系
    if (field1.includes(field2) || field2.includes(field1)) return 0.8;
    
    // 简单的字符串相似度（可以后续优化）
    const maxLength = Math.max(field1.length, field2.length);
    const distance = levenshteinDistance(field1, field2);
    return Math.max(0, (maxLength - distance) / maxLength);
}

// 计算编辑距离
function levenshteinDistance(str1, str2) {
    const matrix = [];
    
    for (let i = 0; i <= str2.length; i++) {
        matrix[i] = [i];
    }
    
    for (let j = 0; j <= str1.length; j++) {
        matrix[0][j] = j;
    }
    
    for (let i = 1; i <= str2.length; i++) {
        for (let j = 1; j <= str1.length; j++) {
            if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i - 1][j - 1] + 1,
                    matrix[i][j - 1] + 1,
                    matrix[i - 1][j] + 1
                );
            }
        }
    }
    
    return matrix[str2.length][str1.length];
}

// 更新字段状态显示
function updateFieldStates() {
    // 更新源字段状态
    document.querySelectorAll('#source-fields .field-item').forEach(item => {
        const fieldName = item.dataset.field;
        const isMapped = mappingRelations.some(r => r.source === fieldName);
        item.classList.toggle('mapped', isMapped);
    });
    
    // 更新目标字段状态
    document.querySelectorAll('#target-fields .field-item').forEach(item => {
        const fieldName = item.dataset.field;
        const isMapped = mappingRelations.some(r => 
            r.target === fieldName && r.targetTable === currentTargetTable
        );
        item.classList.toggle('mapped', isMapped);
    });
}

// 显示映射关系
function displayMappingRelations() {
    const container = document.getElementById('relations-list');
    const countElement = document.getElementById('mapping-count');
    
    const currentRelations = mappingRelations.filter(r => r.targetTable === currentTargetTable);
    countElement.textContent = currentRelations.length;
    
    if (currentRelations.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #6c757d; margin: 20px 0;">尚未创建任何映射关系</p>';
        return;
    }
    
    const relationsHtml = currentRelations.map((relation, index) => `
        <div class="mapping-relation">
            <div class="relation-fields">
                <span class="relation-source">${relation.source}</span>
                <i class="fas fa-arrow-right relation-arrow"></i>
                <span class="relation-target">${relation.target}</span>
                ${relation.similarity > 0.5 ? `<small style="margin-left: 10px; color: #28a745;">(${Math.round(relation.similarity * 100)}%)</small>` : ''}
            </div>
            <button class="relation-remove" onclick="removeRelation(${index})">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
    
    container.innerHTML = relationsHtml;
}

// 删除指定映射关系
function removeRelation(index) {
    const currentRelations = mappingRelations.filter(r => r.targetTable === currentTargetTable);
    const relationToRemove = currentRelations[index];
    
    mappingRelations = mappingRelations.filter(r => 
        !(r.source === relationToRemove.source && 
          r.target === relationToRemove.target &&
          r.targetTable === relationToRemove.targetTable)
    );
    
    updateFieldStates();
    displayMappingRelations();
    updateConfirmButton();
}

// 清除字段选择
function clearFieldSelections() {
    document.querySelectorAll('.field-item.selected').forEach(item => {
        item.classList.remove('selected');
    });
    
    selectedSourceField = null;
    selectedTargetField = null;
    updateMappingButtons();
}

// 更新确认按钮状态
function updateConfirmButton() {
    const confirmBtn = document.getElementById('confirm-mapping');
    confirmBtn.disabled = mappingRelations.length === 0;
}

// 返回表选择步骤
function backToTableSelection() {
    updateStepIndicator(1);
    document.getElementById('field-mapping-step').style.display = 'none';
    document.getElementById('table-selection-step').style.display = 'block';
}

// 确认映射配置
function confirmMapping() {
    updateStepIndicator(3);
    document.getElementById('field-mapping-step').style.display = 'none';
    document.getElementById('confirmation-step').style.display = 'block';
    
    displayConfigurationSummary();
}

// 显示配置摘要
function displayConfigurationSummary() {
    const container = document.getElementById('configuration-summary');
    
    const summaryHtml = `
        <div style="background: #f8f9fa; border-radius: 10px; padding: 25px; margin: 20px 0;">
            <h5><i class="fas fa-info-circle" style="color: #007bff;"></i> 映射配置摘要</h5>
            
            <div style="margin: 20px 0;">
                <strong>源数据表：</strong> ${selectedSourceTable}
            </div>
            
            <div style="margin: 20px 0;">
                <strong>目标数据表：</strong> ${selectedTargetTables.join(', ')}
            </div>
            
            <div style="margin: 20px 0;">
                <strong>映射关系数量：</strong> ${mappingRelations.length} 个
            </div>
            
            <div style="margin: 20px 0;">
                <strong>详细映射关系：</strong>
                <div style="background: white; border-radius: 8px; padding: 15px; margin-top: 10px;">
                    ${mappingRelations.map(relation => `
                        <div style="display: flex; align-items: center; margin: 8px 0; padding: 8px; background: #f8f9fa; border-radius: 6px;">
                            <span style="color: #007bff; font-weight: 600;">${relation.source}</span>
                            <i class="fas fa-arrow-right" style="margin: 0 10px; color: #6c757d;"></i>
                            <span style="color: #28a745; font-weight: 600;">${relation.target}</span>
                            <small style="margin-left: 10px; color: #6c757d;">(${relation.targetTable})</small>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = summaryHtml;
}

// 返回映射步骤
function backToMapping() {
    updateStepIndicator(2);
    document.getElementById('confirmation-step').style.display = 'none';
    document.getElementById('field-mapping-step').style.display = 'block';
}

// 保存配置
async function saveConfiguration() {
    try {
        // 转换映射关系数据结构以匹配用户数据匹配页面的期望格式
        const convertedMappings = mappingRelations.map(relation => ({
            source_field: relation.source,
            target_field: relation.target,
            target_table: relation.targetTable,
            similarity_score: relation.similarity,
            data_type: 'auto' // 默认数据类型
        }));
        
        const configuration = {
            source_table: selectedSourceTable,
            target_tables: selectedTargetTables,
            mappings: convertedMappings,
            created_at: new Date().toISOString()
        };
        
        const response = await fetch('/api/save_field_mapping', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(configuration)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess('映射配置保存成功！配置ID: ' + data.config_id);
            // 跳转到用户数据智能匹配页面
            setTimeout(() => {
                window.location.href = '/user_data_matching?config_id=' + data.config_id;
            }, 2000);
        } else {
            showError('保存配置失败: ' + data.error);
        }
    } catch (error) {
        showError('保存配置时发生错误: ' + error.message);
    }
}

// 更新步骤指示器
function updateStepIndicator(currentStep) {
    for (let i = 1; i <= 3; i++) {
        const stepElement = document.getElementById(`step-${i}`);
        stepElement.classList.remove('active', 'completed');
        
        if (i < currentStep) {
            stepElement.classList.add('completed');
        } else if (i === currentStep) {
            stepElement.classList.add('active');
        }
    }
}

// 工具函数
function showError(message) {
    // 可以使用更好的通知组件
    alert('错误: ' + message);
}

function showSuccess(message) {
    alert('成功: ' + message);
}

function showInfo(message) {
    alert('信息: ' + message);
}

function showSuggestionDialog(suggestions) {
    // 可以实现一个更好的建议对话框
    const message = '系统建议以下映射关系：\n\n' + 
                   suggestions.map(s => `${s.source} → ${s.target} (${Math.round(s.similarity * 100)}%)`).join('\n') +
                   '\n\n是否要应用这些建议？';
    
    if (confirm(message)) {
        // 应用建议
        suggestions.forEach(suggestion => {
            if (!mappingExists(suggestion.source, suggestion.target)) {
                mappingRelations.push({
                    source: suggestion.source,
                    target: suggestion.target,
                    targetTable: currentTargetTable,
                    similarity: suggestion.similarity
                });
            }
        });
        
        updateFieldStates();
        displayMappingRelations();
        updateConfirmButton();
    }
}
</script>
{% endblock %}
