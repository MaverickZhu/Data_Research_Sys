{% extends "base.html" %}

{% block title %}知识图谱构建 - 智能关联匹配系统V2.0{% endblock %}

{% block extra_css %}
<style>
    .builder-container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
    }
    
    .step-indicator {
        display: flex;
        justify-content: center;
        margin: 30px 0;
    }
    
    .step {
        padding: 10px 20px;
        background: #e9ecef;
        color: #6c757d;
        border-radius: 20px;
        margin: 0 5px;
        font-size: 14px;
        font-weight: 600;
    }
    
    .step.active {
        background: #007bff;
        color: white;
    }
    
    .step.completed {
        background: #28a745;
        color: white;
    }
    
    .config-section {
        background: white;
        border-radius: 10px;
        padding: 30px;
        margin: 20px 0;
        box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        border-left: 5px solid #007bff;
    }
    
    .section-header {
        display: flex;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f8f9fa;
    }
    
    .section-title {
        font-size: 22px;
        font-weight: 600;
        color: #333;
        margin: 0;
        margin-left: 10px;
    }
    
    .section-icon {
        font-size: 26px;
        color: #007bff;
    }
    
    .config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 25px;
    }
    
    .config-card {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        transition: all 0.3s ease;
    }
    
    .config-card:hover {
        border-color: #007bff;
        box-shadow: 0 4px 12px rgba(0,123,255,0.15);
    }
    
    .card-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .card-icon {
        font-size: 20px;
        color: #007bff;
        margin-right: 10px;
    }
    
    .card-title {
        font-weight: 600;
        color: #333;
        margin: 0;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
        font-size: 14px;
    }
    
    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s ease;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
    }
    
    .form-range {
        width: 100%;
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        outline: none;
    }
    
    .range-value {
        display: inline-block;
        background: #007bff;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 10px;
    }
    
    .checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }
    
    .checkbox-item {
        display: flex;
        align-items: center;
        padding: 8px;
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .checkbox-item:hover {
        background: #f8f9fa;
        border-color: #007bff;
    }
    
    .checkbox-item input[type="checkbox"] {
        margin-right: 8px;
    }
    
    .build-progress {
        background: white;
        border-radius: 10px;
        padding: 30px;
        margin: 20px 0;
        box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        display: none;
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .progress-header {
        text-align: center;
        margin-bottom: 30px;
    }
    
    .progress-title {
        font-size: 24px;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
    }
    
    .progress-subtitle {
        color: #666;
        font-size: 16px;
    }
    
    .progress-steps {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 30px 0;
    }
    
    .progress-step {
        text-align: center;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }
    
    .progress-step.active {
        border-color: #007bff;
        background: #e7f3ff;
    }
    
    .progress-step.completed {
        border-color: #28a745;
        background: #d4edda;
    }
    
    .step-icon {
        font-size: 32px;
        margin-bottom: 10px;
        color: #6c757d;
    }
    
    .progress-step.active .step-icon {
        color: #007bff;
        animation: pulse 2s infinite;
    }
    
    .progress-step.completed .step-icon {
        color: #28a745;
        animation: bounce 0.6s ease-out;
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-10px); }
        60% { transform: translateY(-5px); }
    }
    
    .step-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
    }
    
    .step-status {
        font-size: 12px;
        color: #666;
    }
    
    .overall-progress {
        margin: 30px 0;
    }
    
    .progress-bar-container {
        background: #e9ecef;
        border-radius: 10px;
        height: 20px;
        overflow: hidden;
        margin: 15px 0;
    }
    
    .progress-bar {
        height: 100%;
        background: linear-gradient(45deg, #007bff, #0056b3);
        width: 0%;
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: 600;
    }
    
    .progress-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }
    
    .stat-card {
        background: white;
        padding: 15px;
        border-radius: 6px;
        text-align: center;
        border: 1px solid #e9ecef;
    }
    
    .stat-number {
        font-size: 20px;
        font-weight: 700;
        color: #007bff;
    }
    
    .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        margin-top: 5px;
    }
    
    .build-log {
        background: #2d3748;
        color: #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        max-height: 300px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.4;
        margin: 20px 0;
    }
    
    .log-entry {
        margin: 2px 0;
        padding: 2px 0;
    }
    
    .log-timestamp {
        color: #a0aec0;
        margin-right: 10px;
    }
    
    .log-level-info {
        color: #63b3ed;
    }
    
    .log-level-success {
        color: #68d391;
    }
    
    .log-level-warning {
        color: #fbb55c;
    }
    
    .log-level-error {
        color: #fc8181;
    }
    
    .action-buttons {
        text-align: center;
        margin: 30px 0;
        padding: 20px 0;
        border-top: 2px solid #f8f9fa;
    }
    
    .btn-action {
        padding: 15px 40px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 0 10px;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-primary {
        background: linear-gradient(45deg, #007bff, #0056b3);
        color: white;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-success {
        background: linear-gradient(45deg, #28a745, #1e7e34);
        color: white;
    }
    
    .btn-warning {
        background: linear-gradient(45deg, #ffc107, #e0a800);
        color: #212529;
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        text-decoration: none;
        color: inherit;
    }
    
    .btn-action:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        opacity: 0.6;
    }
    
    .results-section {
        background: white;
        border-radius: 10px;
        padding: 30px;
        margin: 20px 0;
        box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        display: none;
    }
    
    .results-header {
        text-align: center;
        margin-bottom: 30px;
    }
    
    .results-title {
        font-size: 28px;
        font-weight: 600;
        color: #28a745;
        margin-bottom: 10px;
    }
    
    .results-subtitle {
        color: #666;
        font-size: 16px;
    }
    
    .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 30px 0;
    }
    
    .result-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        border: 1px solid #e9ecef;
    }
    
    .result-number {
        font-size: 32px;
        font-weight: 700;
        color: #007bff;
        margin-bottom: 10px;
    }
    
    .result-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
    }
    
    .result-desc {
        font-size: 12px;
        color: #666;
    }
    
    .error-section {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        display: none;
    }
    
    .error-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .error-icon {
        font-size: 24px;
        color: #721c24;
        margin-right: 10px;
    }
    
    .error-title {
        font-weight: 600;
        color: #721c24;
        margin: 0;
    }
    
    .error-message {
        color: #721c24;
        margin: 10px 0;
    }
    
    .error-details {
        background: #ffffff;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
        padding: 15px;
        margin: 10px 0;
        font-family: monospace;
        font-size: 13px;
        color: #495057;
        max-height: 200px;
        overflow-y: auto;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .building {
        animation: pulse 2s infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 步骤指示器 -->
    <div class="step-indicator">
        <div class="step completed">1. 数据上传</div>
        <div class="step completed">2. 数据分析</div>
        <div class="step completed">3. 字段映射</div>
        <div class="step active">4. 知识图谱构建</div>
    </div>
    
    <div class="builder-container">
        <!-- 构建配置区域 -->
        <div class="config-section" id="configSection">
            <div class="section-header">
                <i class="fas fa-cogs section-icon"></i>
                <h3 class="section-title">知识图谱构建配置</h3>
            </div>
            
            <div class="config-grid">
                <!-- 实体抽取配置 -->
                <div class="config-card">
                    <div class="card-header">
                        <i class="fas fa-cubes card-icon"></i>
                        <h4 class="card-title">实体抽取配置</h4>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">置信度阈值</label>
                        <input type="range" class="form-range" id="entityConfidence" 
                               min="0.1" max="1.0" step="0.1" value="0.8">
                        <span class="range-value" id="entityConfidenceValue">0.8</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">启用的实体类型</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" checked> 组织机构
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" checked> 人员姓名
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" checked> 地址位置
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" checked> 标识符
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- 关系抽取配置 -->
                <div class="config-card">
                    <div class="card-header">
                        <i class="fas fa-project-diagram card-icon"></i>
                        <h4 class="card-title">关系抽取配置</h4>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">关系置信度阈值</label>
                        <input type="range" class="form-range" id="relationConfidence" 
                               min="0.1" max="1.0" step="0.1" value="0.7">
                        <span class="range-value" id="relationConfidenceValue">0.7</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">最大关系距离</label>
                        <select class="form-control" id="maxRelationDistance">
                            <option value="1">直接关系</option>
                            <option value="2" selected>二度关系</option>
                            <option value="3">三度关系</option>
                        </select>
                    </div>
                </div>
                
                <!-- 图谱构建配置 -->
                <div class="config-card">
                    <div class="card-header">
                        <i class="fas fa-network-wired card-icon"></i>
                        <h4 class="card-title">图谱构建配置</h4>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">批处理大小</label>
                        <select class="form-control" id="batchSize">
                            <option value="100">100 条/批</option>
                            <option value="500" selected>500 条/批</option>
                            <option value="1000">1000 条/批</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">去重策略</label>
                        <select class="form-control" id="deduplicationStrategy">
                            <option value="strict">严格去重</option>
                            <option value="fuzzy" selected>模糊去重</option>
                            <option value="none">不去重</option>
                        </select>
                    </div>
                </div>
                
                <!-- 输出配置 -->
                <div class="config-card">
                    <div class="card-header">
                        <i class="fas fa-download card-icon"></i>
                        <h4 class="card-title">输出配置</h4>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">输出格式</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" checked> MongoDB存储
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox"> JSON导出
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox"> Cypher脚本
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox"> RDF格式
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 构建进度区域 -->
        <div class="build-progress" id="buildProgress">
            <div class="progress-header">
                <h3 class="progress-title">知识图谱构建中...</h3>
                <p class="progress-subtitle">正在处理您的数据，请耐心等待</p>
            </div>
            
            <!-- 进度步骤 -->
            <div class="progress-steps">
                <div class="progress-step" id="step1">
                    <div class="step-icon">
                        <i class="fas fa-file-import"></i>
                    </div>
                    <div class="step-name">数据加载</div>
                    <div class="step-status">等待中...</div>
                </div>
                <div class="progress-step" id="step2">
                    <div class="step-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="step-name">实体抽取</div>
                    <div class="step-status">等待中...</div>
                </div>
                <div class="progress-step" id="step3">
                    <div class="step-icon">
                        <i class="fas fa-link"></i>
                    </div>
                    <div class="step-name">关系发现</div>
                    <div class="step-status">等待中...</div>
                </div>
                <div class="progress-step" id="step4">
                    <div class="step-icon">
                        <i class="fas fa-network-wired"></i>
                    </div>
                    <div class="step-name">图谱构建</div>
                    <div class="step-status">等待中...</div>
                </div>
                <div class="progress-step" id="step5">
                    <div class="step-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="step-name">质量验证</div>
                    <div class="step-status">等待中...</div>
                </div>
            </div>
            
            <!-- 总体进度条 -->
            <div class="overall-progress">
                <h5>总体进度</h5>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="overallProgressBar">0%</div>
                </div>
            </div>
            
            <!-- 统计信息 -->
            <div class="progress-stats">
                <div class="stat-card">
                    <div class="stat-number" id="processedRecords">0</div>
                    <div class="stat-label">已处理记录</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="extractedEntities">0</div>
                    <div class="stat-label">抽取实体</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="discoveredRelations">0</div>
                    <div class="stat-label">发现关系</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="elapsedTime">00:00</div>
                    <div class="stat-label">耗时</div>
                </div>
            </div>
            
            <!-- 构建结果显示 -->
            <div class="build-result" id="buildResult" style="display: none; text-align: center; margin-top: 30px;">
                <div class="result-success" id="resultSuccess" style="display: none;">
                    <div class="result-icon">
                        <i class="fas fa-check-circle" style="color: #28a745; font-size: 48px;"></i>
                    </div>
                    <h4 style="color: #28a745; margin: 15px 0;">构建完成！</h4>
                    <p class="result-message" id="successMessage">知识图谱构建成功完成</p>
                    <div class="result-actions" style="margin-top: 20px;">
                        <button class="btn btn-primary me-2" onclick="window.location.href='/kg_viewer'">
                            <i class="fas fa-eye"></i> 查看图谱
                        </button>
                        <button class="btn btn-outline-secondary" onclick="resetBuilder()">
                            <i class="fas fa-redo"></i> 重新构建
                        </button>
                    </div>
                </div>
                
                <div class="result-error" id="resultError" style="display: none;">
                    <div class="result-icon">
                        <i class="fas fa-exclamation-triangle" style="color: #dc3545; font-size: 48px;"></i>
                    </div>
                    <h4 style="color: #dc3545; margin: 15px 0;">构建失败</h4>
                    <p class="result-message" id="errorMessage">构建过程中出现错误</p>
                    <div class="result-actions" style="margin-top: 20px;">
                        <button class="btn btn-warning me-2" onclick="resetBuilder()">
                            <i class="fas fa-redo"></i> 重新尝试
                        </button>
                        <button class="btn btn-outline-secondary" onclick="showBuildLog()">
                            <i class="fas fa-list"></i> 查看日志
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 构建日志 -->
            <div class="build-log" id="buildLog">
                <div class="log-entry">
                    <span class="log-timestamp">[等待开始]</span>
                    <span class="log-level-info">知识图谱构建器已就绪</span>
                </div>
            </div>
        </div>
        
        <!-- 构建结果区域 -->
        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <h3 class="results-title">
                    <i class="fas fa-check-circle"></i> 知识图谱构建完成！
                </h3>
                <p class="results-subtitle">您的知识图谱已成功构建并保存</p>
            </div>
            
            <div class="results-grid">
                <div class="result-card">
                    <div class="result-number" id="finalEntityCount">0</div>
                    <div class="result-label">实体总数</div>
                    <div class="result-desc">已识别的实体对象</div>
                </div>
                <div class="result-card">
                    <div class="result-number" id="finalRelationCount">0</div>
                    <div class="result-label">关系总数</div>
                    <div class="result-desc">已发现的关系连接</div>
                </div>
                <div class="result-card">
                    <div class="result-number" id="finalTripleCount">0</div>
                    <div class="result-label">三元组数量</div>
                    <div class="result-desc">知识图谱基本单元</div>
                </div>
                <div class="result-card">
                    <div class="result-number" id="finalQualityScore">0%</div>
                    <div class="result-label">图谱质量</div>
                    <div class="result-desc">自动质量评估结果</div>
                </div>
            </div>
        </div>
        
        <!-- 错误信息区域 -->
        <div class="error-section" id="errorSection">
            <div class="error-header">
                <i class="fas fa-exclamation-triangle error-icon"></i>
                <h4 class="error-title">构建过程出现错误</h4>
            </div>
            <div class="error-message" id="errorMessage">
                <!-- 动态填充错误信息 -->
            </div>
            <div class="error-details" id="errorDetails">
                <!-- 动态填充错误详情 -->
            </div>
        </div>
        
        <!-- 操作按钮 -->
        <div class="action-buttons">
            <a href="#" class="btn-action btn-secondary" id="backBtn">
                <i class="fas fa-arrow-left"></i> 返回映射
            </a>
            <button class="btn-action btn-primary" id="startBuildBtn">
                <i class="fas fa-play"></i> 开始构建
            </button>
            <button class="btn-action btn-warning" id="pauseBuildBtn" style="display: none;">
                <i class="fas fa-pause"></i> 暂停构建
            </button>
            <button class="btn-action btn-secondary" id="stopBuildBtn" style="display: none;">
                <i class="fas fa-stop"></i> 停止构建
            </button>
            <button class="btn-action btn-success" id="viewResultsBtn" style="display: none;">
                <i class="fas fa-eye"></i> 查看结果
            </button>
            <button class="btn-action btn-primary" id="exportBtn" style="display: none;">
                <i class="fas fa-download"></i> 导出图谱
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const fileId = urlParams.get('file_id');
    
    if (!fileId) {
        alert('缺少文件ID参数');
        window.location.href = '/csv_upload';
        return;
    }
    
    // 全局变量
    let buildTask = null;
    let buildTimer = null;
    let elapsedSeconds = 0;
    
    // 初始化
    initializeControls();
    initializeEventListeners();
    
    function initializeControls() {
        // 初始化滑块值显示
        const entityConfidence = document.getElementById('entityConfidence');
        const relationConfidence = document.getElementById('relationConfidence');
        
        entityConfidence.addEventListener('input', function() {
            document.getElementById('entityConfidenceValue').textContent = this.value;
        });
        
        relationConfidence.addEventListener('input', function() {
            document.getElementById('relationConfidenceValue').textContent = this.value;
        });
    }
    
    function initializeEventListeners() {
        // 开始构建按钮
        document.getElementById('startBuildBtn').addEventListener('click', startBuild);
        
        // 暂停构建按钮
        document.getElementById('pauseBuildBtn').addEventListener('click', pauseBuild);
        
        // 停止构建按钮
        document.getElementById('stopBuildBtn').addEventListener('click', stopBuild);
        
        // 查看结果按钮
        document.getElementById('viewResultsBtn').addEventListener('click', viewResults);
        
        // 导出按钮
        document.getElementById('exportBtn').addEventListener('click', exportGraph);
        
        // 返回按钮
        document.getElementById('backBtn').addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = `/field_mapping?file_id=${fileId}`;
        });
    }
    
    async function startBuild() {
        try {
            // 获取构建配置
            const config = getBuildConfig();
            
            // 显示进度区域，隐藏配置区域
            document.getElementById('configSection').style.display = 'none';
            document.getElementById('buildProgress').style.display = 'block';
            
            // 更新按钮状态
            document.getElementById('startBuildBtn').style.display = 'none';
            document.getElementById('pauseBuildBtn').style.display = 'inline-block';
            document.getElementById('stopBuildBtn').style.display = 'inline-block';
            
            // 开始计时
            startTimer();
            
            // 调用构建API
            const response = await fetch('/api/build_knowledge_graph', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    file_id: fileId,
                    config: config
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                buildTask = result.task_id;
                // 开始计时
                startTimer();
                // 开始监控构建进度
                monitorBuildProgress();
            } else {
                showError('构建启动失败', result.error);
            }
        } catch (error) {
            showError('构建启动错误', error.message);
        }
    }
    
    function getBuildConfig() {
        return {
            entity_extraction: {
                confidence_threshold: parseFloat(document.getElementById('entityConfidence').value),
                enabled_types: getEnabledEntityTypes()
            },
            relation_extraction: {
                confidence_threshold: parseFloat(document.getElementById('relationConfidence').value),
                max_distance: parseInt(document.getElementById('maxRelationDistance').value)
            },
            graph_building: {
                batch_size: parseInt(document.getElementById('batchSize').value),
                deduplication_strategy: document.getElementById('deduplicationStrategy').value
            },
            output: {
                formats: getEnabledOutputFormats()
            }
        };
    }
    
    function getEnabledEntityTypes() {
        const checkboxes = document.querySelectorAll('.config-card:first-child .checkbox-group input[type="checkbox"]');
        const types = [];
        checkboxes.forEach((checkbox, index) => {
            if (checkbox.checked) {
                const typeMap = ['organization', 'person', 'address', 'identifier'];
                types.push(typeMap[index]);
            }
        });
        return types;
    }
    
    function getEnabledOutputFormats() {
        const checkboxes = document.querySelectorAll('.config-card:last-child .checkbox-group input[type="checkbox"]');
        const formats = [];
        checkboxes.forEach((checkbox, index) => {
            if (checkbox.checked) {
                const formatMap = ['mongodb', 'json', 'cypher', 'rdf'];
                formats.push(formatMap[index]);
            }
        });
        return formats;
    }
    
    async function monitorBuildProgress() {
        if (!buildTask) return;
        
        try {
            const response = await fetch(`/api/kg_build_progress/${buildTask}`);
            const result = await response.json();
            
            if (result.success) {
                updateProgressDisplay(result.data);
                
                if (result.data.status === 'completed') {
                    onBuildCompleted(result.data);
                } else if (result.data.status === 'failed') {
                    onBuildFailed(result.data);
                } else {
                    // 继续监控
                    setTimeout(monitorBuildProgress, 2000);
                }
            } else {
                showError('获取进度失败', result.error);
            }
        } catch (error) {
            console.error('监控进度错误:', error);
            setTimeout(monitorBuildProgress, 5000); // 出错后延长轮询间隔
        }
    }
    
    function updateProgressDisplay(progressData) {
        // 更新步骤状态
        updateStepStatus(progressData.current_step, progressData.steps);
        
        // 更新总体进度条
        const progressBar = document.getElementById('overallProgressBar');
        progressBar.style.width = progressData.overall_progress + '%';
        progressBar.textContent = progressData.overall_progress + '%';
        
        // 更新统计信息
        document.getElementById('processedRecords').textContent = progressData.processed_records || 0;
        document.getElementById('extractedEntities').textContent = progressData.extracted_entities || 0;
        document.getElementById('discoveredRelations').textContent = progressData.discovered_relations || 0;
        
        // 更新耗时 - 使用前端计时器，不依赖后端elapsed_time
        // 时间已经通过startTimer()自动更新
        
        // 检查是否完成
        if (progressData.status === 'completed') {
            onBuildCompleted(progressData);
        } else if (progressData.status === 'failed') {
            onBuildFailed({error_message: progressData.error_message});
        }
        
        // 更新日志
        if (progressData.logs) {
            updateBuildLog(progressData.logs);
        }
    }
    
    function updateStepStatus(currentStep, steps) {
        const stepElements = ['step1', 'step2', 'step3', 'step4', 'step5'];
        
        stepElements.forEach((stepId, index) => {
            const stepElement = document.getElementById(stepId);
            const stepNumber = index + 1;
            
            if (stepNumber < currentStep) {
                // 已完成步骤
                stepElement.className = 'progress-step completed';
                stepElement.querySelector('.step-status').textContent = '已完成';
            } else if (stepNumber === currentStep) {
                // 当前步骤
                stepElement.className = 'progress-step active building';
                stepElement.querySelector('.step-status').textContent = '进行中...';
            } else {
                // 未开始步骤
                stepElement.className = 'progress-step';
                stepElement.querySelector('.step-status').textContent = '等待中...';
            }
        });
    }
    
    function updateBuildLog(newLogs) {
        const logContainer = document.getElementById('buildLog');
        
        newLogs.forEach(log => {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const timestamp = new Date(log.timestamp).toLocaleTimeString();
            const levelClass = `log-level-${log.level}`;
            
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="${levelClass}">${log.message}</span>
            `;
            
            logContainer.appendChild(logEntry);
        });
        
        // 滚动到底部
        logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    function onBuildCompleted(progressData) {
        // 停止计时
        stopTimer();
        
        // 获取最终构建结果
        fetch(`/api/kg_build_result/${buildTask}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const result = data.result;
                    
                    // 隐藏进度区域，显示结果区域
                    document.getElementById('buildProgress').style.display = 'none';
                    document.getElementById('resultsSection').style.display = 'block';
                    
                    // 更新结果显示
                    document.getElementById('finalEntityCount').textContent = result.total_entities || 0;
                    document.getElementById('finalRelationCount').textContent = result.total_relations || 0;
                    document.getElementById('finalTripleCount').textContent = result.total_triples || 0;
                    document.getElementById('finalQualityScore').textContent = '100%'; // 构建成功默认100%
                    
                    // 更新按钮状态
                    document.getElementById('pauseBuildBtn').style.display = 'none';
                    document.getElementById('stopBuildBtn').style.display = 'none';
                    document.getElementById('viewResultsBtn').style.display = 'inline-block';
                    document.getElementById('exportBtn').style.display = 'inline-block';
                    
                    // 添加完成日志
                    updateBuildLog([{
                        timestamp: new Date().toISOString(),
                        level: 'success',
                        message: `知识图谱构建完成！共生成 ${result.total_entities} 个实体，${result.total_relations || 0} 个关系`
                    }]);
                } else {
                    console.error('获取构建结果失败:', data.error);
                    onBuildFailed({error_message: '获取构建结果失败'});
                }
            })
            .catch(error => {
                console.error('获取构建结果错误:', error);
                onBuildFailed({error_message: '网络错误'});
            });
    }
    
    function onBuildFailed(data) {
        // 停止计时
        stopTimer();
        
        // 显示错误信息
        showError('构建失败', data.error_message, data.error_details);
        
        // 重置按钮状态
        resetButtonState();
    }
    
    function showError(title, message, details = null) {
        document.getElementById('errorSection').style.display = 'block';
        document.getElementById('errorMessage').textContent = message;
        
        if (details) {
            document.getElementById('errorDetails').textContent = details;
            document.getElementById('errorDetails').style.display = 'block';
        } else {
            document.getElementById('errorDetails').style.display = 'none';
        }
        
        // 添加错误日志
        updateBuildLog([{
            timestamp: new Date().toISOString(),
            level: 'error',
            message: `${title}: ${message}`
        }]);
    }
    
    function pauseBuild() {
        // 实现暂停逻辑
        alert('暂停功能开发中...');
    }
    
    function stopBuild() {
        if (confirm('确定要停止构建吗？当前进度将丢失。')) {
            // 实现停止逻辑
            stopTimer();
            resetButtonState();
            buildTask = null;
            
            updateBuildLog([{
                timestamp: new Date().toISOString(),
                level: 'warning',
                message: '用户手动停止了构建过程'
            }]);
        }
    }
    
    function viewResults() {
        // 跳转到结果查看页面
        window.location.href = `/kg_results?file_id=${fileId}&task_id=${buildTask}`;
    }
    
    function exportGraph() {
        // 实现导出功能
        window.open(`/api/export_knowledge_graph/${buildTask}`, '_blank');
    }
    
    function startTimer() {
        elapsedSeconds = 0;
        buildTimer = setInterval(() => {
            elapsedSeconds++;
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            document.getElementById('elapsedTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
    }
    
    function stopTimer() {
        if (buildTimer) {
            clearInterval(buildTimer);
            buildTimer = null;
        }
    }
    
    function resetButtonState() {
        document.getElementById('startBuildBtn').style.display = 'inline-block';
        document.getElementById('pauseBuildBtn').style.display = 'none';
        document.getElementById('stopBuildBtn').style.display = 'none';
        document.getElementById('viewResultsBtn').style.display = 'none';
        document.getElementById('exportBtn').style.display = 'none';
        
        document.getElementById('configSection').style.display = 'block';
        document.getElementById('buildProgress').style.display = 'none';
    }
});
</script>
{% endblock %}
