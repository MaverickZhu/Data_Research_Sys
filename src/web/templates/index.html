<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¶ˆé˜²å•ä½å»ºç­‘æ•°æ®å…³è”ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .stats-card {
            transition: transform 0.2s;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .progress-ring {
            width: 120px;
            height: 120px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-running { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-fire"></i> æ¶ˆé˜²æ•°æ®å…³è”ç³»ç»Ÿ
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="/">é¦–é¡µ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/matching">åŒ¹é…ç®¡ç†</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/results">åŒ¹é…ç»“æœ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/statistics">æ•°æ®ç»Ÿè®¡</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- é¡µå¤´ -->
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="mb-3"><i class="bi bi-speedometer2"></i> ç³»ç»Ÿæ¦‚è§ˆ</h1>
                    <p class="lead mb-0">æ¶ˆé˜²ç›‘ç£ç®¡ç†ç³»ç»Ÿä¸å®‰å…¨æ’æŸ¥ç³»ç»Ÿæ•°æ®å…³è”åŒ¹é…</p>
                </div>
                <div class="col-md-6 text-end">
                    <div class="row text-center">
                        <div class="col-4">
                            <h3 class="mb-0" id="totalUnits">{{ stats.data_sources.supervision_count + stats.data_sources.inspection_count }}</h3>
                            <small>æ€»å•ä½æ•°</small>
                        </div>
                        <div class="col-4">
                            <h3 class="mb-0" id="matchedUnits">{{ stats.matching_stats.matched_count or 0 }}</h3>
                            <small>å·²åŒ¹é…</small>
                        </div>
                        <div class="col-4">
                            <h3 class="mb-0" id="matchRate">{{ "%.1f"|format((stats.matching_stats.match_rate or 0) * 100) }}%</h3>
                            <small>åŒ¹é…ç‡</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- ç³»ç»ŸçŠ¶æ€å¡ç‰‡ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-database-fill-check text-primary" style="font-size: 2.5rem;"></i>
                        <h4 class="mt-3">ç›‘ç£ç®¡ç†ç³»ç»Ÿ</h4>
                        <h2 class="text-primary" id="supervisionCount">{{ stats.data_sources.supervision_count or 0 }}</h2>
                        <p class="text-muted">å•ä½æ•°é‡</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-shield-fill-check text-success" style="font-size: 2.5rem;"></i>
                        <h4 class="mt-3">å®‰å…¨æ’æŸ¥ç³»ç»Ÿ</h4>
                        <h2 class="text-success" id="inspectionCount">{{ stats.data_sources.inspection_count or 0 }}</h2>
                        <p class="text-muted">å•ä½æ•°é‡</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-link-45deg text-info" style="font-size: 2.5rem;"></i>
                        <h4 class="mt-3">åŒ¹é…ç»“æœ</h4>
                        <h2 class="text-info" id="matchResultsCount">{{ stats.data_sources.match_results_count or 0 }}</h2>
                        <p class="text-muted">å¤„ç†è®°å½•</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-gear-fill text-warning" style="font-size: 2.5rem;"></i>
                        <h4 class="mt-3">ç³»ç»ŸçŠ¶æ€</h4>
                        <div class="mt-3">
                            <span class="status-indicator status-{{ 'running' if stats.system_info.status == 'running' else 'error' }}"></span>
                            <span>{{ 'è¿è¡Œä¸­' if stats.system_info.status == 'running' else 'å¼‚å¸¸' }}</span>
                        </div>
                        <small class="text-muted d-block mt-2">{{ stats.system_info.last_update }}</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- åŒ¹é…è¿›åº¦å’Œç»Ÿè®¡ -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-bar-chart-line"></i> åŒ¹é…ç»Ÿè®¡åˆ†æ</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="matchStatsChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5><i class="bi bi-pie-chart"></i> åŒ¹é…ç±»å‹åˆ†å¸ƒ</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="matchTypeChart" width="300" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¿«é€Ÿæ“ä½œ -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-lightning-charge"></i> å¿«é€Ÿæ“ä½œ</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <button class="btn btn-primary btn-lg w-100" onclick="startMatching()">
                                    <i class="bi bi-play-circle"></i><br>
                                    å¼€å§‹åŒ¹é…
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-success btn-lg w-100" onclick="viewResults()">
                                    <i class="bi bi-table"></i><br>
                                    æŸ¥çœ‹ç»“æœ
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-info btn-lg w-100" onclick="exportData()">
                                    <i class="bi bi-download"></i><br>
                                    å¯¼å‡ºæ•°æ®
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-warning btn-lg w-100" onclick="systemSettings()">
                                    <i class="bi bi-gear"></i><br>
                                    ç³»ç»Ÿè®¾ç½®
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœ€è¿‘æ´»åŠ¨ -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-clock-history"></i> æœ€è¿‘æ´»åŠ¨</h5>
                    </div>
                    <div class="card-body">
                        <div id="recentActivities">
                            <p class="text-muted">åŠ è½½ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            loadRecentActivities();
            
            // ç«‹å³åŠ è½½ä¸€æ¬¡æ•°æ®
            refreshStats();
            
            // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡æ•°æ®
            setInterval(refreshStats, 30000);
        });

        // å…¨å±€å˜é‡å­˜å‚¨å›¾è¡¨å®ä¾‹
        let matchStatsChart = null;
        let matchTypeChart = null;

        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            // åŒ¹é…ç»Ÿè®¡å›¾è¡¨
            const ctx1 = document.getElementById('matchStatsChart').getContext('2d');
            matchStatsChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['ç²¾ç¡®åŒ¹é…', 'æ¨¡ç³ŠåŒ¹é…', 'æœªåŒ¹é…'],
                    datasets: [{
                        label: 'æ•°é‡',
                        data: [0, 0, 0], // åˆå§‹å€¼ä¸º0ï¼Œç­‰å¾…APIæ•°æ®æ›´æ–°
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(255, 99, 132, 0.8)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // åŒ¹é…ç±»å‹é¥¼å›¾
            const ctx2 = document.getElementById('matchTypeChart').getContext('2d');
            matchTypeChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['ç²¾ç¡®åŒ¹é…', 'æ¨¡ç³ŠåŒ¹é…', 'æœªåŒ¹é…'],
                    datasets: [{
                        data: [0, 0, 0], // åˆå§‹å€¼ä¸º0ï¼Œç­‰å¾…APIæ•°æ®æ›´æ–°
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(255, 99, 132, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // åˆ·æ–°ç»Ÿè®¡æ•°æ®
        function refreshStats() {
            console.log('ğŸ”„ å¼€å§‹åˆ·æ–°ç»Ÿè®¡æ•°æ®...');
            
            fetch('/api/stats')
                .then(response => {
                    console.log('ğŸ“¡ APIå“åº”çŠ¶æ€:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ğŸ“Š æ”¶åˆ°æ•°æ®:', data);
                    updateStatsDisplay(data);
                })
                .catch(error => {
                    console.error('âŒ åˆ·æ–°ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                    // æ˜¾ç¤ºé”™è¯¯æç¤º
                    document.querySelectorAll('[id$="Count"]').forEach(el => {
                        if (el.textContent === 'åŠ è½½ä¸­...') {
                            el.textContent = 'åŠ è½½å¤±è´¥';
                            el.style.color = '#dc3545';
                        }
                    });
                });
        }

        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        function updateStatsDisplay(stats) {
            console.log('ğŸ“Š å¼€å§‹æ›´æ–°ç»Ÿè®¡æ˜¾ç¤ºï¼Œæ•°æ®:', stats);
            
            // æ›´æ–°é¡µå¤´ç»Ÿè®¡
            const totalUnits = (stats.data_sources.supervision_count || 0) + (stats.data_sources.inspection_count || 0);
            document.getElementById('totalUnits').textContent = totalUnits.toLocaleString();
            
            // è®¡ç®—åŒ¹é…æ•°é‡å’ŒåŒ¹é…ç‡
            const totalMatches = stats.matching_stats.total_matches || 0;
            const matchRate = totalUnits > 0 ? (totalMatches / totalUnits * 100).toFixed(1) : 0;
            
            document.getElementById('matchedUnits').textContent = totalMatches.toLocaleString();
            document.getElementById('matchRate').textContent = matchRate + '%';
            
            // æ›´æ–°å¡ç‰‡æ•°æ®
            document.getElementById('supervisionCount').textContent = (stats.data_sources.supervision_count || 0).toLocaleString();
            document.getElementById('inspectionCount').textContent = (stats.data_sources.inspection_count || 0).toLocaleString();
            document.getElementById('matchResultsCount').textContent = (stats.data_sources.match_results_count || 0).toLocaleString();
            
            // æ›´æ–°å›¾è¡¨æ•°æ®
            updateChartData(stats);
            
            console.log('âœ… ç»Ÿè®¡æ•°æ®å·²æ›´æ–°:', stats);
        }

        // æ›´æ–°å›¾è¡¨æ•°æ®
        function updateChartData(stats) {
            console.log('ğŸ“ˆ å¼€å§‹æ›´æ–°å›¾è¡¨æ•°æ®...');
            
            try {
                // ä»APIæ•°æ®ä¸­æå–åŒ¹é…ç»Ÿè®¡
                const matchingStats = stats.matching_stats || {};
                
                // æ ¹æ®ä¿®å¤åçš„APIæ•°æ®ç»“æ„è·å–æ•°æ®
                const exactMatches = matchingStats.exact || 0;
                const fuzzyMatches = matchingStats.fuzzy || 0; 
                const unmatched = matchingStats.none || 0;
                
                console.log('ğŸ“Š å›¾è¡¨æ•°æ®:', { exactMatches, fuzzyMatches, unmatched });
                
                // æ›´æ–°æŸ±çŠ¶å›¾
                if (matchStatsChart) {
                    matchStatsChart.data.datasets[0].data = [exactMatches, fuzzyMatches, unmatched];
                    matchStatsChart.update();
                    console.log('âœ… æŸ±çŠ¶å›¾å·²æ›´æ–°');
                }
                
                // æ›´æ–°é¥¼å›¾
                if (matchTypeChart) {
                    matchTypeChart.data.datasets[0].data = [exactMatches, fuzzyMatches, unmatched];
                    matchTypeChart.update();
                    console.log('âœ… é¥¼å›¾å·²æ›´æ–°');
                }
                
            } catch (error) {
                console.error('âŒ æ›´æ–°å›¾è¡¨æ•°æ®å¤±è´¥:', error);
            }
        }

        // åŠ è½½æœ€è¿‘æ´»åŠ¨
        function loadRecentActivities() {
            const activities = [
                'ç³»ç»Ÿå¯åŠ¨å®Œæˆ',
                'æ•°æ®åº“è¿æ¥æ­£å¸¸',
                'åŒ¹é…ç®—æ³•å·²åŠ è½½',
                'ç­‰å¾…ç”¨æˆ·æ“ä½œ...'
            ];
            
            const activitiesHtml = activities.map(activity => 
                `<div class="d-flex align-items-center mb-2">
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    <span>${activity}</span>
                </div>`
            ).join('');
            
            document.getElementById('recentActivities').innerHTML = activitiesHtml;
        }

        // å¿«é€Ÿæ“ä½œå‡½æ•°
        function startMatching() {
            window.location.href = '/matching';
        }

        function viewResults() {
            window.location.href = '/results';
        }

        function exportData() {
            if (confirm('ç¡®å®šè¦å¯¼å‡ºåŒ¹é…ç»“æœå—ï¼Ÿ')) {
                window.open('/api/export_results?format=excel', '_blank');
            }
        }

        function systemSettings() {
            alert('ç³»ç»Ÿè®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...');
        }
    </script>
</body>
</html>