<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>性能监控仪表板 - 智能关联匹配系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-good { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-critical { background-color: #dc3545; }
        
        .performance-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .alert-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            max-width: 400px;
        }
    </style>
</head>
<body class="bg-light">
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">智能关联匹配系统</a>
            <span class="navbar-text">
                <span class="status-indicator status-good" id="systemStatus"></span>
                系统状态: <span id="systemStatusText">正常</span>
            </span>
        </div>
    </nav>

    <!-- 告警面板 -->
    <div id="alertPanel" class="alert-panel"></div>

    <div class="container-fluid mt-4">
        <!-- 关键指标卡片 -->
        <div class="row">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="processingSpeed">0</div>
                    <div class="metric-label">处理速度 (条/秒)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="memoryUsage">0%</div>
                    <div class="metric-label">内存使用率</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="cpuUsage">0%</div>
                    <div class="metric-label">CPU使用率</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="activeConnections">0</div>
                    <div class="metric-label">活跃连接数</div>
                </div>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>处理速度趋势</h5>
                    <canvas id="speedChart" height="200"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>内存使用趋势</h5>
                    <canvas id="memoryChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>数据库连接池状态</h5>
                    <canvas id="connectionChart" height="200"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>任务执行统计</h5>
                    <canvas id="taskChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- 详细性能表格 -->
        <div class="row">
            <div class="col-12">
                <div class="performance-table">
                    <div class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>指标名称</th>
                                    <th>当前值</th>
                                    <th>平均值</th>
                                    <th>最大值</th>
                                    <th>状态</th>
                                    <th>最后更新</th>
                                </tr>
                            </thead>
                            <tbody id="metricsTable">
                                <!-- 动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 刷新按钮 -->
    <button class="btn btn-primary btn-lg refresh-btn" onclick="refreshData()">
        <i class="fas fa-sync-alt"></i> 刷新
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js"></script>
    
    <script>
        // 图表配置
        const chartConfig = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        };

        // 初始化图表
        const speedChart = new Chart(document.getElementById('speedChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: '处理速度',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.4
                }]
            },
            options: chartConfig
        });

        const memoryChart = new Chart(document.getElementById('memoryChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: '系统内存',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.4
                }, {
                    label: '进程内存',
                    data: [],
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    tension: 0.4
                }]
            },
            options: chartConfig
        });

        const connectionChart = new Chart(document.getElementById('connectionChart'), {
            type: 'doughnut',
            data: {
                labels: ['已使用', '可用'],
                datasets: [{
                    data: [0, 100],
                    backgroundColor: [
                        'rgb(255, 99, 132)',
                        'rgb(75, 192, 192)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        const taskChart = new Chart(document.getElementById('taskChart'), {
            type: 'bar',
            data: {
                labels: ['成功', '失败', '进行中', '等待'],
                datasets: [{
                    label: '任务数量',
                    data: [0, 0, 0, 0],
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(255, 205, 86, 0.8)',
                        'rgba(54, 162, 235, 0.8)'
                    ]
                }]
            },
            options: chartConfig
        });

        // 数据更新函数
        async function fetchPerformanceData() {
            try {
                const response = await fetch('/api/performance_metrics');
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('获取性能数据失败:', error);
                return null;
            }
        }

        function updateMetricCards(data) {
            if (!data) return;

            document.getElementById('processingSpeed').textContent = 
                (data.processing_speed || 0).toFixed(2);
            document.getElementById('memoryUsage').textContent = 
                (data.memory_usage_percent || 0).toFixed(1) + '%';
            document.getElementById('cpuUsage').textContent = 
                (data.cpu_usage_percent || 0).toFixed(1) + '%';
            document.getElementById('activeConnections').textContent = 
                data.active_connections || 0;
        }

        function updateCharts(data) {
            if (!data) return;

            const now = new Date().toLocaleTimeString();

            // 更新速度图表
            if (speedChart.data.labels.length > 20) {
                speedChart.data.labels.shift();
                speedChart.data.datasets[0].data.shift();
            }
            speedChart.data.labels.push(now);
            speedChart.data.datasets[0].data.push(data.processing_speed || 0);
            speedChart.update('none');

            // 更新内存图表
            if (memoryChart.data.labels.length > 20) {
                memoryChart.data.labels.shift();
                memoryChart.data.datasets[0].data.shift();
                memoryChart.data.datasets[1].data.shift();
            }
            memoryChart.data.labels.push(now);
            memoryChart.data.datasets[0].data.push(data.memory_usage_percent || 0);
            memoryChart.data.datasets[1].data.push(data.process_memory_mb || 0);
            memoryChart.update('none');

            // 更新连接池图表
            const usedConnections = data.used_connections || 0;
            const totalConnections = data.total_connections || 100;
            connectionChart.data.datasets[0].data = [
                usedConnections,
                totalConnections - usedConnections
            ];
            connectionChart.update('none');

            // 更新任务统计图表
            const taskStats = data.task_statistics || {};
            taskChart.data.datasets[0].data = [
                taskStats.completed || 0,
                taskStats.failed || 0,
                taskStats.running || 0,
                taskStats.pending || 0
            ];
            taskChart.update('none');
        }

        function updateMetricsTable(data) {
            if (!data || !data.detailed_metrics) return;

            const tbody = document.getElementById('metricsTable');
            tbody.innerHTML = '';

            Object.entries(data.detailed_metrics).forEach(([name, metric]) => {
                const row = tbody.insertRow();
                
                const statusClass = metric.current > metric.threshold ? 'status-critical' : 
                                  metric.current > metric.threshold * 0.8 ? 'status-warning' : 
                                  'status-good';
                
                row.innerHTML = `
                    <td>${metric.display_name || name}</td>
                    <td>${metric.current.toFixed(2)} ${metric.unit || ''}</td>
                    <td>${metric.average.toFixed(2)} ${metric.unit || ''}</td>
                    <td>${metric.max.toFixed(2)} ${metric.unit || ''}</td>
                    <td><span class="status-indicator ${statusClass}"></span>${metric.status}</td>
                    <td>${new Date(metric.last_update).toLocaleTimeString()}</td>
                `;
            });
        }

        function updateSystemStatus(data) {
            if (!data) return;

            const statusIndicator = document.getElementById('systemStatus');
            const statusText = document.getElementById('systemStatusText');

            let status = 'good';
            let text = '正常';

            if (data.memory_usage_percent > 90 || data.cpu_usage_percent > 90) {
                status = 'critical';
                text = '严重';
            } else if (data.memory_usage_percent > 80 || data.cpu_usage_percent > 80) {
                status = 'warning';
                text = '警告';
            }

            statusIndicator.className = `status-indicator status-${status}`;
            statusText.textContent = text;
        }

        function showAlert(message, type = 'warning') {
            const alertPanel = document.getElementById('alertPanel');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertPanel.appendChild(alertDiv);

            // 自动移除告警
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 10000);
        }

        async function refreshData() {
            const data = await fetchPerformanceData();
            
            if (data) {
                updateMetricCards(data);
                updateCharts(data);
                updateMetricsTable(data);
                updateSystemStatus(data);

                // 检查告警条件
                if (data.memory_usage_percent > 90) {
                    showAlert('内存使用率过高！当前: ' + data.memory_usage_percent.toFixed(1) + '%', 'danger');
                }
                if (data.processing_speed < 10) {
                    showAlert('处理速度过低！当前: ' + data.processing_speed.toFixed(2) + ' 条/秒', 'warning');
                }
            } else {
                showAlert('无法获取性能数据，请检查系统状态', 'danger');
            }
        }

        // 初始化和定期更新
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
            
            // 每5秒自动刷新
            setInterval(refreshData, 5000);
        });

        // 手动刷新
        function refreshData() {
            fetchPerformanceData().then(data => {
                if (data) {
                    updateMetricCards(data);
                    updateCharts(data);
                    updateMetricsTable(data);
                    updateSystemStatus(data);
                }
            });
        }
    </script>
</body>
</html>
