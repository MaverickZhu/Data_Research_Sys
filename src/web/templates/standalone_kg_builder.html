{% extends "base.html" %}

{% block title %}知识图谱构建 - 智能关联匹配系统V2.0{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/table-selector.css') }}">
<style>
    .kg-container {
        max-width: 1400px;
        margin: 20px auto;
        padding: 20px;
    }
    
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        text-align: center;
    }
    
    .page-header h1 {
        margin: 0;
        font-size: 2.2em;
        font-weight: 700;
    }
    
    .page-header p {
        margin: 10px 0 0;
        font-size: 1.1em;
        opacity: 0.9;
    }
    
    .build-steps {
        display: grid;
        grid-template-columns: 1fr;
        gap: 30px;
    }
    
    .step-card {
        background: white;
        border-radius: 15px;
        padding: 0;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        border-left: 5px solid #667eea;
    }
    
    .step-header {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 20px;
        font-size: 1.3em;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .step-number {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.2em;
    }
    
    .step-content {
        padding: 25px;
    }
    
    .table-selection-area {
        min-height: 300px;
        margin-bottom: 20px;
    }
    
    .selected-tables {
        margin-top: 20px;
    }
    
    .selected-table-item {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: between;
        align-items: center;
    }
    
    .table-info {
        flex: 1;
    }
    
    .table-name {
        font-weight: 600;
        font-size: 1.1em;
        color: #333;
    }
    
    .table-stats {
        font-size: 0.9em;
        color: #666;
        margin-top: 5px;
    }
    
    .remove-table {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        cursor: pointer;
        font-size: 1.2em;
    }
    
    .config-section {
        display: none;
        margin-top: 20px;
    }
    
    .config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    
    .config-group {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
    }
    
    .config-group h4 {
        margin: 0 0 15px 0;
        color: #333;
        font-size: 1.1em;
    }
    
    .config-option {
        margin-bottom: 15px;
    }
    
    .config-option label {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 500;
        cursor: pointer;
    }
    
    .config-option input[type="checkbox"] {
        width: 18px;
        height: 18px;
    }
    
    .config-option input[type="range"] {
        width: 100%;
        margin: 5px 0;
    }
    
    .range-value {
        font-weight: 600;
        color: #667eea;
    }
    
    .table-analysis {
        margin: 20px 0;
    }
    
    .analysis-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
    }
    
    .analysis-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .analysis-title {
        font-weight: 600;
        font-size: 1.1em;
        color: #333;
    }
    
    .analysis-stats {
        font-size: 0.9em;
        color: #666;
    }
    
    .field-analysis {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 15px;
    }
    
    .field-group {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
    }
    
    .field-group h5 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 1em;
    }
    
    .field-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 8px;
        font-size: 0.9em;
    }
    
    .field-name {
        font-weight: 600;
        color: #333;
    }
    
    .field-type-tag {
        background: #e3f2fd;
        color: #1976d2;
        padding: 2px 6px;
        border-radius: 12px;
        font-size: 0.8em;
        margin-left: 8px;
    }
    
    .confidence-indicator {
        float: right;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 500;
    }
    
    .confidence-high {
        background: #e8f5e8;
        color: #2e7d32;
    }
    
    .confidence-medium {
        background: #fff3e0;
        color: #f57c00;
    }
    
    .confidence-low {
        background: #ffebee;
        color: #c62828;
    }
    
    .build-controls {
        display: flex;
        gap: 15px;
        margin: 20px 0;
        flex-wrap: wrap;
    }
    
    .control-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1em;
    }
    
    .control-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .control-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
    }
    
    .control-btn.primary {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        font-size: 1.1em;
        padding: 15px 30px;
    }
    
    .build-progress {
        display: none;
        margin-top: 30px;
        padding: 25px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
    }
    
    .progress-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .progress-title {
        font-size: 1.3em;
        font-weight: 600;
        color: #333;
    }
    
    .progress-status {
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: 500;
        font-size: 0.9em;
    }
    
    .status-running {
        background: #e3f2fd;
        color: #1976d2;
    }
    
    .status-completed {
        background: #e8f5e8;
        color: #2e7d32;
    }
    
    .status-failed {
        background: #ffebee;
        color: #c62828;
    }
    
    .progress-bar {
        width: 100%;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin: 20px 0;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 4px;
        transition: width 0.5s ease;
        width: 0%;
    }
    
    .progress-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }
    
    .progress-stat {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.8em;
        font-weight: 700;
        color: #333;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 0.9em;
        color: #666;
    }
    
    .build-results {
        display: none;
        margin-top: 30px;
        padding: 25px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
    }
    
    .results-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }
    
    .summary-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
    }
    
    .summary-value {
        font-size: 2em;
        font-weight: 700;
        margin-bottom: 5px;
    }
    
    .summary-label {
        font-size: 0.9em;
        opacity: 0.9;
    }
    
    .table-results {
        margin-top: 25px;
    }
    
    .table-result-item {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        border-left: 4px solid #28a745;
    }
    
    .table-result-item.failed {
        border-left-color: #dc3545;
    }
    
    .result-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .result-name {
        font-weight: 600;
        font-size: 1.1em;
        color: #333;
    }
    
    .result-status {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 500;
    }
    
    .result-stats {
        display: flex;
        gap: 20px;
        font-size: 0.9em;
        color: #666;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 40px;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #f5c6cb;
        margin: 15px 0;
    }
    
    .success-message {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #c3e6cb;
        margin: 15px 0;
    }
    
    @media (max-width: 768px) {
        .field-analysis {
            grid-template-columns: 1fr;
        }
        
        .build-controls {
            flex-direction: column;
        }
        
        .control-btn {
            width: 100%;
            text-align: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="kg-container">
    <div class="page-header">
        <h1><i class="fas fa-project-diagram"></i> 知识图谱构建</h1>
        <p>基于选定数据表构建智能知识图谱，发现数据间的深层关联</p>
    </div>
    
    <div class="build-steps">
        <!-- 步骤1：数据表选择 -->
        <div class="step-card">
            <div class="step-header">
                <div class="step-number">1</div>
                <div>选择数据表</div>
            </div>
            <div class="step-content">
                <p>选择要构建知识图谱的数据表。支持单表或多表联合构建。</p>
                
                <div id="table-selector" class="table-selection-area"></div>
                
                <div class="selected-tables">
                    <div id="selected-tables"></div>
                </div>
            </div>
        </div>
        
        <!-- 步骤2：构建配置 -->
        <div class="step-card">
            <div class="step-header">
                <div class="step-number">2</div>
                <div>构建配置</div>
            </div>
            <div class="step-content">
                <p>配置知识图谱构建参数，系统将智能分析数据特征并提供建议配置。</p>
                
                <div class="build-controls">
                    <button id="analyze-tables-btn" class="control-btn" disabled>
                        <i class="fas fa-search"></i> 分析数据表
                    </button>
                    <button id="reset-config-btn" class="control-btn">
                        <i class="fas fa-undo"></i> 重置配置
                    </button>
                </div>
                
                <div class="config-section" id="config-section">
                    <div class="config-grid">
                        <div class="config-group">
                            <h4><i class="fas fa-cube"></i> 实体抽取</h4>
                            <div class="config-option">
                                <label>
                                    <input type="checkbox" id="enable-entity-extraction" checked>
                                    启用实体抽取
                                </label>
                            </div>
                            <div class="config-option">
                                <label>置信度阈值: <span class="range-value" id="entity-threshold-value">0.6</span></label>
                                <input type="range" id="entity-threshold" min="0.1" max="1.0" step="0.1" value="0.6">
                            </div>
                        </div>
                        
                        <div class="config-group">
                            <h4><i class="fas fa-link"></i> 关系抽取</h4>
                            <div class="config-option">
                                <label>
                                    <input type="checkbox" id="enable-relation-extraction" checked>
                                    启用关系抽取
                                </label>
                            </div>
                            <div class="config-option">
                                <label>置信度阈值: <span class="range-value" id="relation-threshold-value">0.5</span></label>
                                <input type="range" id="relation-threshold" min="0.1" max="1.0" step="0.1" value="0.5">
                            </div>
                        </div>
                        
                        <div class="config-group">
                            <h4><i class="fas fa-cogs"></i> 构建选项</h4>
                            <div class="config-option">
                                <label>
                                    <input type="checkbox" id="enable-validation" checked>
                                    启用数据验证
                                </label>
                            </div>
                            <div class="config-option">
                                <label>
                                    <input type="checkbox" id="auto-merge-entities" checked>
                                    自动合并相似实体
                                </label>
                            </div>
                            <div class="config-option">
                                <label>
                                    <input type="checkbox" id="create-indexes" checked>
                                    创建索引优化
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 数据表分析结果 -->
                    <div class="table-analysis" id="table-analysis"></div>
                </div>
            </div>
        </div>
        
        <!-- 步骤3：开始构建 -->
        <div class="step-card">
            <div class="step-header">
                <div class="step-number">3</div>
                <div>开始构建</div>
            </div>
            <div class="step-content">
                <p>确认配置后开始构建知识图谱。构建过程将在后台进行，您可以实时查看进度。</p>
                
                <div class="build-controls">
                    <input type="text" id="project-name" placeholder="输入项目名称（可选）" style="padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em; flex: 1; max-width: 300px;">
                    <button id="start-build-btn" class="control-btn primary" disabled>
                        <i class="fas fa-rocket"></i> 开始构建知识图谱
                    </button>
                </div>
                
                <!-- 加载状态 -->
                <div class="loading-spinner" id="loading-spinner">
                    <div class="spinner"></div>
                    <p>正在处理，请稍候...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 构建进度 -->
    <div class="build-progress" id="build-progress">
        <div class="progress-header">
            <div class="progress-title">构建进度</div>
            <div class="progress-status" id="progress-status">准备中</div>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        
        <div class="progress-details" id="progress-details">
            <div class="progress-stat">
                <div class="stat-value" id="current-stage">-</div>
                <div class="stat-label">当前阶段</div>
            </div>
            <div class="progress-stat">
                <div class="stat-value" id="processed-tables">0</div>
                <div class="stat-label">已处理表</div>
            </div>
            <div class="progress-stat">
                <div class="stat-value" id="elapsed-time">00:00</div>
                <div class="stat-label">已用时间</div>
            </div>
        </div>
    </div>
    
    <!-- 构建结果 -->
    <div class="build-results" id="build-results">
        <h3><i class="fas fa-chart-bar"></i> 构建结果</h3>
        
        <div class="results-summary" id="results-summary"></div>
        
        <div class="table-results" id="table-results"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/table-selector.js') }}"></script>
<script>
let tableSelector;
let selectedTables = [];
let configSuggestions = null;
let currentTaskId = null;
let progressInterval = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeTableSelector();
    bindEvents();
    updateRangeValues();
});

function initializeTableSelector() {
    tableSelector = new TableSelector('table-selector', {
        multiple: true,
        showDetails: true,
        filterEmpty: true,
        onSelect: function(tables) {
            handleTableSelection(tables);
        }
    });
}

function bindEvents() {
    document.getElementById('analyze-tables-btn').addEventListener('click', analyzeSelectedTables);
    document.getElementById('reset-config-btn').addEventListener('click', resetConfiguration);
    document.getElementById('start-build-btn').addEventListener('click', startKnowledgeGraphBuild);
    
    // 绑定配置变更事件
    document.getElementById('entity-threshold').addEventListener('input', updateRangeValues);
    document.getElementById('relation-threshold').addEventListener('input', updateRangeValues);
}

function updateRangeValues() {
    const entityThreshold = document.getElementById('entity-threshold');
    const relationThreshold = document.getElementById('relation-threshold');
    
    document.getElementById('entity-threshold-value').textContent = entityThreshold.value;
    document.getElementById('relation-threshold-value').textContent = relationThreshold.value;
}

function handleTableSelection(tables) {
    selectedTables = tables;
    updateSelectedTablesDisplay();
    
    const analyzeBtn = document.getElementById('analyze-tables-btn');
    const startBtn = document.getElementById('start-build-btn');
    
    if (selectedTables.length > 0) {
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = `分析 ${selectedTables.length} 个数据表`;
    } else {
        analyzeBtn.disabled = true;
        analyzeBtn.textContent = '分析数据表';
        startBtn.disabled = true;
        document.getElementById('config-section').style.display = 'none';
    }
}

function updateSelectedTablesDisplay() {
    const container = document.getElementById('selected-tables');
    
    if (selectedTables.length === 0) {
        container.innerHTML = '';
        return;
    }
    
    container.innerHTML = `
        <h4>已选择 ${selectedTables.length} 个数据表：</h4>
        ${selectedTables.map((table, index) => `
            <div class="selected-table-item">
                <div class="table-info">
                    <div class="table-name">${table.display_name}</div>
                    <div class="table-stats">${table.document_count.toLocaleString()} 条记录 | ${table.field_count} 字段</div>
                </div>
                <button class="remove-table" onclick="removeTable(${index})">×</button>
            </div>
        `).join('')}
    `;
}

function removeTable(index) {
    selectedTables.splice(index, 1);
    tableSelector.updateSelection(selectedTables);
    updateSelectedTablesDisplay();
    handleTableSelection(selectedTables);
}

async function analyzeSelectedTables() {
    if (selectedTables.length === 0) {
        showError('请先选择数据表');
        return;
    }
    
    try {
        showLoading(true);
        
        const response = await fetch('/api/kg_build_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                table_names: selectedTables.map(t => t.name),
                build_options: getCurrentBuildConfig()
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            configSuggestions = result.config_suggestions;
            displayConfigSuggestions();
            document.getElementById('config-section').style.display = 'block';
            document.getElementById('start-build-btn').disabled = false;
            showSuccess('数据表分析完成，已生成构建建议');
        } else {
            throw new Error(result.error || '分析数据表失败');
        }
        
    } catch (error) {
        console.error('分析数据表失败:', error);
        showError('分析数据表失败: ' + error.message);
    } finally {
        showLoading(false);
    }
}

function getCurrentBuildConfig() {
    return {
        entity_extraction: {
            enabled: document.getElementById('enable-entity-extraction').checked,
            confidence_threshold: parseFloat(document.getElementById('entity-threshold').value)
        },
        relation_extraction: {
            enabled: document.getElementById('enable-relation-extraction').checked,
            confidence_threshold: parseFloat(document.getElementById('relation-threshold').value)
        },
        build_options: {
            enable_validation: document.getElementById('enable-validation').checked,
            auto_merge_entities: document.getElementById('auto-merge-entities').checked,
            create_indexes: document.getElementById('create-indexes').checked
        }
    };
}

function displayConfigSuggestions() {
    if (!configSuggestions || !configSuggestions.table_analysis) return;
    
    const container = document.getElementById('table-analysis');
    
    container.innerHTML = `
        <h4><i class="fas fa-chart-line"></i> 数据表分析结果</h4>
        ${configSuggestions.table_analysis.map(analysis => `
            <div class="analysis-card">
                <div class="analysis-header">
                    <div class="analysis-title">${analysis.table_name}</div>
                    <div class="analysis-stats">
                        ${analysis.total_records.toLocaleString()} 记录 | ${analysis.total_fields} 字段
                    </div>
                </div>
                
                <div class="field-analysis">
                    <div class="field-group">
                        <h5><i class="fas fa-cube"></i> 候选实体字段 (${analysis.entity_fields.length})</h5>
                        ${analysis.entity_fields.map(field => `
                            <div class="field-item">
                                <span class="field-name">${field.field_name}</span>
                                <span class="field-type-tag">${field.entity_type}</span>
                                <span class="confidence-indicator confidence-${getConfidenceLevel(field.confidence)}">
                                    ${Math.round(field.confidence * 100)}%
                                </span>
                            </div>
                        `).join('') || '<div style="color: #999; font-style: italic;">未发现合适的实体字段</div>'}
                    </div>
                    
                    <div class="field-group">
                        <h5><i class="fas fa-link"></i> 候选关系字段 (${analysis.relation_fields.length})</h5>
                        ${analysis.relation_fields.map(field => `
                            <div class="field-item">
                                <span class="field-name">${field.field_name}</span>
                                <span class="field-type-tag">${field.relation_type}</span>
                                <span class="confidence-indicator confidence-${getConfidenceLevel(field.confidence)}">
                                    ${Math.round(field.confidence * 100)}%
                                </span>
                            </div>
                        `).join('') || '<div style="color: #999; font-style: italic;">未发现合适的关系字段</div>'}
                    </div>
                </div>
            </div>
        `).join('')}
    `;
}

function getConfidenceLevel(confidence) {
    if (confidence >= 0.7) return 'high';
    if (confidence >= 0.4) return 'medium';
    return 'low';
}

function resetConfiguration() {
    document.getElementById('enable-entity-extraction').checked = true;
    document.getElementById('enable-relation-extraction').checked = true;
    document.getElementById('enable-validation').checked = true;
    document.getElementById('auto-merge-entities').checked = true;
    document.getElementById('create-indexes').checked = true;
    document.getElementById('entity-threshold').value = '0.6';
    document.getElementById('relation-threshold').value = '0.5';
    updateRangeValues();
    
    document.getElementById('table-analysis').innerHTML = '';
    configSuggestions = null;
}

async function startKnowledgeGraphBuild() {
    if (selectedTables.length === 0) {
        showError('请先选择数据表');
        return;
    }
    
    const projectName = document.getElementById('project-name').value.trim() || 
                       `KG_Project_${new Date().toISOString().slice(0, 19).replace(/[-:]/g, '')}`;
    
    try {
        showLoading(true);
        
        // 显示进度区域
        const progressSection = document.getElementById('build-progress');
        progressSection.style.display = 'block';
        progressSection.scrollIntoView({ behavior: 'smooth' });
        
        // 禁用构建按钮
        document.getElementById('start-build-btn').disabled = true;
        document.getElementById('start-build-btn').textContent = '构建进行中...';
        
        let buildResults = [];
        let totalTables = selectedTables.length;
        let completedTables = 0;
        
        // 为每个表构建知识图谱
        for (const table of selectedTables) {
            updateProgressDisplay({
                status: 'processing',
                progress: (completedTables / totalTables) * 100,
                current_stage: `正在构建表 "${table.name}" 的知识图谱...`,
                message: `处理进度: ${completedTables + 1}/${totalTables}`
            });
            
            try {
                const response = await fetch('/api/kg/build', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        table_name: table.name,
                        project_id: projectName,
                        config: getCurrentBuildConfig()
                    })
                });
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                buildResults.push({
                    table_name: table.name,
                    ...result
                });
                
                completedTables++;
                
                updateProgressDisplay({
                    status: 'processing',
                    progress: (completedTables / totalTables) * 100,
                    current_stage: `表 "${table.name}" 构建完成`,
                    message: `已完成: ${completedTables}/${totalTables}`
                });
                
            } catch (error) {
                console.error(`表 ${table.name} 构建失败:`, error);
                buildResults.push({
                    table_name: table.name,
                    status: 'failed',
                    error: error.message
                });
                completedTables++;
            }
        }
        
        // 显示最终结果
        updateProgressDisplay({
            status: 'completed',
            progress: 100,
            current_stage: '知识图谱构建完成',
            message: `成功处理 ${buildResults.filter(r => r.status === 'completed').length}/${totalTables} 个表`
        });
        
        // 显示构建结果
        displayBuildResults({
            build_summary: {
                total_tables_processed: totalTables,
                successful_builds: buildResults.filter(r => r.status === 'completed').length,
                failed_builds: buildResults.filter(r => r.status === 'failed').length,
                total_entities_created: buildResults.reduce((sum, r) => sum + (r.entities_created || 0), 0),
                total_relations_created: buildResults.reduce((sum, r) => sum + (r.triples_created || 0), 0)
            },
            table_results: buildResults
        });
        
        showSuccess('知识图谱构建完成！');
        
    } catch (error) {
        console.error('构建失败:', error);
        updateProgressDisplay({
            status: 'failed',
            progress: 0,
            current_stage: '构建失败',
            message: error.message
        });
        showError('构建失败: ' + error.message);
    } finally {
        showLoading(false);
        // 重置按钮状态
        setTimeout(() => {
            document.getElementById('start-build-btn').disabled = false;
            document.getElementById('start-build-btn').textContent = '开始构建知识图谱';
        }, 2000);
    }
}

function startProgressMonitoring() {
    const progressSection = document.getElementById('build-progress');
    progressSection.style.display = 'block';
    progressSection.scrollIntoView({ behavior: 'smooth' });
    
    // 禁用构建按钮
    document.getElementById('start-build-btn').disabled = true;
    document.getElementById('start-build-btn').textContent = '构建进行中...';
    
    // 开始轮询进度
    progressInterval = setInterval(updateProgress, 2000);
    updateProgress(); // 立即更新一次
}

async function updateProgress() {
    if (!currentTaskId) return;
    
    try {
        const response = await fetch(`/api/kg_build_progress/${currentTaskId}`);
        const result = await response.json();
        
        if (result.success) {
            const progress = result.progress;
            updateProgressDisplay(progress);
            
            if (progress.status === 'completed') {
                clearInterval(progressInterval);
                await loadBuildResults();
            } else if (progress.status === 'failed') {
                clearInterval(progressInterval);
                showError('构建失败: ' + (progress.error_message || '未知错误'));
                resetBuildState();
            }
        }
        
    } catch (error) {
        console.error('获取进度失败:', error);
    }
}

function updateProgressDisplay(progress) {
    // 更新状态
    const statusElement = document.getElementById('progress-status');
    statusElement.textContent = getStatusText(progress.status);
    statusElement.className = `progress-status status-${progress.status}`;
    
    // 更新进度条
    const progressFill = document.getElementById('progress-fill');
    progressFill.style.width = `${progress.progress || 0}%`;
    
    // 更新详细信息
    document.getElementById('current-stage').textContent = getStageText(progress.current_stage);
    
    if (progress.stage_details) {
        document.getElementById('processed-tables').textContent = 
            `${progress.stage_details.table_index || 0}/${progress.stage_details.total_tables || 0}`;
    }
    
    // 计算用时
    if (progress.start_time) {
        const startTime = new Date(progress.start_time);
        const now = new Date();
        const elapsed = Math.floor((now - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('elapsed-time').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
}

function getStatusText(status) {
    const statusMap = {
        'started': '已启动',
        'in_progress': '进行中',
        'processing': '处理中',
        'completed': '已完成',
        'failed': '失败'
    };
    return statusMap[status] || status;
}

function getStageText(stage) {
    const stageMap = {
        'initializing': '初始化',
        'processing_table_1': '处理第1个表',
        'processing_table_2': '处理第2个表',
        'processing_table_3': '处理第3个表',
        'completed': '构建完成',
        'error': '发生错误'
    };
    
    // 处理动态表处理阶段
    if (stage && stage.startsWith('processing_table_')) {
        const tableNum = stage.split('_')[2];
        return `处理第${tableNum}个表`;
    }
    
    return stageMap[stage] || stage;
}

async function loadBuildResults() {
    if (!currentTaskId) return;
    
    try {
        const response = await fetch(`/api/kg_build_result/${currentTaskId}`);
        const result = await response.json();
        
        if (result.success && result.result) {
            displayBuildResults(result.result);
        } else {
            showError('获取构建结果失败: ' + (result.error || '未知错误'));
        }
        
    } catch (error) {
        console.error('加载构建结果失败:', error);
        showError('加载构建结果失败: ' + error.message);
    }
    
    resetBuildState();
}

function displayBuildResults(results) {
    const resultsSection = document.getElementById('build-results');
    const summaryContainer = document.getElementById('results-summary');
    const tableResultsContainer = document.getElementById('table-results');
    
    // 显示摘要统计
    const summary = results.build_summary || {};
    summaryContainer.innerHTML = `
        <div class="summary-card">
            <div class="summary-value">${summary.total_entities_created || 0}</div>
            <div class="summary-label">实体总数</div>
        </div>
        <div class="summary-card">
            <div class="summary-value">${summary.total_triples_created || 0}</div>
            <div class="summary-label">关系总数</div>
        </div>
        <div class="summary-card">
            <div class="summary-value">${summary.successful_tables || 0}</div>
            <div class="summary-label">成功表数</div>
        </div>
        <div class="summary-card">
            <div class="summary-value">${Math.round(summary.success_rate || 0)}%</div>
            <div class="summary-label">成功率</div>
        </div>
    `;
    
    // 显示各表结果
    const tableResults = results.table_results || [];
    tableResultsContainer.innerHTML = `
        <h4>各表构建详情：</h4>
        ${tableResults.map(result => `
            <div class="table-result-item ${result.status === 'completed' ? '' : 'failed'}">
                <div class="result-header">
                    <div class="result-name">${result.table_name}</div>
                    <div class="result-status ${result.status === 'completed' ? 'confidence-high' : 'confidence-low'}">
                        ${result.status === 'completed' ? '成功' : '失败'}
                    </div>
                </div>
                <div class="result-stats">
                    <span>实体: ${result.entities_created || 0}</span>
                    <span>关系: ${result.triples_created || 0}</span>
                    <span>耗时: ${result.end_time && result.start_time ? 
                        Math.round((new Date(result.end_time) - new Date(result.start_time)) / 1000) + 's' : '-'}</span>
                </div>
            </div>
        `).join('')}
    `;
    
    resultsSection.style.display = 'block';
    resultsSection.scrollIntoView({ behavior: 'smooth' });
    
    showSuccess('知识图谱构建完成！');
}

function resetBuildState() {
    document.getElementById('start-build-btn').disabled = false;
    document.getElementById('start-build-btn').textContent = '开始构建知识图谱';
    currentTaskId = null;
}

function showLoading(show) {
    const spinner = document.getElementById('loading-spinner');
    spinner.style.display = show ? 'block' : 'none';
}

function showError(message) {
    const container = document.querySelector('.kg-container');
    const existingError = container.querySelector('.error-message');
    if (existingError) existingError.remove();
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
    container.insertBefore(errorDiv, container.firstChild);
    
    setTimeout(() => errorDiv.remove(), 8000);
}

function showSuccess(message) {
    const container = document.querySelector('.kg-container');
    const existingSuccess = container.querySelector('.success-message');
    if (existingSuccess) existingSuccess.remove();
    
    const successDiv = document.createElement('div');
    successDiv.className = 'success-message';
    successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    container.insertBefore(successDiv, container.firstChild);
    
    setTimeout(() => successDiv.remove(), 5000);
}

// 新增：知识图谱查询和展示功能
async function queryKnowledgeGraph() {
    const query = document.getElementById('kg-search-input').value.trim();
    
    if (!query) {
        showError('请输入搜索关键词');
        return;
    }
    
    try {
        showLoading(true);
        
        const response = await fetch(`/api/kg/search?q=${encodeURIComponent(query)}&limit=50`);
        const result = await response.json();
        
        if (result.error) {
            throw new Error(result.error);
        }
        
        displaySearchResults(result);
        
    } catch (error) {
        console.error('知识图谱查询失败:', error);
        showError('查询失败: ' + error.message);
    } finally {
        showLoading(false);
    }
}

function displaySearchResults(results) {
    const resultsContainer = document.getElementById('kg-search-results');
    
    if (!results.results.entities.length && !results.results.triples.length) {
        resultsContainer.innerHTML = `
            <div class="no-results">
                <i class="fas fa-search"></i>
                <p>未找到相关结果</p>
            </div>
        `;
        return;
    }
    
    let html = `<div class="search-results-header">
        <h4>搜索结果：${results.query}</h4>
        <div class="results-stats">
            <span class="stat-item">实体: ${results.total_entities}</span>
            <span class="stat-item">关系: ${results.total_triples}</span>
        </div>
    </div>`;
    
    // 显示实体结果
    if (results.results.entities.length > 0) {
        html += `
            <div class="entity-results">
                <h5><i class="fas fa-cube"></i> 实体 (${results.results.entities.length})</h5>
                <div class="entity-grid">
                    ${results.results.entities.map(entity => `
                        <div class="entity-card" onclick="showEntityDetails('${entity.id}')">
                            <div class="entity-header">
                                <span class="entity-type ${typeof entity.type === 'string' ? entity.type.toLowerCase() : 'unknown'}">${typeof entity.type === 'string' ? entity.type : (entity.type?.value || entity.type?.name || 'UNKNOWN')}</span>
                                <span class="entity-confidence">${(entity.confidence * 100).toFixed(1)}%</span>
                            </div>
                            <div class="entity-label">${entity.label}</div>
                            <div class="entity-source">来源: ${entity.source_table || '未知'}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // 显示关系结果
    if (results.results.triples.length > 0) {
        html += `
            <div class="relation-results">
                <h5><i class="fas fa-project-diagram"></i> 关系 (${results.results.triples.length})</h5>
                <div class="relation-list">
                    ${results.results.triples.map(triple => `
                        <div class="relation-card">
                            <div class="relation-triple">
                                <span class="subject">${triple.subject.label}</span>
                                <span class="predicate">${triple.predicate.type}</span>
                                <span class="object">${triple.object.label}</span>
                            </div>
                            <div class="relation-meta">
                                <span class="confidence">${(triple.confidence * 100).toFixed(1)}%</span>
                                <span class="source">${triple.source}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';
}

async function showEntityDetails(entityId) {
    try {
        const response = await fetch(`/api/kg/entities?id=${entityId}`);
        const result = await response.json();
        
        if (result.error) {
            throw new Error(result.error);
        }
        
        const entity = result.entities[0];
        if (!entity) {
            showError('未找到实体详情');
            return;
        }
        
        // 显示实体详情模态框
        const modalHtml = `
            <div class="modal fade" id="entityModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-cube"></i> 
                                ${entity.label}
                                <span class="badge badge-info">${typeof entity.type === 'string' ? entity.type : (entity.type?.value || entity.type?.name || 'UNKNOWN')}</span>
                            </h5>
                            <button type="button" class="close" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="entity-details">
                                <div class="detail-section">
                                    <h6>基本信息</h6>
                                    <table class="table table-sm">
                                        <tr><td>实体ID</td><td>${entity.id}</td></tr>
                                        <tr><td>类型</td><td>${typeof entity.type === 'string' ? entity.type : (entity.type?.value || entity.type?.name || 'UNKNOWN')}</td></tr>
                                        <tr><td>置信度</td><td>${(entity.confidence * 100).toFixed(2)}%</td></tr>
                                        <tr><td>来源表</td><td>${entity.source_table || '未知'}</td></tr>
                                        <tr><td>来源列</td><td>${entity.source_column || '未知'}</td></tr>
                                    </table>
                                </div>
                                ${entity.properties && Object.keys(entity.properties).length > 0 ? `
                                    <div class="detail-section">
                                        <h6>属性信息</h6>
                                        <table class="table table-sm">
                                            ${Object.entries(entity.properties).map(([key, value]) => 
                                                `<tr><td>${key}</td><td>${value}</td></tr>`
                                            ).join('')}
                                        </table>
                                    </div>
                                ` : ''}
                                ${entity.aliases && entity.aliases.length > 0 ? `
                                    <div class="detail-section">
                                        <h6>别名</h6>
                                        <div class="aliases">
                                            ${entity.aliases.map(alias => 
                                                `<span class="badge badge-secondary">${alias}</span>`
                                            ).join(' ')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // 移除已存在的模态框
        const existingModal = document.getElementById('entityModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // 添加新模态框
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        $('#entityModal').modal('show');
        
    } catch (error) {
        console.error('获取实体详情失败:', error);
        showError('获取实体详情失败: ' + error.message);
    }
}

// 获取知识图谱统计信息
async function loadKGStatistics() {
    try {
        const response = await fetch('/api/kg/status');
        const result = await response.json();
        
        if (result.error) {
            throw new Error(result.error);
        }
        
        displayKGStatistics(result);
        
    } catch (error) {
        console.error('获取知识图谱统计失败:', error);
        // 静默失败，不显示错误
    }
}

function displayKGStatistics(stats) {
    const statsContainer = document.getElementById('kg-statistics');
    
    if (!stats.knowledge_graph_statistics) {
        return;
    }
    
    const kgStats = stats.knowledge_graph_statistics;
    
    const html = `
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">${kgStats.total_entities || 0}</div>
                <div class="stat-label">实体总数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${kgStats.total_triples || 0}</div>
                <div class="stat-label">关系总数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${kgStats.total_relations || 0}</div>
                <div class="stat-label">关系类型</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${((kgStats.average_confidence || 0) * 100).toFixed(1)}%</div>
                <div class="stat-label">平均置信度</div>
            </div>
        </div>
    `;
    
    statsContainer.innerHTML = html;
}

// 页面加载完成后获取统计信息
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(loadKGStatistics, 1000);
});
</script>
{% endblock %}
