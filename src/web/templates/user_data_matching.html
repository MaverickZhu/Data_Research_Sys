{% extends "base.html" %}

{% block title %}用户数据智能匹配 - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="header bg-gradient-primary text-white p-5 rounded-3 mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-4 mb-3"><i class="fas fa-brain"></i> 用户数据智能匹配</h1>
                <p class="lead">基于您上传的数据和字段映射配置，使用成熟的匹配算法进行智能数据关联</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="feature-badge">
                    <span class="badge bg-light text-primary fs-6">
                        <i class="fas fa-sparkles"></i> 智能算法驱动
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- 配置信息卡片 -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-cog"></i> 字段映射配置信息</h5>
        </div>
        <div class="card-body">
            <div id="config-loading" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载配置中...</span>
                </div>
                <p class="mt-2">正在加载您的字段映射配置...</p>
            </div>
            
            <div id="config-content" style="display: none;">
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-item">
                            <label class="fw-bold text-muted">配置ID:</label>
                            <span id="config-id" class="ms-2">-</span>
                        </div>
                        <div class="info-item">
                            <label class="fw-bold text-muted">源数据表:</label>
                            <span id="source-table" class="ms-2 badge bg-primary">-</span>
                        </div>
                        <div class="info-item">
                            <label class="fw-bold text-muted">目标数据表:</label>
                            <div id="target-tables" class="ms-2 mt-1">-</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item">
                            <label class="fw-bold text-muted">创建时间:</label>
                            <span id="created-at" class="ms-2">-</span>
                        </div>
                        <div class="info-item">
                            <label class="fw-bold text-muted">映射字段数:</label>
                            <span id="mapping-count" class="ms-2 badge bg-success">-</span>
                        </div>
                        <div class="info-item">
                            <label class="fw-bold text-muted">数据量统计:</label>
                            <div id="data-stats" class="ms-2 mt-1">
                                <small class="text-muted">正在统计...</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 映射详情 -->
                <div class="mt-4">
                    <h6><i class="fas fa-list"></i> 字段映射详情</h6>
                    <div class="table-responsive" style="max-height: 300px;">
                        <table class="table table-sm table-striped table-hover">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th width="25%">源字段</th>
                                    <th width="25%">目标字段</th>
                                    <th width="20%">目标表</th>
                                    <th width="15%">相似度</th>
                                    <th width="15%">数据类型</th>
                                </tr>
                            </thead>
                            <tbody id="mapping-list">
                                <tr><td colspan="5" class="text-center text-muted">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 匹配算法选择和参数配置 -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-magic"></i> 智能匹配配置</h5>
        </div>
        <div class="card-body">
            <form id="matching-form">
                <div class="row g-3">
                    <!-- 匹配算法选择 -->
                    <div class="col-md-3">
                        <label for="algorithm-type" class="form-label">
                            <i class="fas fa-robot"></i> 匹配算法
                        </label>
                        <select id="algorithm-type" class="form-select">
                            <option value="dual_validation" selected>双重验证匹配算法 (推荐)</option>
                            <option value="optimized">优化匹配算法</option>
                            <option value="exact">精确匹配算法</option>
                            <option value="fuzzy">模糊匹配算法</option>
                            <option value="hybrid">混合匹配算法</option>
                        </select>
                        <div class="form-text">选择最适合您数据的匹配算法</div>
                    </div>

                    <!-- 相似度阈值 -->
                    <div class="col-md-3">
                        <label for="similarity-threshold" class="form-label">
                            <i class="fas fa-percentage"></i> 相似度阈值
                        </label>
                        <select id="similarity-threshold" class="form-select">
                            <option value="0.6">宽松 (60%)</option>
                            <option value="0.7" selected>标准 (70%)</option>
                            <option value="0.8">严格 (80%)</option>
                            <option value="0.9">非常严格 (90%)</option>
                        </select>
                        <div class="form-text">设置匹配的最低相似度要求</div>
                    </div>

                    <!-- 批处理大小 -->
                    <div class="col-md-3">
                        <label for="batch-size" class="form-label">
                            <i class="fas fa-layer-group"></i> 批处理大小
                        </label>
                        <select id="batch-size" class="form-select">
                            <option value="100">小批量 (100条/批)</option>
                            <option value="200">标准 (200条/批)</option>
                            <option value="500" selected>大批量 (500条/批)</option>
                            <option value="1000">超大批量 (1000条/批)</option>
                        </select>
                        <div class="form-text">根据数据量和性能需求选择</div>
                    </div>

                    <!-- 最大结果数 -->
                    <div class="col-md-3">
                        <label for="max-results" class="form-label">
                            <i class="fas fa-list-ol"></i> 最大结果数
                        </label>
                        <select id="max-results" class="form-select">
                            <option value="5">前5个匹配</option>
                            <option value="10" selected>前10个匹配</option>
                            <option value="20">前20个匹配</option>
                            <option value="50">前50个匹配</option>
                        </select>
                        <div class="form-text">每个源记录返回的最大匹配数</div>
                    </div>
                </div>
                
                <!-- 高级选项 -->
                <div class="mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="fas fa-sliders-h"></i> 高级选项</h6>
                        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#advanced-options">
                            <i class="fas fa-chevron-down"></i> 展开/收起
                        </button>
                    </div>
                    
                    <div class="collapse" id="advanced-options">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enable-preprocessing" checked>
                                    <label class="form-check-label" for="enable-preprocessing">
                                        数据预处理优化
                                    </label>
                                    <div class="form-text">自动清理和标准化数据</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enable-caching" checked>
                                    <label class="form-check-label" for="enable-caching">
                                        结果缓存加速
                                    </label>
                                    <div class="form-text">缓存匹配结果提升性能</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enable-parallel" checked>
                                    <label class="form-check-label" for="enable-parallel">
                                        并行处理加速
                                    </label>
                                    <div class="form-text">多线程并行提升速度</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 操作按钮 -->
                <div class="mt-4 d-flex gap-3">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-rocket"></i> 启动智能匹配
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-lg" onclick="previewMatching()">
                        <i class="fas fa-eye"></i> 预览匹配
                    </button>
                    <button type="button" class="btn btn-outline-info btn-lg" onclick="exportConfig()">
                        <i class="fas fa-download"></i> 导出配置
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-lg" onclick="viewHistory()">
                        <i class="fas fa-history"></i> 历史任务
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 匹配任务状态面板 -->
    <div class="card mt-4 shadow-sm" id="task-status-panel" style="display: none;">
        <div class="card-header bg-warning text-dark">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-tasks"></i> 匹配任务执行状态</h5>
                <span id="task-id-display" class="badge bg-dark">-</span>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <!-- 进度条 -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold">执行进度</span>
                            <span id="progress-percentage" class="badge bg-primary">0%</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                 role="progressbar" style="width: 0%">
                                <span id="progress-text">准备中...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 状态信息 -->
                    <div class="row text-center">
                        <div class="col-3">
                            <div class="stat-item">
                                <h4 id="processed-count" class="text-primary mb-0">0</h4>
                                <small class="text-muted">已处理</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="stat-item">
                                <h4 id="total-count" class="text-info mb-0">0</h4>
                                <small class="text-muted">总数量</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="stat-item">
                                <h4 id="matches-count" class="text-success mb-0">0</h4>
                                <small class="text-muted">匹配数</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="stat-item">
                                <h4 id="elapsed-time" class="text-warning mb-0">0s</h4>
                                <small class="text-muted">耗时</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <p id="status-message" class="mb-1 fw-bold text-primary">准备启动匹配任务...</p>
                        <p id="current-operation" class="mb-0 text-muted small">等待开始</p>
                    </div>
                </div>
                
                <div class="col-md-4 text-end">
                    <div class="d-grid gap-2">
                        <button id="pause-task-btn" class="btn btn-outline-warning" onclick="pauseTask()" style="display: none;">
                            <i class="fas fa-pause"></i> 暂停任务
                        </button>
                        <button id="stop-task-btn" class="btn btn-outline-danger" onclick="stopTask()" style="display: none;">
                            <i class="fas fa-stop"></i> 停止任务
                        </button>
                        <button id="view-results-btn" class="btn btn-primary" onclick="viewResults()" style="display: none;">
                            <i class="fas fa-chart-bar"></i> 查看结果
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 预览结果模态框 -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-eye"></i> 匹配预览结果</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="preview-content">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">正在生成预览...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="startFullMatching()">启动完整匹配</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentConfigId = null;
let currentTaskId = null;
let progressTimer = null;
let startTime = null;
// 存储最后完成的任务信息，用于查看结果
let lastCompletedTaskId = null;
let lastCompletedConfigId = null;

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    // 从URL参数获取配置ID
    const urlParams = new URLSearchParams(window.location.search);
    currentConfigId = urlParams.get('config_id');
    
    if (currentConfigId) {
        loadMappingConfig();
    } else {
        showError('缺少配置ID参数，请从字段映射页面正确跳转');
        setTimeout(() => {
            window.location.href = '/user_driven_field_mapping';
        }, 3000);
    }
    
    // 绑定表单提交事件
    document.getElementById('matching-form').addEventListener('submit', startMatching);
});

// 加载映射配置信息
async function loadMappingConfig() {
    try {
        const response = await fetch(`/api/get_field_mapping_config?config_id=${currentConfigId}`);
        const data = await response.json();
        
        if (data.success) {
            const config = data.config;
            
            // 隐藏加载提示，显示内容
            document.getElementById('config-loading').style.display = 'none';
            document.getElementById('config-content').style.display = 'block';
            
            // 更新配置信息
            document.getElementById('config-id').textContent = config.config_id;
            document.getElementById('source-table').textContent = config.source_table;
            document.getElementById('created-at').textContent = new Date(config.created_at).toLocaleString();
            document.getElementById('mapping-count').textContent = config.mappings.length;
            
            // 显示目标表
            const targetTablesDiv = document.getElementById('target-tables');
            targetTablesDiv.innerHTML = '';
            config.target_tables.forEach(table => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-secondary me-1';
                badge.textContent = table;
                targetTablesDiv.appendChild(badge);
            });
            
            // 更新映射详情表格
            const tbody = document.getElementById('mapping-list');
            tbody.innerHTML = '';
            
            config.mappings.forEach(mapping => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><code>${mapping.source_field}</code></td>
                    <td><code>${mapping.target_field}</code></td>
                    <td><span class="badge bg-info">${mapping.target_table}</span></td>
                    <td><span class="badge bg-primary">${(mapping.similarity_score * 100).toFixed(1)}%</span></td>
                    <td><small class="text-muted">${mapping.data_type || 'auto'}</small></td>
                `;
                tbody.appendChild(row);
            });
            
            // 加载数据统计
            loadDataStatistics(config);
            
        } else {
            showError('加载配置失败: ' + data.error);
        }
    } catch (error) {
        showError('加载配置时发生错误: ' + error.message);
    }
}

// 加载数据统计
async function loadDataStatistics(config) {
    try {
        const tables = [config.source_table, ...config.target_tables];
        const tableParams = tables.join(',');
        
        // 使用轻量级模式和指定表名来优化加载速度
        const response = await fetch(`/api/database_tables?lightweight=true&tables=${encodeURIComponent(tableParams)}`);
        const data = await response.json();
        
        if (data.success) {
            const statsDiv = document.getElementById('data-stats');
            let statsHtml = '';
            
            if (data.lightweight_mode) {
                // 轻量级模式：显示表名和字段数
                data.tables.forEach(table => {
                    const isSource = table.name === config.source_table;
                    const badgeClass = isSource ? 'bg-primary' : 'bg-secondary';
                    statsHtml += `<span class="badge ${badgeClass} me-1">${table.name}: ${table.fields}字段</span><br>`;
                });
                statsHtml += `<small class="text-info mt-1 d-block">快速加载模式 - 已优化页面加载速度</small>`;
            } else {
                // 完整模式：显示记录数统计
                let totalRecords = 0;
                data.tables.forEach(table => {
                    totalRecords += table.count;
                    const isSource = table.name === config.source_table;
                    const badgeClass = isSource ? 'bg-primary' : 'bg-secondary';
                    statsHtml += `<span class="badge ${badgeClass} me-1">${table.name}: ${table.count.toLocaleString()}</span><br>`;
                });
                statsHtml += `<small class="text-success mt-1 d-block">总计: ${totalRecords.toLocaleString()} 条记录</small>`;
            }
            
            statsDiv.innerHTML = statsHtml;
        }
    } catch (error) {
        console.warn('加载数据统计失败:', error);
        document.getElementById('data-stats').innerHTML = '<small class="text-muted">统计信息加载失败</small>';
    }
}

// 启动匹配任务
async function startMatching(event) {
    event.preventDefault();
    
    if (!currentConfigId) {
        showError('配置ID不存在');
        return;
    }
    
    // 防重复提交检查
    const startBtn = document.getElementById('start-matching-btn');
    if (startBtn && startBtn.disabled) {
        showError('任务正在启动中，请勿重复提交');
        return;
    }
    
    // 检查是否已有进行中的任务
    if (currentTaskId) {
        showError('已有任务在进行中，请等待完成或停止当前任务');
        return;
    }
    
    const matchingParams = {
        config_id: currentConfigId,
        algorithm_type: document.getElementById('algorithm-type').value,
        similarity_threshold: parseFloat(document.getElementById('similarity-threshold').value),
        batch_size: parseInt(document.getElementById('batch-size').value),
        max_results: parseInt(document.getElementById('max-results').value),
        enable_preprocessing: document.getElementById('enable-preprocessing').checked,
        enable_caching: document.getElementById('enable-caching').checked,
        enable_parallel: document.getElementById('enable-parallel').checked
    };
    
    // 禁用开始按钮，防止重复提交
    if (startBtn) {
        startBtn.disabled = true;
        startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 启动中...';
    }
    
    try {
        const response = await fetch('/api/start_user_data_matching', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(matchingParams)
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentTaskId = data.task_id;
            startTime = Date.now();
            showSuccess('匹配任务启动成功！任务ID: ' + currentTaskId);
            
            // 显示任务状态面板
            document.getElementById('task-status-panel').style.display = 'block';
            document.getElementById('task-id-display').textContent = currentTaskId;
            document.getElementById('stop-task-btn').style.display = 'block';
            document.getElementById('pause-task-btn').style.display = 'block';
            
            // 滚动到状态面板
            document.getElementById('task-status-panel').scrollIntoView({ behavior: 'smooth' });
            
            // 开始监控进度
            startProgressMonitoring();
        } else {
            showError('启动匹配任务失败: ' + data.error);
            
            // 恢复按钮状态
            if (startBtn) {
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fas fa-play"></i> 开始匹配';
            }
        }
    } catch (error) {
        showError('启动任务时发生错误: ' + error.message);
        
        // 恢复按钮状态
        if (startBtn) {
            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="fas fa-play"></i> 开始匹配';
        }
    }
}

// 开始进度监控
function startProgressMonitoring() {
    progressTimer = setInterval(async () => {
        try {
            const response = await fetch(`/api/user_matching_progress?task_id=${currentTaskId}`);
            const data = await response.json();
            
            if (data.success) {
                const progress = data.progress;
                const status = data.status;
                
                // 更新进度条
                const progressBar = document.getElementById('progress-bar');
                const percentage = progress.percentage || 0;
                progressBar.style.width = percentage + '%';
                document.getElementById('progress-percentage').textContent = percentage + '%';
                document.getElementById('progress-text').textContent = `${percentage}%`;
                
                // 更新统计数据
                document.getElementById('processed-count').textContent = progress.processed || 0;
                document.getElementById('total-count').textContent = progress.total || 0;
                document.getElementById('matches-count').textContent = progress.matches || 0;
                
                // 更新耗时
                if (startTime) {
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    document.getElementById('elapsed-time').textContent = elapsed + 's';
                }
                
                // 更新状态信息
                document.getElementById('status-message').textContent = getStatusMessage(status);
                document.getElementById('current-operation').textContent = progress.current_operation || '处理中...';
                
                // 如果任务完成
                if (status === 'completed' || status === 'failed' || status === 'stopped') {
                    clearInterval(progressTimer);
                    document.getElementById('stop-task-btn').style.display = 'none';
                    document.getElementById('pause-task-btn').style.display = 'none';
                    
                    if (status === 'completed') {
                        document.getElementById('view-results-btn').style.display = 'block';
                        showSuccess(`匹配任务完成！共找到 ${progress.matches} 个匹配结果`);
                        progressBar.className = 'progress-bar bg-success';
                        
                        // 保存任务ID用于跳转和后续查看结果（在重置之前）
                        const completedTaskId = currentTaskId;
                        const completedConfigId = currentConfigId;
                        lastCompletedTaskId = completedTaskId;
                        lastCompletedConfigId = completedConfigId;
                        
                        // 自动跳转到结果页面
                        setTimeout(() => {
                            window.location.href = `/user_matching_results?task_id=${completedTaskId}&config_id=${completedConfigId}`;
                        }, 3000);
                    } else if (status === 'failed') {
                        showError('匹配任务失败: ' + (data.error || '未知错误'));
                        progressBar.className = 'progress-bar bg-danger';
                    } else if (status === 'stopped') {
                        showInfo('匹配任务已停止');
                        progressBar.className = 'progress-bar bg-warning';
                    }
                    
                    // 在所有完成状态下重置任务ID和按钮状态
                    currentTaskId = null;
                    currentConfigId = null;
                    const startBtn = document.getElementById('start-matching-btn');
                    if (startBtn) {
                        startBtn.disabled = false;
                        startBtn.innerHTML = '<i class="fas fa-play"></i> 开始匹配';
                    }
                }
            }
        } catch (error) {
            console.error('获取进度失败:', error);
        }
    }, 2000); // 每2秒更新一次
}

// 获取状态消息
function getStatusMessage(status) {
    const statusMessages = {
        'running': '🚀 匹配任务正在执行中...',
        'completed': '✅ 匹配任务已完成！',
        'failed': '❌ 匹配任务执行失败',
        'stopped': '⏹️ 匹配任务已停止',
        'paused': '⏸️ 匹配任务已暂停'
    };
    return statusMessages[status] || '📊 任务状态更新中...';
}

// 停止任务
async function stopTask() {
    if (!currentTaskId) return;
    
    try {
        const response = await fetch(`/api/stop_user_matching_task?task_id=${currentTaskId}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            clearInterval(progressTimer);
            showInfo('任务停止请求已发送');
        } else {
            showError('停止任务失败: ' + data.error);
        }
    } catch (error) {
        showError('停止任务时发生错误: ' + error.message);
    }
}

// 暂停任务
async function pauseTask() {
    // 暂停功能的实现
    showInfo('暂停功能开发中');
}

// 查看结果
function viewResults() {
    // 优先使用最后完成的任务信息，如果没有则使用当前任务信息
    const taskId = lastCompletedTaskId || currentTaskId;
    const configId = lastCompletedConfigId || currentConfigId;
    
    if (taskId && configId) {
        window.location.href = `/user_matching_results?task_id=${taskId}&config_id=${configId}`;
    } else {
        showError('没有可查看的匹配结果，请先完成一个匹配任务');
    }
}

// 预览匹配
async function previewMatching() {
    if (!currentConfigId) {
        showError('配置ID不存在');
        return;
    }
    
    const params = {
        config_id: currentConfigId,
        preview_count: 5,
        algorithm_type: document.getElementById('algorithm-type').value,
        similarity_threshold: parseFloat(document.getElementById('similarity-threshold').value)
    };
    
    try {
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('previewModal'));
        modal.show();
        
        const response = await fetch('/api/preview_user_data_matching', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(params)
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayPreviewResults(data.preview_results);
        } else {
            document.getElementById('preview-content').innerHTML = 
                `<div class="alert alert-danger">预览失败: ${data.error}</div>`;
        }
    } catch (error) {
        document.getElementById('preview-content').innerHTML = 
            `<div class="alert alert-danger">预览时发生错误: ${error.message}</div>`;
    }
}

// 显示预览结果
function displayPreviewResults(results) {
    let html = `<div class="alert alert-info">预览结果（前${results.length}条）</div>`;
    
    if (results.length === 0) {
        html += '<div class="alert alert-warning">未找到匹配结果，请调整匹配参数</div>';
    } else {
        html += '<div class="table-responsive"><table class="table table-striped"><thead><tr>';
        html += '<th>源记录</th><th>匹配记录</th><th>相似度</th><th>匹配字段</th>';
        html += '</tr></thead><tbody>';
        
        results.forEach(result => {
            html += `<tr>
                <td><code>${JSON.stringify(result.source_record).substring(0, 100)}...</code></td>
                <td><code>${JSON.stringify(result.matched_record).substring(0, 100)}...</code></td>
                <td><span class="badge bg-primary">${(result.similarity * 100).toFixed(1)}%</span></td>
                <td><small>${result.matched_fields.join(', ')}</small></td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
    }
    
    document.getElementById('preview-content').innerHTML = html;
}

// 启动完整匹配（从预览模态框）
function startFullMatching() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('previewModal'));
    modal.hide();
    document.getElementById('matching-form').dispatchEvent(new Event('submit'));
}

// 导出配置
function exportConfig() {
    if (!currentConfigId) {
        showError('配置ID不存在');
        return;
    }
    
    const config = {
        config_id: currentConfigId,
        algorithm_type: document.getElementById('algorithm-type').value,
        similarity_threshold: parseFloat(document.getElementById('similarity-threshold').value),
        batch_size: parseInt(document.getElementById('batch-size').value),
        max_results: parseInt(document.getElementById('max-results').value),
        advanced_options: {
            enable_preprocessing: document.getElementById('enable-preprocessing').checked,
            enable_caching: document.getElementById('enable-caching').checked,
            enable_parallel: document.getElementById('enable-parallel').checked
        },
        exported_at: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `matching_config_${currentConfigId}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showSuccess('配置已导出到文件');
}

// 查看历史
function viewHistory() {
    window.location.href = '/user_matching_history?config_id=' + currentConfigId;
}

// 工具函数
function showSuccess(message) {
    console.log('Success:', message);
    // 可以添加更好的提示组件
    alert('✅ ' + message);
}

function showError(message) {
    console.error('Error:', message);
    alert('❌ 错误: ' + message);
}

function showInfo(message) {
    console.info('Info:', message);
    alert('ℹ️ ' + message);
}
</script>

<style>
.header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
}

.feature-badge .badge {
    font-size: 0.9rem;
    padding: 8px 12px;
}

.info-item {
    margin-bottom: 10px;
}

.info-item label {
    font-size: 0.9rem;
    margin-bottom: 0;
}

.card {
    border: none;
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.form-text {
    font-size: 0.8rem;
}

.stat-item h4 {
    font-weight: 700;
    font-size: 1.8rem;
}

.progress {
    background-color: #e9ecef;
    border-radius: 10px;
}

.progress-bar {
    border-radius: 10px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
}

.table th {
    font-weight: 600;
    font-size: 0.9rem;
}

.table td {
    vertical-align: middle;
    font-size: 0.9rem;
}

.btn {
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-1px);
}

.btn-lg {
    padding: 12px 24px;
    font-size: 1rem;
}

.modal-xl {
    max-width: 90%;
}

#task-status-panel {
    border-left: 4px solid #ffc107;
}

.spinner-border {
    width: 2rem;
    height: 2rem;
}

code {
    background-color: #f8f9fa;
    padding: 2px 4px;
    border-radius: 3px;
    font-size: 0.85em;
}

@media (max-width: 768px) {
    .header h1 {
        font-size: 2rem;
    }
    
    .stat-item h4 {
        font-size: 1.4rem;
    }
    
    .btn-lg {
        padding: 10px 20px;
        font-size: 0.9rem;
    }
}
</style>
{% endblock %}
