{% extends "base.html" %}

{% block title %}çŸ¥è¯†å›¾è°±æµè§ˆ - æ¶ˆé˜²å•ä½å»ºç­‘æ•°æ®å…³è”ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- é¡µé¢æ ‡é¢˜ -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-project-diagram text-primary"></i> çŸ¥è¯†å›¾è°±æµè§ˆ</h2>
                    <p class="text-muted">æµè§ˆå’Œæ¢ç´¢å·²æ„å»ºçš„çŸ¥è¯†å›¾è°±ï¼ŒæŸ¥çœ‹å®ä½“ã€å…³ç³»å’ŒçŸ¥è¯†ä¸‰å…ƒç»„</p>
                </div>
                <div>
                    <button id="delete-all-btn" class="btn btn-outline-danger me-2" onclick="showDeleteAllConfirmation()">
                        <i class="fas fa-trash-alt"></i> åˆ é™¤æ‰€æœ‰å›¾è°±
                    </button>
                    <a href="/" class="btn btn-outline-secondary">
                        <i class="fas fa-home"></i> è¿”å›ä¸»é¡µ
                    </a>
                </div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯å¡ç‰‡ -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-white bg-primary">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 id="entity-count">
                                        <span class="loading-spinner" style="display: none;">
                                            <i class="fas fa-spinner fa-spin"></i>
                                        </span>
                                        <span class="count-value">-</span>
                                    </h4>
                                    <p class="card-text">å®ä½“æ€»æ•°</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-success">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 id="relation-count">-</h4>
                                    <p class="card-text">å…³ç³»æ€»æ•°</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-arrow-right fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-info">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 id="triple-count">-</h4>
                                    <p class="card-text">ä¸‰å…ƒç»„æ€»æ•°</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-link fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-warning">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 id="query-speed">-</h4>
                                    <p class="card-text">æŸ¥è¯¢é€Ÿåº¦(ms)</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-tachometer-alt fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æœç´¢å’Œè¿‡æ»¤å·¥å…· -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-search"></i> çŸ¥è¯†å›¾è°±æœç´¢</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" id="search-input" placeholder="è¾“å…¥å®ä½“åç§°æˆ–å…³ç³»ç±»å‹...">
                                <button class="btn btn-primary" onclick="searchKnowledgeGraph()">
                                    <i class="fas fa-search"></i> æœç´¢
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="entity-type-filter">
                                <option value="">æ‰€æœ‰å®ä½“ç±»å‹</option>
                                <option value="ORGANIZATION">æœºæ„ç»„ç»‡</option>
                                <option value="PERSON">äººå‘˜</option>
                                <option value="LOCATION">åœ°ç‚¹ä½ç½®</option>
                                <option value="IDENTIFIER">æ ‡è¯†ç¬¦</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="relation-type-filter">
                                <option value="">æ‰€æœ‰å…³ç³»ç±»å‹</option>
                                <option value="BELONGS_TO">å±äº</option>
                                <option value="LOCATED_IN">ä½äº</option>
                                <option value="MANAGES">ç®¡ç†</option>
                                <option value="SIMILAR_TO">ç›¸ä¼¼äº</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <div class="row">
                <!-- å®ä½“åˆ—è¡¨ -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-circle text-primary"></i> å®ä½“åˆ—è¡¨</h6>
                        </div>
                        <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                            <div id="entities-list">
                                <div class="text-center text-muted p-4">
                                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                                    <p class="mt-2">åŠ è½½å®ä½“æ•°æ®ä¸­...</p>
                                    <button class="btn btn-outline-primary btn-sm mt-2" onclick="window.location.reload()">åˆ·æ–°é¡µé¢</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å…³ç³»åˆ—è¡¨ -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-arrow-right text-success"></i> å…³ç³»åˆ—è¡¨</h6>
                        </div>
                        <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                            <div id="relations-list">
                                <div class="text-center text-muted p-4">
                                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                                    <p class="mt-2">åŠ è½½å…³ç³»æ•°æ®ä¸­...</p>
                                    <button class="btn btn-outline-primary btn-sm mt-2" onclick="window.location.reload()">åˆ·æ–°é¡µé¢</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¯¦æƒ…é¢æ¿ -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-info-circle text-info"></i> è¯¦ç»†ä¿¡æ¯</h6>
                        </div>
                        <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                            <div id="detail-panel">
                                <div class="text-center text-muted p-4">
                                    <i class="fas fa-mouse-pointer fa-2x"></i>
                                    <p class="mt-2">ç‚¹å‡»å®ä½“æˆ–å…³ç³»æŸ¥çœ‹è¯¦æƒ…</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <button class="btn btn-outline-primary" onclick="refreshData()">
                                        <i class="fas fa-sync-alt"></i> åˆ·æ–°æ•°æ®
                                    </button>
                                    <button class="btn btn-outline-success" onclick="exportData()">
                                        <i class="fas fa-download"></i> å¯¼å‡ºæ•°æ®
                                    </button>
                                </div>
                                <div>
                                    <button class="btn btn-primary" onclick="viewFullGraph()">
                                        <i class="fas fa-project-diagram"></i> å›¾è°±å¯è§†åŒ–
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åŠ è½½æç¤ºæ¨¡æ€æ¡† -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">æ­£åœ¨åŠ è½½çŸ¥è¯†å›¾è°±æ•°æ®...</p>
            </div>
        </div>
    </div>
</div>

<style>
.entity-item, .relation-item {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.entity-item:hover, .relation-item:hover {
    background-color: #f8f9fa;
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,123,255,0.15);
}

.entity-item.selected, .relation-item.selected {
    background-color: #e3f2fd;
    border-color: #2196f3;
}

.entity-type-badge {
    font-size: 0.75em;
    padding: 2px 8px;
    border-radius: 12px;
}

.relation-confidence {
    font-size: 0.8em;
    color: #6c757d;
}

.detail-section {
    border-bottom: 1px solid #eee;
    padding-bottom: 15px;
    margin-bottom: 15px;
}

.detail-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.property-list {
    list-style: none;
    padding: 0;
}

.property-list li {
    padding: 5px 0;
    border-bottom: 1px solid #f1f1f1;
}

.property-list li:last-child {
    border-bottom: none;
}
</style>

<script>
// å…¨å±€å˜é‡
let currentData = {
    entities: [],
    relations: [],
    stats: {}
};

// æµ‹è¯•å‡½æ•°ï¼šç›´æ¥è®¾ç½®ç»Ÿè®¡æ•°æ®
function testStatsDisplay() {
    console.log('ğŸ§ª æµ‹è¯•ç»Ÿè®¡æ•°æ®æ˜¾ç¤º...');
    
    // ç›´æ¥è®¾ç½®å®Œæ•´æµ‹è¯•æ•°æ®
    const testStats = {
        total_entities: 6259,
        total_relations: 1237,
        total_triples: 1237,
        total_labels: 9,
        performance_stats: {
            avg_query_time_ms: 5.6
        }
    };
    
    currentData.stats = testStats;
    updateStatsDisplay();
    
    console.log('âœ… æµ‹è¯•æ•°æ®å·²è®¾ç½®ï¼ŒåŒ…å«ä¸‰å…ƒç»„å’ŒæŸ¥è¯¢é€Ÿåº¦');
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('çŸ¥è¯†å›¾è°±æµè§ˆå™¨é¡µé¢åŠ è½½å®Œæˆ');
    
    // ç«‹å³å¼ºåˆ¶éšè—ä»»ä½•æ®‹ç•™çš„åŠ è½½çŠ¶æ€
    setTimeout(() => {
        console.log('ğŸ”§ æ‰§è¡Œå¼ºåˆ¶æ¨¡æ€æ¡†æ¸…ç†...');
        const loadingModal = document.getElementById('loadingModal');
        if (loadingModal) {
            loadingModal.style.display = 'none';
            loadingModal.classList.remove('show', 'fade');
            loadingModal.setAttribute('aria-hidden', 'true');
        }
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style.paddingRight = '';
        document.body.style.overflow = '';
        console.log('âœ… å¼ºåˆ¶æ¸…ç†å®Œæˆ');
    }, 50);
    
    // ç«‹å³æµ‹è¯•ç»Ÿè®¡æ˜¾ç¤º
    setTimeout(() => {
        testStatsDisplay();
    }, 100);
    
    // ç«‹å³å°è¯•åŠ è½½æ•°æ®
    setTimeout(() => {
        console.log('å¼€å§‹è‡ªåŠ¨åŠ è½½çŸ¥è¯†å›¾è°±æ•°æ®...');
        loadKnowledgeGraphData();
    }, 500);
    
    // å¦‚æœ5ç§’åè¿˜æ˜¯åŠ è½½çŠ¶æ€ï¼Œå¼ºåˆ¶é‡è¯•
    setTimeout(() => {
        const entitiesContainer = document.getElementById('entities-list');
        const relationsContainer = document.getElementById('relations-list');
        
        if (entitiesContainer && entitiesContainer.innerHTML.includes('åŠ è½½å®ä½“æ•°æ®ä¸­')) {
            console.log('æ£€æµ‹åˆ°å®ä½“åˆ—è¡¨ä»åœ¨åŠ è½½ï¼Œå¼ºåˆ¶é‡è¯•...');
            loadKnowledgeGraphData();
        }
        
        if (relationsContainer && (relationsContainer.innerHTML.includes('åŠ è½½å…³ç³»æ•°æ®ä¸­') || relationsContainer.innerHTML.includes('æ­£åœ¨åŠ è½½çŸ¥è¯†å›¾è°±æ•°æ®'))) {
            console.log('æ£€æµ‹åˆ°å…³ç³»åˆ—è¡¨ä»åœ¨åŠ è½½ï¼Œå¼ºåˆ¶æ¸…ç†å¹¶é‡è¯•...');
            // å¼ºåˆ¶æ¸…ç†æ¨¡æ€æ¡†
            const loadingModal = document.getElementById('loadingModal');
            if (loadingModal) {
                loadingModal.style.display = 'none';
                loadingModal.classList.remove('show', 'fade');
                loadingModal.setAttribute('aria-hidden', 'true');
            }
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.paddingRight = '';
            document.body.style.overflow = '';
            console.log('âœ… æ®‹ç•™åŠ è½½çŠ¶æ€æ¸…ç†å®Œæˆ');
            loadKnowledgeGraphData();
        }
    }, 5000);
    
    // å®šæœŸæ£€æŸ¥å¹¶æ¸…ç†ä»»ä½•æ®‹ç•™çš„åŠ è½½çŠ¶æ€
    setInterval(() => {
        const modalVisible = document.querySelector('#loadingModal[style*="block"]') || 
                           document.querySelector('#loadingModal.show') ||
                           document.querySelector('.modal-backdrop');
        if (modalVisible) {
            console.log('ğŸ”§ æ£€æµ‹åˆ°æ®‹ç•™æ¨¡æ€æ¡†ï¼Œæ‰§è¡Œæ¸…ç†...');
            const loadingModal = document.getElementById('loadingModal');
            if (loadingModal) {
                loadingModal.style.display = 'none';
                loadingModal.classList.remove('show', 'fade');
                loadingModal.setAttribute('aria-hidden', 'true');
            }
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.paddingRight = '';
            document.body.style.overflow = '';
            console.log('âœ… å®šæœŸæ¸…ç†å®Œæˆ');
        }
    }, 2000);
});

// åŠ è½½çŸ¥è¯†å›¾è°±æ•°æ®
async function loadKnowledgeGraphData() {
    console.log('å¼€å§‹åŠ è½½çŸ¥è¯†å›¾è°±æ•°æ®...');
    
    let loadingModal = null;
    try {
        // æ˜¾ç¤ºåŠ è½½æ¨¡æ€æ¡†
        const modalElement = document.getElementById('loadingModal');
        if (modalElement && typeof bootstrap !== 'undefined') {
            loadingModal = new bootstrap.Modal(modalElement);
            loadingModal.show();
            console.log('åŠ è½½æ¨¡æ€æ¡†å·²æ˜¾ç¤º');
        } else {
            console.warn('BootstrapæœªåŠ è½½æˆ–æ¨¡æ€æ¡†å…ƒç´ æœªæ‰¾åˆ°');
        }

        console.log('å¼€å§‹å¹¶è¡ŒAPIè¯·æ±‚...');
        
        // å¹¶è¡ŒåŠ è½½ç»Ÿè®¡ä¿¡æ¯ã€å®ä½“å’Œå…³ç³»æ•°æ® (å¢åŠ æ˜¾ç¤ºæ•°é‡)
        const [statsResponse, entitiesResponse, relationsResponse] = await Promise.all([
            fetch('/api/kg/falkor/stats'),
            fetch('/api/kg/falkor/entities?limit=500'),
            fetch('/api/kg/falkor/relations?limit=500')
        ]);

        console.log('APIå“åº”çŠ¶æ€:', {
            stats: statsResponse.status,
            entities: entitiesResponse.status, 
            relations: relationsResponse.status
        });

        // æ£€æŸ¥å“åº”çŠ¶æ€
        if (!statsResponse.ok || !entitiesResponse.ok || !relationsResponse.ok) {
            throw new Error(`APIè¯·æ±‚å¤±è´¥: stats=${statsResponse.status}, entities=${entitiesResponse.status}, relations=${relationsResponse.status}`);
        }

        // è§£æå“åº”
        const stats = await statsResponse.json();
        const entities = await entitiesResponse.json();
        const relations = await relationsResponse.json();

        console.log('APIæ•°æ®:', {
            stats: stats,
            entitiesCount: entities.entities ? entities.entities.length : 0,
            relationsCount: relations.relations ? relations.relations.length : 0
        });

        // æ›´æ–°å…¨å±€æ•°æ®
        currentData.stats = stats || {}; // ç›´æ¥ä½¿ç”¨statsï¼Œä¸éœ€è¦stats.stats
        currentData.entities = entities.entities || [];
        currentData.relations = relations.relations || [];
        
        console.log('æ•°æ®æ›´æ–°å®Œæˆ:', {
            statsKeys: Object.keys(currentData.stats),
            entitiesCount: currentData.entities.length,
            relationsCount: currentData.relations.length
        });

        // æ›´æ–°ç•Œé¢
        console.log('æ›´æ–°ç•Œé¢æ˜¾ç¤º...');
        updateStatsDisplay();
        updateEntitiesList();
        updateRelationsList();

        // ç«‹å³å¼ºåˆ¶éšè—åŠ è½½æ¨¡æ€æ¡†
        console.log('å¼€å§‹éšè—åŠ è½½æ¨¡æ€æ¡†...');
        
        // æ–¹æ³•1: Bootstrapæ–¹å¼éšè—
        if (loadingModal) {
            try {
                loadingModal.hide();
                console.log('âœ… Bootstrapæ¨¡æ€æ¡†éšè—æˆåŠŸ');
            } catch (e) {
                console.warn('Bootstrapæ¨¡æ€æ¡†éšè—å¤±è´¥:', e);
            }
        }
        
        // æ–¹æ³•2: å¼ºåˆ¶DOMéšè—ï¼ˆç«‹å³æ‰§è¡Œï¼‰
        const modalEl = document.getElementById('loadingModal');
        if (modalEl) {
            modalEl.style.display = 'none';
            modalEl.classList.remove('show', 'fade');
            modalEl.setAttribute('aria-hidden', 'true');
            console.log('âœ… DOMå¼ºåˆ¶éšè—æˆåŠŸ');
        }
        
        // æ–¹æ³•3: æ¸…ç†æ‰€æœ‰Bootstrapæ®‹ç•™
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
            backdrop.remove();
        });
        document.body.classList.remove('modal-open');
        document.body.style.paddingRight = '';
        document.body.style.overflow = '';
        
        console.log('âœ… æ‰€æœ‰æ¨¡æ€æ¡†æ¸…ç†å®Œæˆ');
        
        console.log('çŸ¥è¯†å›¾è°±æ•°æ®åŠ è½½å®Œæˆ');

    } catch (error) {
        console.error('åŠ è½½çŸ¥è¯†å›¾è°±æ•°æ®å¤±è´¥:', error);
        
        // é”™è¯¯æ—¶ä¹Ÿå¼ºåˆ¶éšè—åŠ è½½æ¨¡æ€æ¡†
        console.log('é”™è¯¯å‘ç”Ÿï¼Œå¼ºåˆ¶éšè—æ¨¡æ€æ¡†...');
        
        if (loadingModal) {
            try {
                loadingModal.hide();
            } catch (e) {
                console.warn('Bootstrapæ¨¡æ€æ¡†éšè—å¤±è´¥:', e);
            }
        }
        
        const modalElem = document.getElementById('loadingModal');
        if (modalElem) {
            modalElem.style.display = 'none';
            modalElem.classList.remove('show', 'fade');
            modalElem.setAttribute('aria-hidden', 'true');
        }
        
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
            backdrop.remove();
        });
        document.body.classList.remove('modal-open');
        document.body.style.paddingRight = '';
        document.body.style.overflow = '';
        
        console.log('âœ… é”™è¯¯å¤„ç†ä¸­çš„æ¨¡æ€æ¡†æ¸…ç†å®Œæˆ');
        
        showError('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message);
        
        // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
        document.getElementById('entities-list').innerHTML = `
            <div class="text-center text-danger p-4">
                <i class="fas fa-exclamation-triangle fa-2x"></i>
                <p class="mt-2">æ•°æ®åŠ è½½å¤±è´¥</p>
                <button class="btn btn-outline-primary btn-sm" onclick="loadKnowledgeGraphData()">é‡è¯•</button>
            </div>
        `;
        
        document.getElementById('relations-list').innerHTML = `
            <div class="text-center text-danger p-4">
                <i class="fas fa-exclamation-triangle fa-2x"></i>
                <p class="mt-2">æ•°æ®åŠ è½½å¤±è´¥</p>
                <button class="btn btn-outline-primary btn-sm" onclick="loadKnowledgeGraphData()">é‡è¯•</button>
            </div>
        `;
    }
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤º
function updateStatsDisplay() {
    const stats = currentData.stats;
    console.log('æ›´æ–°ç»Ÿè®¡æ˜¾ç¤ºï¼Œstatsæ•°æ®:', stats);
    
    // å¼ºåˆ¶æ›´æ–°DOMå…ƒç´ 
    const entityCountElement = document.getElementById('entity-count');
    const relationCountElement = document.getElementById('relation-count');
    const tripleCountElement = document.getElementById('triple-count');
    const querySpeedElement = document.getElementById('query-speed');
    
    if (entityCountElement) {
        entityCountElement.textContent = stats.total_entities || 0;
        console.log('å®ä½“æ•°æ›´æ–°:', stats.total_entities);
    }
    
    if (relationCountElement) {
        relationCountElement.textContent = stats.total_relations || 0;
        console.log('å…³ç³»æ•°æ›´æ–°:', stats.total_relations);
    }
    
    if (tripleCountElement) {
        // ä¼˜å…ˆä½¿ç”¨APIè¿”å›çš„å‡†ç¡®ä¸‰å…ƒç»„æ•°é‡
        const tripleCount = stats.total_triples || 
                           (stats.performance_stats && stats.performance_stats.triples_stored) || 
                           stats.triples_stored ||
                           0; // ç§»é™¤é”™è¯¯çš„ä¼°ç®—é€»è¾‘
        tripleCountElement.textContent = tripleCount;
        console.log('ä¸‰å…ƒç»„æ•°æ›´æ–°:', tripleCount, 'æ¥æºæ•°æ®:', {
            total_triples: stats.total_triples,
            performance_triples: stats.performance_stats?.triples_stored,
            stats_triples: stats.triples_stored
        });
    }
    
    if (querySpeedElement) {
        const queryTime = (stats.performance_stats && stats.performance_stats.avg_query_time_ms) || 
                         stats.avg_query_time_ms || 
                         stats.avg_query_time || 
                         '-';
        querySpeedElement.textContent = queryTime;
        console.log('æŸ¥è¯¢é€Ÿåº¦æ›´æ–°:', queryTime);
    }
    
    console.log('ç»Ÿè®¡æ˜¾ç¤ºæ›´æ–°å®Œæˆ:', {
        entities: stats.total_entities,
        relations: stats.total_relations,
        DOM_updated: true
    });
}

// æ›´æ–°å®ä½“åˆ—è¡¨
function updateEntitiesList() {
    const container = document.getElementById('entities-list');
    const entities = currentData.entities;
    
    console.log('æ›´æ–°å®ä½“åˆ—è¡¨ï¼Œå®ä½“æ•°æ®:', entities);
    console.log('å®ä½“æ•°é‡:', entities.length);

    if (entities.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted p-4">
                <i class="fas fa-database fa-2x"></i>
                <p class="mt-2">æš‚æ— å®ä½“æ•°æ®</p>
                <button class="btn btn-outline-primary btn-sm mt-2" onclick="loadKnowledgeGraphData()">é‡æ–°åŠ è½½</button>
            </div>
        `;
        return;
    }

    const html = entities.map(entity => `
        <div class="entity-item" onclick="selectEntity('${entity.id}')">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="mb-1">${entity.label || entity.id}</h6>
                    <span class="entity-type-badge badge bg-primary">${entity.type || 'Unknown'}</span>
                </div>
                <small class="text-muted">${entity.confidence ? (entity.confidence * 100).toFixed(1) + '%' : ''}</small>
            </div>
            <p class="text-muted small mb-0 mt-2">${entity.description || 'æ— æè¿°ä¿¡æ¯'}</p>
        </div>
    `).join('');

    container.innerHTML = html;
}

// æ›´æ–°å…³ç³»åˆ—è¡¨
function updateRelationsList() {
    const container = document.getElementById('relations-list');
    const relations = currentData.relations;
    
    console.log('æ›´æ–°å…³ç³»åˆ—è¡¨ï¼Œå…³ç³»æ•°æ®:', relations);
    console.log('å…³ç³»æ•°é‡:', relations.length);

    if (relations.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted p-4">
                <i class="fas fa-link fa-2x"></i>
                <p class="mt-2">æš‚æ— å…³ç³»æ•°æ®</p>
                <button class="btn btn-outline-primary btn-sm mt-2" onclick="loadKnowledgeGraphData()">é‡æ–°åŠ è½½</button>
            </div>
        `;
        return;
    }

         const html = relations.map((relation, index) => `
         <div class="relation-item" onclick="selectRelation('${index}')">
             <div class="d-flex justify-content-between align-items-start">
                 <div class="flex-grow-1">
                     <div class="relation-display">
                         <span class="subject text-primary">${relation.subject_label || 'Unknown'}</span>
                         <i class="fas fa-arrow-right mx-2 text-muted"></i>
                         <span class="predicate badge bg-primary">${relation.type || relation.predicate || 'Unknown'}</span>
                         <i class="fas fa-arrow-right mx-2 text-muted"></i>
                         <span class="object text-success">${relation.object_label || 'Unknown'}</span>
                     </div>
                     <div class="mt-1">
                         <small class="text-muted">
                             å®ä½“ â†’ ${relation.type || relation.predicate || 'Unknown'} â†’ å®ä½“
                         </small>
                     </div>
                 </div>
                 <small class="relation-confidence">${relation.confidence ? (relation.confidence * 100).toFixed(1) + '%' : ''}</small>
             </div>
         </div>
     `).join('');

    container.innerHTML = html;
}

 // é€‰æ‹©å®ä½“
 function selectEntity(entityId) {
     console.log('é€‰æ‹©å®ä½“:', entityId);
     
     // ç§»é™¤ä¹‹å‰çš„é€‰æ‹©
     document.querySelectorAll('.entity-item.selected').forEach(item => {
         item.classList.remove('selected');
     });
 
     // é€‰æ‹©å½“å‰å®ä½“
     event.target.closest('.entity-item').classList.add('selected');
 
     // æŸ¥æ‰¾å®ä½“æ•°æ®
     const entity = currentData.entities.find(e => e.id === entityId);
     if (entity) {
         showEntityDetails(entity);
         // åŠ è½½ç›¸å…³å…³ç³»
         loadEntityRelations(entityId);
     } else {
         console.error('æœªæ‰¾åˆ°å®ä½“:', entityId);
         showError('æœªæ‰¾åˆ°é€‰ä¸­çš„å®ä½“');
     }
 }

 // é€‰æ‹©å…³ç³»
 function selectRelation(relationIndex) {
     // ç§»é™¤ä¹‹å‰çš„é€‰æ‹©
     document.querySelectorAll('.relation-item.selected').forEach(item => {
         item.classList.remove('selected');
     });
 
     // é€‰æ‹©å½“å‰å…³ç³»
     event.target.closest('.relation-item').classList.add('selected');
 
     // é€šè¿‡ç´¢å¼•æŸ¥æ‰¾å…³ç³»æ•°æ®
     const relation = currentData.relations[parseInt(relationIndex)];
     if (relation) {
         showRelationDetails(relation);
     }
 }

// æ˜¾ç¤ºå®ä½“è¯¦æƒ…
function showEntityDetails(entity) {
    const container = document.getElementById('detail-panel');
    const properties = entity.properties || {};

    const html = `
        <div class="detail-section">
            <h6><i class="fas fa-circle text-primary"></i> å®ä½“ä¿¡æ¯</h6>
            <table class="table table-sm">
                <tr><td><strong>ID:</strong></td><td>${entity.id}</td></tr>
                <tr><td><strong>æ ‡ç­¾:</strong></td><td>${entity.label || 'æ— '}</td></tr>
                <tr><td><strong>ç±»å‹:</strong></td><td><span class="badge bg-primary">${entity.type}</span></td></tr>
                <tr><td><strong>ç½®ä¿¡åº¦:</strong></td><td>${entity.confidence ? (entity.confidence * 100).toFixed(1) + '%' : 'æ— '}</td></tr>
                <tr><td><strong>æè¿°:</strong></td><td>${entity.description || 'æ— æè¿°'}</td></tr>
            </table>
        </div>
        
        <div class="detail-section">
            <h6><i class="fas fa-tags"></i> å±æ€§ä¿¡æ¯</h6>
            ${Object.keys(properties).length > 0 ? `
                <table class="table table-sm">
                    ${Object.entries(properties).map(([key, value]) => `
                        <tr><td><strong>${key}:</strong></td><td>${value}</td></tr>
                    `).join('')}
                </table>
            ` : '<p class="text-muted">æ— å±æ€§ä¿¡æ¯</p>'}
        </div>
        
        <div class="detail-section">
            <h6><i class="fas fa-clock"></i> æ—¶é—´ä¿¡æ¯</h6>
            <table class="table table-sm">
                <tr><td><strong>åˆ›å»ºæ—¶é—´:</strong></td><td>${entity.created_time || 'æ— '}</td></tr>
                <tr><td><strong>æ›´æ–°æ—¶é—´:</strong></td><td>${entity.updated_time || 'æ— '}</td></tr>
            </table>
        </div>
    `;

    container.innerHTML = html;
}

 // æ˜¾ç¤ºå…³ç³»è¯¦æƒ…
 function showRelationDetails(relation) {
     const container = document.getElementById('detail-panel');
     const properties = relation.properties || {};
 
     const html = `
         <div class="detail-section">
             <h6><i class="fas fa-arrow-right text-success"></i> å…³ç³»ä¿¡æ¯</h6>
             <table class="table table-sm">
                 <tr><td><strong>ID:</strong></td><td>${relation.id || 'æ— '}</td></tr>
                 <tr><td><strong>å…³ç³»ç±»å‹:</strong></td><td><span class="badge bg-success">${relation.type || relation.predicate || 'æ— '}</span></td></tr>
                 <tr><td><strong>ä¸»ä½“:</strong></td><td>${relation.subject_label || 'æ— '}</td></tr>
                 <tr><td><strong>å®¢ä½“:</strong></td><td>${relation.object_label || 'æ— '}</td></tr>
                 <tr><td><strong>ç½®ä¿¡åº¦:</strong></td><td>${relation.confidence ? (relation.confidence * 100).toFixed(1) + '%' : 'æ— '}</td></tr>
                 <tr><td><strong>å›¾è°±æ¥æº:</strong></td><td>${relation.graph_name || 'æ— '}</td></tr>
             </table>
         </div>
         
         <div class="detail-section">
             <h6><i class="fas fa-link"></i> ä¸‰å…ƒç»„è¡¨ç¤º</h6>
             <div class="alert alert-info">
                 <strong>${relation.subject_label || 'ä¸»ä½“'}</strong> 
                 <i class="fas fa-arrow-right mx-2"></i>
                 <strong>${relation.type || relation.predicate || 'å…³ç³»'}</strong>
                 <i class="fas fa-arrow-right mx-2"></i>
                 <strong>${relation.object_label || 'å®¢ä½“'}</strong>
             </div>
         </div>
         
         ${Object.keys(properties).length > 0 ? `
         <div class="detail-section">
             <h6><i class="fas fa-tags"></i> å±æ€§ä¿¡æ¯</h6>
             <table class="table table-sm">
                 ${Object.entries(properties).map(([key, value]) => `
                     <tr><td><strong>${key}:</strong></td><td>${value}</td></tr>
                 `).join('')}
             </table>
         </div>
         ` : ''}
     `;
 
     container.innerHTML = html;
 }

// æœç´¢çŸ¥è¯†å›¾è°±
async function searchKnowledgeGraph() {
    const query = document.getElementById('search-input').value.trim();
    const entityType = document.getElementById('entity-type-filter').value;
    const relationType = document.getElementById('relation-type-filter').value;

    if (!query && !entityType && !relationType) {
        showError('è¯·è¾“å…¥æœç´¢æ¡ä»¶');
        return;
    }

    try {
        // æ„å»ºæŸ¥è¯¢å‚æ•°
        const params = new URLSearchParams();
        if (query) params.append('q', query);
        if (entityType) params.append('entity_type', entityType);
        if (relationType) params.append('relation_type', relationType);
        params.append('limit', '100');

        // æ‰§è¡Œæœç´¢
        const response = await fetch(`/api/kg/falkor/search?${params.toString()}`);
        const result = await response.json();

        if (result.error) {
            throw new Error(result.error);
        }

        // æ›´æ–°æœç´¢ç»“æœ
        currentData.entities = result.entities || [];
        currentData.relations = result.relations || [];

        updateEntitiesList();
        updateRelationsList();

        showSuccess(`æœç´¢å®Œæˆï¼Œæ‰¾åˆ° ${currentData.entities.length} ä¸ªå®ä½“å’Œ ${currentData.relations.length} ä¸ªå…³ç³»`);

    } catch (error) {
        console.error('æœç´¢å¤±è´¥:', error);
        showError('æœç´¢å¤±è´¥: ' + error.message);
    }
}

// åˆ·æ–°æ•°æ®
function refreshData() {
    loadKnowledgeGraphData();
}

// å¯¼å‡ºæ•°æ®
function exportData() {
    const data = {
        stats: currentData.stats,
        entities: currentData.entities,
        relations: currentData.relations,
        export_time: new Date().toISOString()
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `knowledge_graph_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showSuccess('æ•°æ®å¯¼å‡ºæˆåŠŸ');
}

 // æŸ¥çœ‹å®Œæ•´å›¾è°±
 function viewFullGraph() {
     // è·³è½¬åˆ°å›¾è°±å¯è§†åŒ–é¡µé¢
     window.open('/kg_visualization', '_blank');
 }



// åŠ è½½å®ä½“ç›¸å…³å…³ç³»
async function loadEntityRelations(entityId) {
    try {
        console.log('åŠ è½½å®ä½“å…³ç³»:', entityId);
        
        // ä»å½“å‰å…³ç³»æ•°æ®ä¸­ç­›é€‰ç›¸å…³å…³ç³»
        const relatedRelations = currentData.relations.filter(relation => 
            relation.subject_id === entityId || 
            relation.object_id === entityId ||
            (relation.subject && relation.subject.id === entityId) ||
            (relation.object && relation.object.id === entityId)
        );
        
        console.log('æ‰¾åˆ°ç›¸å…³å…³ç³»:', relatedRelations.length);
        
        // æ›´æ–°å…³ç³»åˆ—è¡¨æ˜¾ç¤º
        updateEntityRelationsList(relatedRelations, entityId);
        
    } catch (error) {
        console.error('åŠ è½½å®ä½“å…³ç³»å¤±è´¥:', error);
        showError('åŠ è½½å®ä½“å…³ç³»å¤±è´¥: ' + error.message);
    }
}

// æ›´æ–°å®ä½“ç›¸å…³å…³ç³»åˆ—è¡¨
function updateEntityRelationsList(relations, selectedEntityId) {
    const container = document.getElementById('relations-list');
    
    if (relations.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted p-4">
                <i class="fas fa-unlink fa-2x"></i>
                <p class="mt-2">è¯¥å®ä½“æš‚æ— å…³ç³»æ•°æ®</p>
                <small>å®ä½“ID: ${selectedEntityId}</small>
            </div>
        `;
        return;
    }
    
    const html = relations.map(relation => `
        <div class="relation-item" onclick="selectRelation('${relation.id || 'unknown'}')">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <h6 class="mb-1">${relation.predicate || relation.type || 'æœªçŸ¥å…³ç³»'}</h6>
                    <div class="small text-muted">
                        <div><strong>ä¸»ä½“:</strong> ${relation.subject_label || relation.subject?.label || 'æœªçŸ¥'}</div>
                        <div><strong>å®¢ä½“:</strong> ${relation.object_label || relation.object?.label || 'æœªçŸ¥'}</div>
                    </div>
                </div>
                <small class="text-muted">
                    ${relation.confidence ? (relation.confidence * 100).toFixed(1) + '%' : ''}
                </small>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}



// å·¥å…·å‡½æ•°
function showError(message) {
    const toast = `
        <div class="toast align-items-center text-white bg-danger border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-exclamation-triangle"></i> ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    showToast(toast);
}

function showSuccess(message) {
    const toast = `
        <div class="toast align-items-center text-white bg-success border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-check-circle"></i> ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    showToast(toast);
}

function showInfo(message) {
    const toast = `
        <div class="toast align-items-center text-white bg-info border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-info-circle"></i> ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    showToast(toast);
}

function showToast(toastHtml) {
    // åˆ›å»ºtoastå®¹å™¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    let container = document.getElementById('toast-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
    }

    // æ·»åŠ toast
    container.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = container.lastElementChild;
    const toast = new bootstrap.Toast(toastElement);
    toast.show();

    // è‡ªåŠ¨æ¸…ç†
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

// ============= åˆ é™¤åŠŸèƒ½ç›¸å…³ =============
let deleteAllConfirmModal = null;
let deleteAllProgressModal = null;

// åˆå§‹åŒ–åˆ é™¤ç›¸å…³æ¨¡æ€æ¡†
document.addEventListener('DOMContentLoaded', function() {
    deleteAllConfirmModal = new bootstrap.Modal(document.getElementById('deleteAllConfirmModal'));
    deleteAllProgressModal = new bootstrap.Modal(document.getElementById('deleteAllProgressModal'));
    
    // ç›‘å¬ç¡®è®¤å¤é€‰æ¡†å˜åŒ–
    document.getElementById('confirmDeleteAll').addEventListener('change', function() {
        document.getElementById('confirmDeleteAllBtn').disabled = !this.checked;
    });
});

// æ˜¾ç¤ºåˆ é™¤å…¨éƒ¨ç¡®è®¤å¯¹è¯æ¡†
async function showDeleteAllConfirmation() {
    try {
        // è·å–åˆ é™¤é¢„è§ˆä¿¡æ¯
        const response = await fetch('/api/kg/delete/preview', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        });

        if (!response.ok) {
            throw new Error(`è·å–åˆ é™¤é¢„è§ˆå¤±è´¥: ${response.status}`);
        }

        const data = await response.json();
        const preview = data.preview;

        // å¡«å……åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
        document.getElementById('delete-all-entities-count').textContent = preview.entities_to_delete || 0;
        document.getElementById('delete-all-relations-count').textContent = preview.relations_to_delete || 0;
        document.getElementById('delete-all-graphs-list').textContent = (preview.graphs_affected || []).join(', ');

        // é‡ç½®ç¡®è®¤çŠ¶æ€
        document.getElementById('confirmDeleteAll').checked = false;
        document.getElementById('confirmDeleteAllBtn').disabled = true;

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        deleteAllConfirmModal.show();

    } catch (error) {
        console.error('è·å–åˆ é™¤é¢„è§ˆå¤±è´¥:', error);
        alert(`è·å–åˆ é™¤é¢„è§ˆå¤±è´¥: ${error.message}`);
    }
}

// æ‰§è¡Œåˆ é™¤æ‰€æœ‰æ“ä½œ
async function executeDeleteAll() {
    try {
        // éšè—ç¡®è®¤å¯¹è¯æ¡†ï¼Œæ˜¾ç¤ºè¿›åº¦å¯¹è¯æ¡†
        deleteAllConfirmModal.hide();
        deleteAllProgressModal.show();

        // æ‰§è¡Œåˆ é™¤
        const response = await fetch('/api/kg/delete/all', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                confirm: true
            })
        });

        if (!response.ok) {
            throw new Error(`åˆ é™¤å¤±è´¥: ${response.status}`);
        }

        const result = await response.json();

        // éšè—è¿›åº¦å¯¹è¯æ¡†
        deleteAllProgressModal.hide();

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        alert(`âœ… æ‰€æœ‰çŸ¥è¯†å›¾è°±æ•°æ®å·²æˆåŠŸåˆ é™¤ï¼\nåˆ é™¤äº† ${result.projects_deleted}/${result.total_projects} ä¸ªé¡¹ç›®`);

        // åˆ·æ–°é¡µé¢æ•°æ®
        location.reload();

        console.log('åˆ é™¤æ“ä½œå®Œæˆ:', result);

    } catch (error) {
        // éšè—è¿›åº¦å¯¹è¯æ¡†
        deleteAllProgressModal.hide();
        
        console.error('åˆ é™¤æ“ä½œå¤±è´¥:', error);
        alert(`âŒ åˆ é™¤å¤±è´¥: ${error.message}`);
    }
}
</script>

<!-- åˆ é™¤å…¨éƒ¨ç¡®è®¤æ¨¡æ€æ¡† -->
<div class="modal fade" id="deleteAllConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ç¡®è®¤åˆ é™¤æ‰€æœ‰çŸ¥è¯†å›¾è°±
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <strong>âš ï¸ å±é™©æ“ä½œï¼š</strong>æ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰çŸ¥è¯†å›¾è°±æ•°æ®ï¼ŒåŒ…æ‹¬æ‰€æœ‰é¡¹ç›®ï¼æ­¤æ“ä½œä¸å¯é€†ï¼
                </div>
                <p>æ‚¨å³å°†åˆ é™¤<strong>æ‰€æœ‰çŸ¥è¯†å›¾è°±æ•°æ®</strong>ï¼ŒåŒ…æ‹¬ï¼š</p>
                <ul>
                    <li>å®ä½“æ•°æ®ï¼š<span id="delete-all-entities-count">-</span> ä¸ª</li>
                    <li>å…³ç³»æ•°æ®ï¼š<span id="delete-all-relations-count">-</span> ä¸ª</li>
                    <li>æ¶‰åŠå›¾è°±ï¼š<span id="delete-all-graphs-list">-</span></li>
                </ul>
                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="confirmDeleteAll">
                    <label class="form-check-label text-danger" for="confirmDeleteAll">
                        <strong>æˆ‘ç¡®è®¤è¦åˆ é™¤æ‰€æœ‰çŸ¥è¯†å›¾è°±æ•°æ®</strong>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteAllBtn" onclick="executeDeleteAll()" disabled>
                    <i class="fas fa-trash-alt me-1"></i>
                    ç¡®è®¤åˆ é™¤æ‰€æœ‰æ•°æ®
                </button>
            </div>
        </div>
    </div>
</div>

<!-- åˆ é™¤å…¨éƒ¨è¿›åº¦æ¨¡æ€æ¡† -->
<div class="modal fade" id="deleteAllProgressModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-danger mb-3" role="status">
                    <span class="visually-hidden">åˆ é™¤ä¸­...</span>
                </div>
                <h5>æ­£åœ¨åˆ é™¤æ‰€æœ‰çŸ¥è¯†å›¾è°±æ•°æ®...</h5>
                <p class="text-muted mb-0">è¯·ç¨å€™ï¼Œæ­£åœ¨æ¸…ç†æ‰€æœ‰æ•°æ®</p>
            </div>
        </div>
    </div>
</div>

{% endblock %}
