{% extends "base.html" %}

{% block title %}用户数据匹配结果 - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="header bg-gradient-success text-white p-5 rounded-3 mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-4 mb-3"><i class="fas fa-chart-line"></i> 用户数据匹配结果</h1>
                <p class="lead">查看和分析基于字段映射配置的智能匹配结果</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="feature-badge">
                    <span class="badge bg-light text-success fs-6">
                        <i class="fas fa-check-circle"></i> 匹配完成
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- 任务信息卡片 -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-info-circle"></i> 任务基本信息</h5>
        </div>
        <div class="card-body">
            <div id="task-loading" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载任务信息中...</span>
                </div>
                <p class="mt-2">正在加载任务信息...</p>
            </div>
            
            <div id="task-info" style="display: none;">
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-item">
                            <label class="fw-bold text-muted">任务ID:</label>
                            <span id="task-id" class="ms-2 font-monospace">-</span>
                        </div>
                        <div class="info-item">
                            <label class="fw-bold text-muted">配置ID:</label>
                            <span id="config-id" class="ms-2 font-monospace">-</span>
                        </div>
                        <div class="info-item">
                            <label class="fw-bold text-muted">匹配算法:</label>
                            <span id="algorithm-type" class="ms-2 badge bg-primary">-</span>
                        </div>
                        <div class="info-item">
                            <label class="fw-bold text-muted">相似度阈值:</label>
                            <span id="similarity-threshold" class="ms-2 badge bg-success">-</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item">
                            <label class="fw-bold text-muted">执行状态:</label>
                            <span id="task-status" class="ms-2 badge">-</span>
                        </div>
                        <div class="info-item">
                            <label class="fw-bold text-muted">开始时间:</label>
                            <span id="start-time" class="ms-2">-</span>
                        </div>
                        <div class="info-item">
                            <label class="fw-bold text-muted">完成时间:</label>
                            <span id="end-time" class="ms-2">-</span>
                        </div>
                        <div class="info-item">
                            <label class="fw-bold text-muted">执行时长:</label>
                            <span id="duration" class="ms-2">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 匹配统计卡片 -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-chart-bar"></i> 匹配统计概览</h5>
        </div>
        <div class="card-body">
            <div id="stats-loading" class="text-center py-4">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">加载统计信息中...</span>
                </div>
                <p class="mt-2">正在统计匹配结果...</p>
            </div>
            
            <div id="match-stats" style="display: none;">
                <div class="row text-center">
                    <div class="col-md-2">
                        <div class="stat-card">
                            <h3 id="total-processed" class="text-primary mb-1">0</h3>
                            <small class="text-muted">处理记录数</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <h3 id="total-matches" class="text-success mb-1">0</h3>
                            <small class="text-muted">匹配记录数</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <h3 id="match-rate" class="text-info mb-1">0%</h3>
                            <small class="text-muted">匹配成功率</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <h3 id="avg-similarity" class="text-warning mb-1">0%</h3>
                            <small class="text-muted">平均相似度</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <h3 id="high-confidence" class="text-danger mb-1">0</h3>
                            <small class="text-muted">高置信度</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <h3 id="execution-time" class="text-secondary mb-1">0s</h3>
                            <small class="text-muted">执行时间</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 匹配结果表格 -->
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-table"></i> 详细匹配结果</h5>
            <div class="d-flex gap-2 align-items-center">
                <!-- 页面大小选择器 -->
                <div class="d-flex align-items-center">
                    <label class="form-label mb-0 me-2 text-muted small">每页显示:</label>
                    <select id="page-size-selector" class="form-select form-select-sm" style="width: auto;" onchange="changePageSize()">
                        <option value="10">10条</option>
                        <option value="25">25条</option>
                        <option value="50" selected>50条</option>
                        <option value="100">100条</option>
                        <option value="200">200条</option>
                        <option value="500">500条</option>
                        <option value="1000">1000条</option>
                    </select>
                </div>
                
                <!-- 筛选下拉框 -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-filter"></i> 筛选
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="filterByConfidence('all')">全部结果</a></li>
                        <li><a class="dropdown-item" href="#" onclick="filterByConfidence('very_high')">极高置信度</a></li>
                        <li><a class="dropdown-item" href="#" onclick="filterByConfidence('high')">高置信度</a></li>
                        <li><a class="dropdown-item" href="#" onclick="filterByConfidence('medium')">中等置信度</a></li>
                        <li><a class="dropdown-item" href="#" onclick="filterByConfidence('low')">低置信度</a></li>
                    </ul>
                </div>
                
                <!-- 导出按钮组 -->
                <div class="dropdown">
                    <button class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-download"></i> 导出结果
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="exportResults()">
                            <i class="fas fa-filter"></i> 导出当前筛选结果 (<span id="filtered-count">0</span>条)
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportAllResults()">
                            <i class="fas fa-database"></i> 导出全部结果 (<span id="total-count">0</span>条)
                        </a></li>
                    </ul>
                </div>
                <button class="btn btn-outline-success btn-sm" onclick="refreshResults()">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
            </div>
        </div>
        <div class="card-body">
            <div id="results-loading" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载匹配结果中...</span>
                </div>
                <p class="mt-2">正在加载匹配结果...</p>
            </div>
            
            <div id="results-content" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th width="10%">序号</th>
                                <th width="15%">源记录关键字段</th>
                                <th width="15%">目标记录关键字段</th>
                                <th width="10%">目标表</th>
                                <th width="10%">相似度</th>
                                <th width="10%">置信度</th>
                                <th width="10%">匹配类型</th>
                                <th width="10%">匹配字段数</th>
                                <th width="10%">操作</th>
                            </tr>
                        </thead>
                        <tbody id="results-table">
                            <!-- 结果将在这里动态加载 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页控件 -->
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <div class="text-muted">
                        显示第 <span id="page-start">1</span> - <span id="page-end">10</span> 条，
                        共 <span id="total-results">0</span> 条结果
                    </div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="pagination">
                            <!-- 分页按钮将在这里动态生成 -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 详情查看模态框 -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-search"></i> 匹配结果详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="detail-content">
                    <!-- 详情内容将在这里显示 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="exportSingleResult()">导出此结果</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentTaskId = null;
let currentConfigId = null;
let currentPage = 1;
let pageSize = 50; // 增加默认页面大小
let totalResults = 0;
let allResults = [];
let filteredResults = [];
let currentFilter = 'all';
let selectedResult = null;

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    // 从URL参数获取任务ID和配置ID
    const urlParams = new URLSearchParams(window.location.search);
    currentTaskId = urlParams.get('task_id');
    currentConfigId = urlParams.get('config_id');
    
    if (currentTaskId && currentConfigId) {
        loadTaskInfo();
        loadMatchingResults();
    } else {
        showError('缺少任务ID或配置ID参数');
        setTimeout(() => {
            window.location.href = '/user_driven_field_mapping';
        }, 3000);
    }
});

// 加载任务信息
async function loadTaskInfo() {
    try {
        const response = await fetch(`/api/user_matching_progress?task_id=${currentTaskId}`);
        const data = await response.json();
        
        if (data.success) {
            // 隐藏加载提示，显示内容
            document.getElementById('task-loading').style.display = 'none';
            document.getElementById('task-info').style.display = 'block';
            
            // 更新任务信息
            document.getElementById('task-id').textContent = currentTaskId;
            document.getElementById('config-id').textContent = currentConfigId;
            
            const progress = data.progress || {};
            const status = data.status || 'unknown';
            
            // 更新状态显示
            const statusElement = document.getElementById('task-status');
            statusElement.textContent = getStatusText(status);
            statusElement.className = `ms-2 badge ${getStatusBadgeClass(status)}`;
            
            // 更新时间信息
            if (data.created_at) {
                document.getElementById('start-time').textContent = new Date(data.created_at).toLocaleString();
            }
            if (data.updated_at) {
                document.getElementById('end-time').textContent = new Date(data.updated_at).toLocaleString();
            }
            
            // 计算执行时长
            if (data.created_at && data.updated_at) {
                const duration = Math.floor((new Date(data.updated_at) - new Date(data.created_at)) / 1000);
                document.getElementById('duration').textContent = duration + '秒';
            }
            
        } else {
            showError('加载任务信息失败: ' + data.error);
        }
    } catch (error) {
        showError('加载任务信息时发生错误: ' + error.message);
    }
}

// 加载匹配结果
async function loadMatchingResults() {
    try {
        const response = await fetch(`/api/get_user_matching_results?task_id=${currentTaskId}&page=${currentPage}&page_size=${pageSize}`);
        const data = await response.json();
        
        if (data.success) {
            allResults = data.results || [];
            totalResults = data.total || 0;
            
            // 计算并显示统计信息
            displayStatistics(data.statistics || {});
            
            // 应用当前筛选
            applyFilter();
            
            // 显示结果表格
            displayResults();
            
            // 隐藏加载提示
            document.getElementById('results-loading').style.display = 'none';
            document.getElementById('stats-loading').style.display = 'none';
            document.getElementById('results-content').style.display = 'block';
            document.getElementById('match-stats').style.display = 'block';
            
        } else {
            showError('加载匹配结果失败: ' + data.error);
        }
    } catch (error) {
        showError('加载匹配结果时发生错误: ' + error.message);
    }
}

// 显示统计信息
function displayStatistics(stats) {
    document.getElementById('total-processed').textContent = stats.total_processed || 0;
    document.getElementById('total-matches').textContent = stats.total_matches || 0;
    document.getElementById('match-rate').textContent = (stats.match_rate || 0).toFixed(1) + '%';
    document.getElementById('avg-similarity').textContent = (stats.avg_similarity || 0).toFixed(1) + '%';
    document.getElementById('high-confidence').textContent = stats.high_confidence_count || 0;
    document.getElementById('execution-time').textContent = (stats.execution_time || 0) + 's';
    
    // 更新导出按钮中的计数显示
    document.getElementById('total-count').textContent = totalResults;
    document.getElementById('filtered-count').textContent = filteredResults.length;
}

// 应用筛选
function applyFilter() {
    if (currentFilter === 'all') {
        filteredResults = allResults;
    } else {
        filteredResults = allResults.filter(result => 
            result.match_details && result.match_details.confidence_level === currentFilter
        );
    }
    
    // 更新筛选结果计数
    document.getElementById('filtered-count').textContent = filteredResults.length;
}

// 显示结果表格
function displayResults() {
    const tbody = document.getElementById('results-table');
    tbody.innerHTML = '';
    
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, filteredResults.length);
    const pageResults = filteredResults.slice(startIndex, endIndex);
    
    pageResults.forEach((result, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${startIndex + index + 1}</td>
            <td>
                <small class="text-muted">
                    ${Object.entries(result.source_key_fields || {})
                        .map(([key, value]) => `${key}: ${value}`)
                        .join('<br>')
                    }
                </small>
            </td>
            <td>
                <small class="text-muted">
                    ${Object.entries(result.target_key_fields || {})
                        .map(([key, value]) => `${key}: ${value}`)
                        .join('<br>')
                    }
                </small>
            </td>
            <td><span class="badge bg-info">${result.target_table}</span></td>
            <td><span class="badge bg-primary">${(result.similarity_score * 100).toFixed(1)}%</span></td>
            <td><span class="badge ${getConfidenceBadgeClass(result.match_details?.confidence_level)}">${getConfidenceText(result.match_details?.confidence_level)}</span></td>
            <td><span class="badge bg-secondary">${getMatchTypeText(result.match_details?.match_type)}</span></td>
            <td>${result.match_details?.matched_field_count || 0}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewDetail('${result.source_id}')">
                    <i class="fas fa-eye"></i> 详情
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // 更新分页信息
    updatePagination();
}

// 更新分页
function updatePagination() {
    const totalPages = Math.ceil(filteredResults.length / pageSize);
    const startItem = (currentPage - 1) * pageSize + 1;
    const endItem = Math.min(currentPage * pageSize, filteredResults.length);
    
    document.getElementById('page-start').textContent = startItem;
    document.getElementById('page-end').textContent = endItem;
    document.getElementById('total-results').textContent = filteredResults.length;
    
    // 生成分页按钮
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    // 上一页按钮
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">上一页</a>`;
    pagination.appendChild(prevLi);
    
    // 页码按钮
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        pagination.appendChild(pageLi);
    }
    
    // 下一页按钮
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">下一页</a>`;
    pagination.appendChild(nextLi);
}

// 切换页面
function changePage(page) {
    const totalPages = Math.ceil(filteredResults.length / pageSize);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        displayResults();
    }
}

// 按置信度筛选
function filterByConfidence(confidence) {
    currentFilter = confidence;
    currentPage = 1;
    applyFilter();
    displayResults();
}

// 查看详情
function viewDetail(sourceId) {
    selectedResult = allResults.find(r => r.source_id === sourceId);
    if (selectedResult) {
        displayDetailModal(selectedResult);
        const modal = new bootstrap.Modal(document.getElementById('detailModal'));
        modal.show();
    }
}

// 显示详情模态框
function displayDetailModal(result) {
    const content = document.getElementById('detail-content');
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-database"></i> 源记录信息</h6>
                <div class="card">
                    <div class="card-body">
                        <p><strong>记录ID:</strong> <code>${result.source_id}</code></p>
                        <p><strong>来源表:</strong> <span class="badge bg-primary">${result.source_table}</span></p>
                        <p><strong>关键字段:</strong></p>
                        <ul class="list-unstyled">
                            ${Object.entries(result.source_key_fields || {})
                                .map(([key, value]) => `<li><code>${key}</code>: ${value}</li>`)
                                .join('')
                            }
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-bullseye"></i> 目标记录信息</h6>
                <div class="card">
                    <div class="card-body">
                        <p><strong>记录ID:</strong> <code>${result.target_id}</code></p>
                        <p><strong>目标表:</strong> <span class="badge bg-info">${result.target_table}</span></p>
                        <p><strong>关键字段:</strong></p>
                        <ul class="list-unstyled">
                            ${Object.entries(result.target_key_fields || {})
                                .map(([key, value]) => `<li><code>${key}</code>: ${value}</li>`)
                                .join('')
                            }
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <h6><i class="fas fa-chart-line"></i> 匹配详细信息</h6>
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <p><strong>相似度:</strong> <span class="badge bg-primary">${(result.similarity_score * 100).toFixed(2)}%</span></p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>置信度:</strong> <span class="badge ${getConfidenceBadgeClass(result.match_details?.confidence_level)}">${getConfidenceText(result.match_details?.confidence_level)}</span></p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>匹配类型:</strong> <span class="badge bg-secondary">${getMatchTypeText(result.match_details?.match_type)}</span></p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>匹配算法:</strong> <span class="badge bg-success">${result.match_algorithm}</span></p>
                            </div>
                        </div>
                        
                        <h6 class="mt-3">字段匹配得分:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr><th>字段对</th><th>得分</th></tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(result.match_details?.field_scores || {})
                                        .map(([field, score]) => `
                                            <tr>
                                                <td><code>${field}</code></td>
                                                <td><span class="badge bg-primary">${(score * 100).toFixed(1)}%</span></td>
                                            </tr>
                                        `).join('')
                                    }
                                </tbody>
                            </table>
                        </div>
                        
                        <p class="mt-3"><strong>匹配的字段:</strong> ${result.matched_fields.join(', ')}</p>
                        <p><strong>创建时间:</strong> ${new Date(result.created_at).toLocaleString()}</p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// 辅助函数
function getStatusText(status) {
    const statusTexts = {
        'completed': '已完成',
        'running': '运行中',
        'failed': '失败',
        'stopped': '已停止'
    };
    return statusTexts[status] || status;
}

function getStatusBadgeClass(status) {
    const classes = {
        'completed': 'bg-success',
        'running': 'bg-primary',
        'failed': 'bg-danger',
        'stopped': 'bg-warning'
    };
    return classes[status] || 'bg-secondary';
}

function getConfidenceText(confidence) {
    const texts = {
        'very_high': '极高',
        'high': '高',
        'medium': '中等',
        'low': '低',
        'very_low': '极低'
    };
    return texts[confidence] || confidence;
}

function getConfidenceBadgeClass(confidence) {
    const classes = {
        'very_high': 'bg-success',
        'high': 'bg-info',
        'medium': 'bg-warning',
        'low': 'bg-secondary',
        'very_low': 'bg-danger'
    };
    return classes[confidence] || 'bg-secondary';
}

function getMatchTypeText(matchType) {
    const texts = {
        'exact_match': '精确匹配',
        'strong_match': '强匹配',
        'good_match': '良好匹配',
        'weak_match': '弱匹配',
        'poor_match': '差匹配'
    };
    return texts[matchType] || matchType;
}

// 导出筛选后的结果
function exportResults() {
    const csvContent = generateCSV(filteredResults);
    downloadCSV(csvContent, `matching_results_filtered_${currentTaskId}.csv`);
}

// 导出全部结果
async function exportAllResults() {
    try {
        // 显示加载状态
        const loadingToast = document.createElement('div');
        loadingToast.className = 'alert alert-info position-fixed top-0 start-50 translate-middle-x';
        loadingToast.style.zIndex = '9999';
        loadingToast.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在获取全部结果数据...';
        document.body.appendChild(loadingToast);
        
        // 获取所有结果（不分页）
        const response = await fetch(`/api/get_user_matching_results?task_id=${currentTaskId}&page=1&page_size=999999`);
        const data = await response.json();
        
        if (data.success) {
            const csvContent = generateCSV(data.results || []);
            downloadCSV(csvContent, `matching_results_all_${currentTaskId}.csv`);
        } else {
            showError('导出全部结果失败: ' + data.error);
        }
        
        // 移除加载状态
        document.body.removeChild(loadingToast);
        
    } catch (error) {
        showError('导出全部结果时发生错误: ' + error.message);
    }
}

function exportSingleResult() {
    if (selectedResult) {
        const csvContent = generateCSV([selectedResult]);
        downloadCSV(csvContent, `matching_result_${selectedResult.source_id}.csv`);
    }
}

function generateCSV(results) {
    const headers = ['源记录ID', '目标记录ID', '源表', '目标表', '相似度', '置信度', '匹配类型', '匹配字段', '创建时间'];
    const rows = results.map(result => [
        result.source_id,
        result.target_id,
        result.source_table,
        result.target_table,
        (result.similarity_score * 100).toFixed(2) + '%',
        getConfidenceText(result.match_details?.confidence_level),
        getMatchTypeText(result.match_details?.match_type),
        result.matched_fields.join(';'),
        result.created_at
    ]);
    
    return [headers, ...rows].map(row => row.join(',')).join('\n');
}

function downloadCSV(content, filename) {
    const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

// 改变页面大小
function changePageSize() {
    const selector = document.getElementById('page-size-selector');
    pageSize = parseInt(selector.value);
    currentPage = 1; // 重置到第一页
    loadMatchingResults(); // 重新加载结果
}

function refreshResults() {
    loadMatchingResults();
}

function showError(message) {
    console.error('Error:', message);
    alert('❌ 错误: ' + message);
}
</script>

<style>
.header {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border: none;
}

.info-item {
    margin-bottom: 10px;
}

.info-item label {
    font-size: 0.9rem;
    margin-bottom: 0;
}

.stat-card {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 10px;
}

.stat-card h3 {
    font-weight: 700;
    font-size: 1.8rem;
}

.table th {
    font-weight: 600;
    font-size: 0.9rem;
}

.table td {
    vertical-align: middle;
    font-size: 0.9rem;
}

.card {
    border: none;
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.btn {
    border-radius: 6px;
    font-weight: 500;
}

.font-monospace {
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
}

@media (max-width: 768px) {
    .header h1 {
        font-size: 2rem;
    }
    
    .stat-card h3 {
        font-size: 1.4rem;
    }
}
</style>
{% endblock %}
