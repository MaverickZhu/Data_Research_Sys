# é¦–é¡µæ•°æ®è½½å…¥é—®é¢˜è§£å†³æ–¹æ¡ˆ

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆé¦–é¡µæ•°æ®æ— æ³•æ­£å¸¸æ˜¾ç¤ºï¼Œæ˜¾ç¤º"åŠ è½½ä¸­..."çŠ¶æ€ï¼Œä½†åå°APIæ•°æ®æ­£å¸¸ã€‚

## é—®é¢˜åˆ†æ

### 1. APIæ¥å£çŠ¶æ€ âœ…
é€šè¿‡æµ‹è¯•ç¡®è®¤ï¼š
- `/api/stats` æ¥å£æ­£å¸¸å·¥ä½œ
- è¿”å›å®Œæ•´çš„JSONæ•°æ®ç»“æ„
- æ•°æ®å†…å®¹æ­£ç¡®ï¼š
  - ç›‘ç£ç®¡ç†ç³»ç»Ÿï¼š1,659,320 æ¡è®°å½•
  - å®‰å…¨æ’æŸ¥ç³»ç»Ÿï¼š220,739 æ¡è®°å½•
  - åŒ¹é…ç»“æœï¼š28 æ¡è®°å½•

### 2. å‰ç«¯JavaScripté—®é¢˜ âŒ
å‘ç°çš„é—®é¢˜ï¼š
1. **ç¼ºå°‘åˆå§‹æ•°æ®åŠ è½½**ï¼šé¡µé¢åŠ è½½æ—¶æ²¡æœ‰è°ƒç”¨`refreshStats()`
2. **æ•°æ®å­—æ®µä¸åŒ¹é…**ï¼šJavaScriptä¸­ä½¿ç”¨çš„å­—æ®µåä¸APIè¿”å›æ•°æ®ä¸åŒ¹é…
3. **é”™è¯¯å¤„ç†ä¸å®Œå–„**ï¼šç¼ºå°‘è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯

## è§£å†³æ–¹æ¡ˆ

### 1. ä¿®å¤JavaScriptæ•°æ®åŠ è½½é€»è¾‘

#### ä¿®æ”¹æ–‡ä»¶ï¼š`src/web/templates/index.html`

**é—®é¢˜1ï¼šé¡µé¢åŠ è½½æ—¶ç¼ºå°‘æ•°æ®åˆ·æ–°**
```javascript
// ä¿®æ”¹å‰
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    loadRecentActivities();
    // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡æ•°æ®
    setInterval(refreshStats, 30000);
});

// ä¿®æ”¹å
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    loadRecentActivities();
    
    // ç«‹å³åŠ è½½ä¸€æ¬¡æ•°æ®
    refreshStats();
    
    // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡æ•°æ®
    setInterval(refreshStats, 30000);
});
```

**é—®é¢˜2ï¼šæ”¹è¿›refreshStatså‡½æ•°**
```javascript
// ä¿®æ”¹å
function refreshStats() {
    console.log('ğŸ”„ å¼€å§‹åˆ·æ–°ç»Ÿè®¡æ•°æ®...');
    
    fetch('/api/stats')
        .then(response => {
            console.log('ğŸ“¡ APIå“åº”çŠ¶æ€:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('ğŸ“Š æ”¶åˆ°æ•°æ®:', data);
            updateStatsDisplay(data);
        })
        .catch(error => {
            console.error('âŒ åˆ·æ–°ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            // æ˜¾ç¤ºé”™è¯¯æç¤º
            document.querySelectorAll('[id$="Count"]').forEach(el => {
                if (el.textContent === 'åŠ è½½ä¸­...') {
                    el.textContent = 'åŠ è½½å¤±è´¥';
                    el.style.color = '#dc3545';
                }
            });
        });
}
```

**é—®é¢˜3ï¼šä¿®å¤updateStatsDisplayå‡½æ•°**
```javascript
function updateStatsDisplay(stats) {
    console.log('æ”¶åˆ°ç»Ÿè®¡æ•°æ®:', stats);
    
    try {
        // æ›´æ–°é¡µå¤´ç»Ÿè®¡
        const totalUnits = (stats.data_sources.supervision_count || 0) + (stats.data_sources.inspection_count || 0);
        const totalMatches = stats.matching_stats.total_matches || 0;
        const matchRate = totalUnits > 0 ? (totalMatches / totalUnits * 100).toFixed(1) : 0;
        
        // å®‰å…¨æ›´æ–°å…ƒç´ 
        const updateElement = (id, value) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
                console.log(`âœ… æ›´æ–° ${id}: ${value}`);
            } else {
                console.warn(`âš ï¸ æœªæ‰¾åˆ°å…ƒç´ : ${id}`);
            }
        };
        
        updateElement('totalUnits', totalUnits.toLocaleString());
        updateElement('matchedUnits', totalMatches.toLocaleString());
        updateElement('matchRate', matchRate + '%');
        updateElement('supervisionCount', (stats.data_sources.supervision_count || 0).toLocaleString());
        updateElement('inspectionCount', (stats.data_sources.inspection_count || 0).toLocaleString());
        updateElement('matchResultsCount', (stats.data_sources.match_results_count || 0).toLocaleString());
        
        console.log('âœ… ç»Ÿè®¡æ•°æ®æ›´æ–°å®Œæˆ');
    } catch (error) {
        console.error('âŒ æ›´æ–°ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
    }
}
```

### 2. æ·»åŠ HTMLå…ƒç´ ID

ä¸ºæ•°æ®æ˜¾ç¤ºå…ƒç´ æ·»åŠ IDå±æ€§ï¼š
```html
<!-- ç›‘ç£ç®¡ç†ç³»ç»Ÿ -->
<h2 class="text-primary" id="supervisionCount">{{ stats.data_sources.supervision_count or 0 }}</h2>

<!-- å®‰å…¨æ’æŸ¥ç³»ç»Ÿ -->
<h2 class="text-success" id="inspectionCount">{{ stats.data_sources.inspection_count or 0 }}</h2>

<!-- åŒ¹é…ç»“æœ -->
<h2 class="text-info" id="matchResultsCount">{{ stats.data_sources.match_results_count or 0 }}</h2>
```

### 3. æ·»åŠ æµ‹è¯•é¡µé¢

åˆ›å»ºäº†ä¸“é—¨çš„æµ‹è¯•é¡µé¢ `/test` ç”¨äºè°ƒè¯•æ•°æ®åŠ è½½ï¼š
- å®æ—¶æ˜¾ç¤ºAPIå“åº”
- è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
- é”™è¯¯å¤„ç†å’ŒçŠ¶æ€æ˜¾ç¤º

## æµ‹è¯•éªŒè¯

### 1. APIæ¥å£æµ‹è¯•
```bash
python scripts/test_api_endpoints.py
```
ç»“æœï¼šâœ… APIæ¥å£æ­£å¸¸ï¼Œæ•°æ®å®Œæ•´

### 2. é¦–é¡µæ•°æ®æµ‹è¯•
```bash
python scripts/test_homepage_data.py
```
ç»“æœï¼šâœ… æ•°æ®æºæ­£å¸¸ï¼ŒAPIå“åº”æ­£ç¡®

### 3. æµè§ˆå™¨æµ‹è¯•
è®¿é—® `http://127.0.0.1:8888/test` è¿›è¡Œå®æ—¶è°ƒè¯•

## è°ƒè¯•å»ºè®®

å¦‚æœé¦–é¡µæ•°æ®ä»ç„¶æ— æ³•æ˜¾ç¤ºï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤è°ƒè¯•ï¼š

1. **å¯åŠ¨ç³»ç»Ÿ**
   ```bash
   python start_system.py
   ```

2. **è®¿é—®æµ‹è¯•é¡µé¢**
   ```
   http://127.0.0.1:8888/test
   ```

3. **æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°**
   - æŒ‰F12æ‰“å¼€å¼€å‘è€…å·¥å…·
   - æŸ¥çœ‹Consoleæ ‡ç­¾é¡µçš„JavaScripté”™è¯¯
   - æŸ¥çœ‹Networkæ ‡ç­¾é¡µçš„APIè¯·æ±‚

4. **æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶**
   ```
   logs/app_20250613.log
   logs/error_20250613.log
   ```

## é¢„æœŸç»“æœ

ä¿®å¤åï¼Œé¦–é¡µåº”è¯¥èƒ½å¤Ÿï¼š
1. âœ… æ­£å¸¸åŠ è½½ç»Ÿè®¡æ•°æ®
2. âœ… å®æ—¶æ›´æ–°æ•°æ®æ˜¾ç¤º
3. âœ… æ˜¾ç¤ºæ­£ç¡®çš„æ•°å€¼æ ¼å¼
4. âœ… æä¾›è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯

## æŠ€æœ¯è¦ç‚¹

1. **æ•°æ®æµç¨‹**ï¼šæœåŠ¡å™¨ç«¯æ¸²æŸ“ â†’ JavaScriptå¼‚æ­¥æ›´æ–°
2. **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸æ•è·å’Œç”¨æˆ·æç¤º
3. **è°ƒè¯•æ”¯æŒ**ï¼šè¯¦ç»†çš„æ§åˆ¶å°æ—¥å¿—è¾“å‡º
4. **æ•°æ®æ ¼å¼**ï¼šä½¿ç”¨toLocaleString()æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤º

## ç›¸å…³æ–‡ä»¶

- `src/web/templates/index.html` - é¦–é¡µæ¨¡æ¿
- `src/web/app.py` - Flaskåº”ç”¨å’ŒAPIæ¥å£
- `scripts/test_api_endpoints.py` - APIæµ‹è¯•è„šæœ¬
- `scripts/test_homepage_data.py` - é¦–é¡µæ•°æ®æµ‹è¯•è„šæœ¬ 