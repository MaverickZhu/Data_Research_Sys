{% extends "base.html" %}

{% block title %}数据分析 - 智能关联匹配系统V2.0{% endblock %}

{% block extra_css %}
<style>
    .analysis-container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
    }
    
    .step-indicator {
        display: flex;
        justify-content: center;
        margin: 30px 0;
    }
    
    .step {
        padding: 10px 20px;
        background: #e9ecef;
        color: #6c757d;
        border-radius: 20px;
        margin: 0 5px;
        font-size: 14px;
        font-weight: 600;
    }
    
    .step.active {
        background: #007bff;
        color: white;
    }
    
    .step.completed {
        background: #28a745;
        color: white;
    }
    
    .info-card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        margin: 20px 0;
        box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        border-left: 5px solid #007bff;
    }
    
    .card-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f8f9fa;
    }
    
    .card-title {
        font-size: 20px;
        font-weight: 600;
        color: #333;
        margin: 0;
        margin-left: 10px;
    }
    
    .card-icon {
        font-size: 24px;
        color: #007bff;
    }
    
    .file-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }
    
    .meta-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        border: 1px solid #e9ecef;
    }
    
    .meta-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 8px;
    }
    
    .meta-value {
        font-size: 18px;
        color: #333;
        font-weight: 700;
    }
    
    .quality-score {
        text-align: center;
        margin: 20px 0;
    }
    
    .score-circle {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        margin: 0 auto 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: 700;
        color: white;
        position: relative;
    }
    
    .score-excellent { background: linear-gradient(45deg, #28a745, #20c997); }
    .score-good { background: linear-gradient(45deg, #17a2b8, #007bff); }
    .score-average { background: linear-gradient(45deg, #ffc107, #fd7e14); }
    .score-poor { background: linear-gradient(45deg, #dc3545, #e83e8c); }
    
    .data-preview {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 15px rgba(0,0,0,0.1);
    }
    
    .table-container {
        max-height: 400px;
        overflow: auto;
        border: 1px solid #dee2e6;
    }
    
    .preview-table {
        width: 100%;
        margin: 0;
        font-size: 14px;
    }
    
    .preview-table th {
        background: #f8f9fa;
        color: #495057;
        font-weight: 600;
        padding: 12px 8px;
        border-bottom: 2px solid #dee2e6;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .preview-table td {
        padding: 10px 8px;
        border-bottom: 1px solid #f1f3f4;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .preview-table tr:hover {
        background: #f8f9fa;
    }
    
    .column-analysis {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    
    .column-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .column-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .column-name {
        font-weight: 600;
        color: #333;
        margin-left: 10px;
        flex: 1;
    }
    
    .column-type {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .type-organization { background: #e7f3ff; color: #0066cc; }
    .type-person { background: #fff2e7; color: #cc6600; }
    .type-address { background: #e7ffe7; color: #006600; }
    .type-identifier { background: #ffe7f3; color: #cc0066; }
    .type-numeric { background: #f3e7ff; color: #6600cc; }
    .type-text { background: #f0f0f0; color: #666; }
    .type-datetime { background: #e7f7ff; color: #0088cc; }
    
    .column-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 10px;
    }
    
    .stat-item {
        text-align: center;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 4px;
    }
    
    .stat-label {
        font-size: 11px;
        color: #666;
        text-transform: uppercase;
    }
    
    .stat-value {
        font-size: 14px;
        font-weight: 600;
        color: #333;
    }
    
    .action-buttons {
        text-align: center;
        margin: 30px 0;
    }
    
    .btn-action {
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 0 10px;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-primary {
        background: linear-gradient(45deg, #007bff, #0056b3);
        color: white;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        text-decoration: none;
        color: white;
    }
    
    .loading-spinner {
        text-align: center;
        padding: 40px;
    }
    
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .error-message {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        text-align: center;
    }
    
    .schema-suggestions {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
    }
    
    .suggestion-header {
        font-weight: 600;
        color: #0066cc;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }
    
    .suggestion-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }
    
    .suggestion-item {
        background: white;
        padding: 15px;
        border-radius: 6px;
        border-left: 4px solid #007bff;
    }
    
    .suggestion-type {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
    }
    
    .suggestion-desc {
        font-size: 14px;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 步骤指示器 -->
    <div class="step-indicator">
        <div class="step completed">1. 数据上传</div>
        <div class="step active">2. 数据分析</div>
        <div class="step">3. 字段映射</div>
        <div class="step">4. 知识图谱构建</div>
    </div>
    
    <div class="analysis-container">
        <!-- 加载状态 -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
            <p>正在分析数据，请稍候...</p>
        </div>
        
        <!-- 错误信息 -->
        <div class="error-message" id="errorMessage" style="display: none;"></div>
        
        <!-- 分析结果容器 -->
        <div id="analysisResults" style="display: none;">
            <!-- 文件基本信息 -->
            <div class="info-card">
                <div class="card-header">
                    <i class="fas fa-file-csv card-icon"></i>
                    <h3 class="card-title">文件基本信息</h3>
                </div>
                
                <div class="file-meta" id="fileMeta">
                    <!-- 动态填充文件元信息 -->
                </div>
            </div>
            
            <!-- 数据质量评分 -->
            <div class="info-card">
                <div class="card-header">
                    <i class="fas fa-chart-line card-icon"></i>
                    <h3 class="card-title">数据质量评分</h3>
                </div>
                
                <div class="quality-score">
                    <div class="score-circle" id="qualityCircle">
                        <span id="qualityScoreText">--</span>
                    </div>
                    <p id="qualityDescription">正在计算数据质量...</p>
                </div>
            </div>
            
            <!-- 字段分析 -->
            <div class="info-card">
                <div class="card-header">
                    <i class="fas fa-columns card-icon"></i>
                    <h3 class="card-title">字段类型分析</h3>
                </div>
                
                <div class="column-analysis" id="columnAnalysis">
                    <!-- 动态填充字段分析 -->
                </div>
            </div>
            
            <!-- 智能模式建议 -->
            <div class="schema-suggestions" id="schemaSuggestions">
                <div class="suggestion-header">
                    <i class="fas fa-lightbulb"></i>
                    <span style="margin-left: 10px;">智能模式建议</span>
                </div>
                <div class="suggestion-list" id="suggestionList">
                    <!-- 动态填充建议 -->
                </div>
            </div>
            
            <!-- 数据预览 -->
            <div class="info-card">
                <div class="card-header">
                    <i class="fas fa-table card-icon"></i>
                    <h3 class="card-title">数据预览 (前10行)</h3>
                </div>
                
                <div class="data-preview">
                    <div class="table-container">
                        <table class="table preview-table" id="dataPreviewTable">
                            <!-- 动态填充数据预览 -->
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- 操作按钮 -->
            <div class="action-buttons">
                <a href="/csv_upload" class="btn-action btn-secondary">
                    <i class="fas fa-arrow-left"></i> 重新上传
                </a>
                <a href="#" class="btn-action btn-primary" id="nextStepBtn">
                    <i class="fas fa-arrow-right"></i> 配置字段映射
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const fileId = urlParams.get('file_id');
    
    if (!fileId) {
        showError('缺少文件ID参数');
        return;
    }
    
    // 加载文件分析结果
    loadFileAnalysis(fileId);
    
    // 下一步按钮事件
    document.getElementById('nextStepBtn').addEventListener('click', (e) => {
        e.preventDefault();
        // 跳转到字段映射页面
        window.location.href = `/field_mapping?file_id=${fileId}`;
    });
});

async function loadFileAnalysis(fileId) {
    try {
        const response = await fetch(`/api/get_file_analysis/${fileId}`);
        const result = await response.json();
        
        if (result.success) {
            displayAnalysisResults(result.data);
        } else {
            showError(result.error || '获取文件分析结果失败');
        }
    } catch (error) {
        showError('网络请求失败: ' + error.message);
    }
}

function displayAnalysisResults(data) {
    // 隐藏加载动画
    document.getElementById('loadingSpinner').style.display = 'none';
    document.getElementById('analysisResults').style.display = 'block';
    
    // 显示文件基本信息
    displayFileInfo(data);
    
    // 显示数据质量评分
    displayQualityScore(data.quality_score);
    
    // 显示字段分析
    displayColumnAnalysis(data.data_types, data.columns);
    
    // 显示模式建议
    displaySchemaSuggestions(data.schema_detection);
    
    // 显示数据预览
    displayDataPreview(data.sample_data, data.columns);
}

function displayFileInfo(data) {
    const fileMeta = document.getElementById('fileMeta');
    
    const metaItems = [
        { label: '文件名', value: data.filename },
        { label: '文件大小', value: formatFileSize(data.file_size) },
        { label: '数据行数', value: data.row_count.toLocaleString() },
        { label: '字段数量', value: data.column_count },
        { label: '编码格式', value: data.encoding },
        { label: '分隔符', value: data.delimiter === ',' ? '逗号(,)' : data.delimiter },
        { label: '上传时间', value: new Date(data.upload_time).toLocaleString() },
        { label: '数据质量', value: data.quality_score + '%' }
    ];
    
    fileMeta.innerHTML = metaItems.map(item => `
        <div class="meta-item">
            <div class="meta-label">${item.label}</div>
            <div class="meta-value">${item.value}</div>
        </div>
    `).join('');
}

function displayQualityScore(score) {
    const qualityCircle = document.getElementById('qualityCircle');
    const qualityScoreText = document.getElementById('qualityScoreText');
    const qualityDescription = document.getElementById('qualityDescription');
    
    qualityScoreText.textContent = score + '%';
    
    // 根据分数设置颜色和描述
    let className, description;
    if (score >= 90) {
        className = 'score-excellent';
        description = '数据质量优秀，可以直接进行分析';
    } else if (score >= 75) {
        className = 'score-good';
        description = '数据质量良好，建议进行少量清理';
    } else if (score >= 60) {
        className = 'score-average';
        description = '数据质量一般，需要进行数据清理';
    } else {
        className = 'score-poor';
        description = '数据质量较差，强烈建议进行数据清理';
    }
    
    qualityCircle.className = `score-circle ${className}`;
    qualityDescription.textContent = description;
}

function displayColumnAnalysis(dataTypes, columns) {
    const columnAnalysis = document.getElementById('columnAnalysis');
    
    const columnCards = columns.map(column => {
        const dataType = dataTypes[column] || 'text';
        const typeClass = `type-${dataType}`;
        const typeLabel = getTypeLabel(dataType);
        
        // 生成模拟统计数据
        const stats = generateColumnStats(dataType);
        
        return `
            <div class="column-card">
                <div class="column-header">
                    <i class="fas ${getTypeIcon(dataType)}"></i>
                    <div class="column-name">${column}</div>
                    <span class="column-type ${typeClass}">${typeLabel}</span>
                </div>
                <div class="column-stats">
                    <div class="stat-item">
                        <div class="stat-label">唯一值</div>
                        <div class="stat-value">${stats.unique}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">缺失值</div>
                        <div class="stat-value">${stats.missing}</div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    columnAnalysis.innerHTML = columnCards;
}

function displaySchemaSuggestions(schemaDetection) {
    const suggestionList = document.getElementById('suggestionList');
    
    if (!schemaDetection || !schemaDetection.suggestions) {
        suggestionList.innerHTML = '<p>暂无智能建议</p>';
        return;
    }
    
    const suggestions = schemaDetection.suggestions.map(suggestion => `
        <div class="suggestion-item">
            <div class="suggestion-type">${suggestion.type}</div>
            <div class="suggestion-desc">${suggestion.description}</div>
        </div>
    `).join('');
    
    suggestionList.innerHTML = suggestions;
}

function displayDataPreview(sampleData, columns) {
    const table = document.getElementById('dataPreviewTable');
    
    // 生成表头
    const headers = columns.map(col => `<th>${col}</th>`).join('');
    
    // 生成数据行
    const rows = sampleData.map(row => {
        const cells = columns.map(col => {
            const value = row[col] || '';
            return `<td title="${value}">${value}</td>`;
        }).join('');
        return `<tr>${cells}</tr>`;
    }).join('');
    
    table.innerHTML = `
        <thead>
            <tr>${headers}</tr>
        </thead>
        <tbody>
            ${rows}
        </tbody>
    `;
}

function getTypeLabel(dataType) {
    const typeLabels = {
        'organization': '组织机构',
        'person': '人员姓名',
        'address': '地址位置',
        'identifier': '标识符',
        'numeric': '数值型',
        'text': '文本型',
        'datetime': '日期时间'
    };
    return typeLabels[dataType] || '未知类型';
}

function getTypeIcon(dataType) {
    const typeIcons = {
        'organization': 'fa-building',
        'person': 'fa-user',
        'address': 'fa-map-marker-alt',
        'identifier': 'fa-id-card',
        'numeric': 'fa-calculator',
        'text': 'fa-font',
        'datetime': 'fa-calendar'
    };
    return typeIcons[dataType] || 'fa-question';
}

function generateColumnStats(dataType) {
    // 根据数据类型生成模拟统计数据
    const baseUnique = Math.floor(Math.random() * 100) + 10;
    const baseMissing = Math.floor(Math.random() * 5);
    
    return {
        unique: baseUnique,
        missing: baseMissing
    };
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showError(message) {
    document.getElementById('loadingSpinner').style.display = 'none';
    const errorElement = document.getElementById('errorMessage');
    errorElement.textContent = message;
    errorElement.style.display = 'block';
}
</script>
{% endblock %}
