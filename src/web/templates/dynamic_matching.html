{% extends "base.html" %}

{% block title %}智能匹配 - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="header bg-light p-5 rounded-3 mb-4">
        <h1 class="display-4"><i class="fas fa-magic"></i> 智能匹配</h1>
        <p class="lead text-muted">基于您的字段映射配置执行智能数据匹配。</p>
    </div>

    <!-- 配置信息卡片 -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-cog"></i> 匹配配置信息</h5>
        </div>
        <div class="card-body">
            <div id="config-info" class="row">
                <div class="col-md-6">
                    <p><strong>配置ID:</strong> <span id="config-id">加载中...</span></p>
                    <p><strong>源表:</strong> <span id="source-table">加载中...</span></p>
                    <p><strong>目标表:</strong> <span id="target-tables">加载中...</span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>创建时间:</strong> <span id="created-at">加载中...</span></p>
                    <p><strong>映射字段数:</strong> <span id="mapping-count">加载中...</span></p>
                    <p><strong>状态:</strong> <span id="config-status" class="badge bg-success">活跃</span></p>
                </div>
            </div>
            
            <!-- 映射详情 -->
            <div class="mt-3">
                <h6><i class="fas fa-list"></i> 字段映射详情</h6>
                <div id="mapping-details" class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>源字段</th>
                                <th>目标字段</th>
                                <th>目标表</th>
                                <th>相似度</th>
                            </tr>
                        </thead>
                        <tbody id="mapping-list">
                            <tr><td colspan="4" class="text-center">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 匹配任务面板 -->
    <div class="card">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-play"></i> 启动智能匹配任务</h5>
        </div>
        <div class="card-body">
            <form id="dynamic-matching-form">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="match-type" class="form-label">匹配类型</label>
                        <select id="match-type" class="form-select">
                            <option value="both">智能匹配（精确+模糊）</option>
                            <option value="exact">仅精确匹配</option>
                            <option value="fuzzy">仅模糊匹配</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="batch-size" class="form-label">批处理大小</label>
                        <select id="batch-size" class="form-select">
                            <option value="100" selected>标准（100条/批）</option>
                            <option value="200">较大（200条/批）</option>
                            <option value="500">大批量（500条/批）</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="similarity-threshold" class="form-label">相似度阈值</label>
                        <select id="similarity-threshold" class="form-select">
                            <option value="0.6">宽松（60%）</option>
                            <option value="0.7" selected>标准（70%）</option>
                            <option value="0.8">严格（80%）</option>
                            <option value="0.9">非常严格（90%）</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="max-results" class="form-label">最大结果数</label>
                        <select id="max-results" class="form-select">
                            <option value="5">前5个</option>
                            <option value="10" selected>前10个</option>
                            <option value="20">前20个</option>
                            <option value="50">前50个</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-4">
                    <button type="submit" class="btn btn-success btn-lg me-2">
                        <i class="fas fa-rocket"></i> 启动匹配任务
                    </button>
                    <button type="button" class="btn btn-secondary btn-lg me-2" onclick="previewMatching()">
                        <i class="fas fa-eye"></i> 预览匹配
                    </button>
                    <button type="button" class="btn btn-info btn-lg" onclick="viewHistory()">
                        <i class="fas fa-history"></i> 历史任务
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 任务状态面板 -->
    <div class="card mt-4" id="task-status-panel" style="display: none;">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-tasks"></i> 任务执行状态</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <div class="progress mb-3" style="height: 25px;">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%">0%</div>
                    </div>
                    <p id="status-text">准备启动...</p>
                    <p id="stats-text">统计信息将在这里显示</p>
                </div>
                <div class="col-md-4 text-end">
                    <button id="stop-task-btn" class="btn btn-danger" onclick="stopTask()" style="display: none;">
                        <i class="fas fa-stop"></i> 停止任务
                    </button>
                    <button id="view-results-btn" class="btn btn-primary" onclick="viewResults()" style="display: none;">
                        <i class="fas fa-chart-bar"></i> 查看结果
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentConfigId = null;
let currentTaskId = null;
let progressTimer = null;

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    // 从URL参数获取配置ID
    const urlParams = new URLSearchParams(window.location.search);
    currentConfigId = urlParams.get('config_id');
    
    if (currentConfigId) {
        loadMappingConfig();
    } else {
        showError('缺少配置ID参数');
    }
    
    // 绑定表单提交事件
    document.getElementById('dynamic-matching-form').addEventListener('submit', startMatching);
});

// 加载映射配置信息
async function loadMappingConfig() {
    try {
        const response = await fetch(`/api/get_field_mapping_config?config_id=${currentConfigId}`);
        const data = await response.json();
        
        if (data.success) {
            const config = data.config;
            
            // 更新配置信息
            document.getElementById('config-id').textContent = config.config_id;
            document.getElementById('source-table').textContent = config.source_table;
            document.getElementById('target-tables').textContent = config.target_tables.join(', ');
            document.getElementById('created-at').textContent = new Date(config.created_at).toLocaleString();
            document.getElementById('mapping-count').textContent = config.mappings.length;
            
            // 更新映射详情表格
            const tbody = document.getElementById('mapping-list');
            tbody.innerHTML = '';
            
            config.mappings.forEach(mapping => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${mapping.source_field}</td>
                    <td>${mapping.target_field}</td>
                    <td>${mapping.target_table}</td>
                    <td><span class="badge bg-primary">${(mapping.similarity_score * 100).toFixed(1)}%</span></td>
                `;
                tbody.appendChild(row);
            });
        } else {
            showError('加载配置失败: ' + data.error);
        }
    } catch (error) {
        showError('加载配置时发生错误: ' + error.message);
    }
}

// 启动匹配任务
async function startMatching(event) {
    event.preventDefault();
    
    if (!currentConfigId) {
        showError('配置ID不存在');
        return;
    }
    
    const formData = new FormData(event.target);
    const matchingParams = {
        config_id: currentConfigId,
        match_type: document.getElementById('match-type').value,
        batch_size: parseInt(document.getElementById('batch-size').value),
        similarity_threshold: parseFloat(document.getElementById('similarity-threshold').value),
        max_results: parseInt(document.getElementById('max-results').value)
    };
    
    try {
        const response = await fetch('/api/start_dynamic_matching', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(matchingParams)
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentTaskId = data.task_id;
            showSuccess('匹配任务启动成功！任务ID: ' + currentTaskId);
            
            // 显示任务状态面板
            document.getElementById('task-status-panel').style.display = 'block';
            document.getElementById('stop-task-btn').style.display = 'inline-block';
            
            // 开始监控进度
            startProgressMonitoring();
        } else {
            showError('启动匹配任务失败: ' + data.error);
        }
    } catch (error) {
        showError('启动任务时发生错误: ' + error.message);
    }
}

// 开始进度监控
function startProgressMonitoring() {
    progressTimer = setInterval(async () => {
        try {
            const response = await fetch(`/api/matching_progress?task_id=${currentTaskId}`);
            const data = await response.json();
            
            if (data.success) {
                const progress = data.progress;
                
                // 更新进度条
                const progressBar = document.getElementById('progress-bar');
                progressBar.style.width = progress.percentage + '%';
                progressBar.textContent = progress.percentage + '%';
                
                // 更新状态文本
                document.getElementById('status-text').textContent = progress.status;
                document.getElementById('stats-text').textContent = 
                    `已处理: ${progress.processed} / ${progress.total}, 匹配数: ${progress.matches}`;
                
                // 如果任务完成
                if (progress.status === 'completed' || progress.status === 'failed') {
                    clearInterval(progressTimer);
                    document.getElementById('stop-task-btn').style.display = 'none';
                    document.getElementById('view-results-btn').style.display = 'inline-block';
                    
                    if (progress.status === 'completed') {
                        showSuccess('匹配任务完成！');
                    } else {
                        showError('匹配任务失败: ' + progress.error);
                    }
                }
            }
        } catch (error) {
            console.error('获取进度失败:', error);
        }
    }, 2000); // 每2秒更新一次
}

// 停止任务
async function stopTask() {
    if (!currentTaskId) return;
    
    try {
        const response = await fetch(`/api/stop_matching_task?task_id=${currentTaskId}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            clearInterval(progressTimer);
            document.getElementById('stop-task-btn').style.display = 'none';
            showSuccess('任务已停止');
        } else {
            showError('停止任务失败: ' + data.error);
        }
    } catch (error) {
        showError('停止任务时发生错误: ' + error.message);
    }
}

// 查看结果
function viewResults() {
    if (currentTaskId) {
        window.location.href = `/results?task_id=${currentTaskId}&config_id=${currentConfigId}`;
    }
}

// 预览匹配
async function previewMatching() {
    if (!currentConfigId) {
        showError('配置ID不存在');
        return;
    }
    
    const params = {
        config_id: currentConfigId,
        preview_count: 10
    };
    
    try {
        const response = await fetch('/api/preview_dynamic_matching', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(params)
        });
        
        const data = await response.json();
        
        if (data.success) {
            // 显示预览结果模态框
            showPreviewModal(data.preview_results);
        } else {
            showError('预览失败: ' + data.error);
        }
    } catch (error) {
        showError('预览时发生错误: ' + error.message);
    }
}

// 查看历史
function viewHistory() {
    window.location.href = '/matching_history?config_id=' + currentConfigId;
}

// 显示预览结果模态框
function showPreviewModal(results) {
    // 这里可以创建一个模态框显示预览结果
    // 为了简化，暂时使用alert
    alert('预览功能开发中，找到 ' + results.length + ' 个潜在匹配');
}

// 工具函数
function showSuccess(message) {
    // 显示成功消息
    console.log('Success:', message);
    // 这里可以添加更好的UI提示
}

function showError(message) {
    // 显示错误消息
    console.error('Error:', message);
    alert('错误: ' + message);
}
</script>

<style>
.card-header {
    border-bottom: none;
}

.progress {
    background-color: #e9ecef;
}

.progress-bar-animated {
    animation: progress-bar-stripes 1s linear infinite;
}

.badge {
    font-size: 0.8em;
}

.table-responsive {
    max-height: 300px;
    overflow-y: auto;
}

.btn-lg {
    padding: 12px 24px;
    font-size: 16px;
}

#task-status-panel {
    border-left: 4px solid #17a2b8;
}

.header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.header .text-muted {
    color: rgba(255,255,255,0.8) !important;
}
</style>
{% endblock %}
