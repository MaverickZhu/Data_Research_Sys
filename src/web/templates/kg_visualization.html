{% extends "base.html" %}

{% block title %}知识图谱可视化 - 消防单位建筑数据关联系统{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- 页面标题 -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-project-diagram text-primary"></i> 知识图谱可视化</h2>
                    <p class="text-muted">交互式知识图谱可视化浏览，支持节点拖拽、缩放、搜索和筛选</p>
                </div>
                <div>
                    <button class="btn btn-outline-secondary me-2" onclick="window.history.back()">
                        <i class="fas fa-arrow-left"></i> 返回
                    </button>
                    <a href="/" class="btn btn-outline-secondary">
                        <i class="fas fa-home"></i> 主页
                    </a>
                </div>
            </div>

            <!-- 控制面板 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-sliders-h"></i> 可视化控制</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- 数据加载控制 -->
                        <div class="col-md-3">
                            <label class="form-label">数据量控制</label>
                            <select class="form-select" id="data-limit">
                                <option value="100">100个节点（快速预览）</option>
                                <option value="500" selected>500个节点（推荐）</option>
                                <option value="1000">1000个节点（详细）</option>
                                <option value="2000">2000个节点（完整）</option>
                            </select>
                        </div>

                        <!-- 布局算法 -->
                        <div class="col-md-3">
                            <label class="form-label">布局算法</label>
                            <select class="form-select" id="layout-algorithm">
                                <option value="cose" selected>COSE（推荐）</option>
                                <option value="cola">Cola（层次）</option>
                                <option value="dagre">Dagre（有向图）</option>
                                <option value="circle">圆形布局</option>
                                <option value="grid">网格布局</option>
                                <option value="random">随机布局</option>
                            </select>
                        </div>

                        <!-- 实体类型筛选 -->
                        <div class="col-md-3">
                            <label class="form-label">实体类型</label>
                            <select class="form-select" id="entity-filter">
                                <option value="">所有类型</option>
                                <option value="ORGANIZATION">机构组织</option>
                                <option value="PERSON">人员</option>
                                <option value="LOCATION">地点位置</option>
                                <option value="IDENTIFIER">标识符</option>
                            </select>
                        </div>

                        <!-- 操作按钮 -->
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" onclick="loadVisualization()">
                                    <i class="fas fa-play"></i> 加载图谱
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <!-- 搜索功能 -->
                        <div class="col-md-6">
                            <label class="form-label">搜索节点</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="search-node" placeholder="输入实体名称搜索...">
                                <button class="btn btn-outline-primary" onclick="searchNodes()">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="clearSearch()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <!-- 视图控制 -->
                        <div class="col-md-6">
                            <label class="form-label">视图控制</label>
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-outline-secondary" onclick="fitToScreen()">
                                    <i class="fas fa-expand-arrows-alt"></i> 适应屏幕
                                </button>
                                <button class="btn btn-outline-secondary" onclick="resetZoom()">
                                    <i class="fas fa-search-minus"></i> 重置缩放
                                </button>
                                <button class="btn btn-outline-secondary" onclick="exportImage()">
                                    <i class="fas fa-download"></i> 导出图片
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 主要内容区域 -->
            <div class="row">
                <!-- 图谱可视化区域 -->
                <div class="col-md-9">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6><i class="fas fa-project-diagram"></i> 知识图谱</h6>
                            <div>
                                <span class="badge bg-primary" id="node-count">节点: 0</span>
                                <span class="badge bg-success" id="edge-count">边: 0</span>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div id="cy-container" style="height: 600px; background: #f8f9fa;">
                                <!-- Cytoscape.js 容器 -->
                                <div class="d-flex justify-content-center align-items-center h-100">
                                    <div class="text-center">
                                        <i class="fas fa-project-diagram fa-3x text-muted mb-3"></i>
                                        <h5 class="text-muted">点击"加载图谱"开始可视化</h5>
                                        <p class="text-muted">支持节点拖拽、缩放、搜索等交互功能</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 侧边信息面板 -->
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-info-circle"></i> 节点信息</h6>
                        </div>
                        <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                            <div id="node-info">
                                <div class="text-center text-muted p-4">
                                    <i class="fas fa-mouse-pointer fa-2x"></i>
                                    <p class="mt-2">点击节点查看详细信息</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 图例和统计 -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-palette"></i> 图例</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <h6>节点类型</h6>
                                    <div id="node-legend">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="legend-node organization me-2"></div>
                                            <span>机构组织</span>
                                        </div>
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="legend-node person me-2"></div>
                                            <span>人员</span>
                                        </div>
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="legend-node location me-2"></div>
                                            <span>地点位置</span>
                                        </div>
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="legend-node identifier me-2"></div>
                                            <span>标识符</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <h6>关系类型</h6>
                                    <div id="edge-legend">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="legend-edge solid me-2"></div>
                                            <span>强关系 (>0.8)</span>
                                        </div>
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="legend-edge dashed me-2"></div>
                                            <span>中等关系 (0.5-0.8)</span>
                                        </div>
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="legend-edge dotted me-2"></div>
                                            <span>弱关系 (<0.5)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-chart-bar"></i> 统计信息</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="stat-item">
                                        <h4 class="text-primary" id="total-nodes">0</h4>
                                        <small class="text-muted">总节点数</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-item">
                                        <h4 class="text-success" id="total-edges">0</h4>
                                        <small class="text-muted">总边数</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-item">
                                        <h4 class="text-info" id="visible-nodes">0</h4>
                                        <small class="text-muted">可见节点</small>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="stat-item">
                                        <h5 class="text-warning" id="selected-nodes">0</h5>
                                        <small class="text-muted">已选择</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-item">
                                        <h5 class="text-danger" id="highlighted-nodes">0</h5>
                                        <small class="text-muted">高亮显示</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 加载提示模态框 -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 id="loading-text">正在加载知识图谱数据...</h5>
                <p class="text-muted mb-0" id="loading-progress">准备中...</p>
            </div>
        </div>
    </div>
</div>

<style>
/* 图例样式 */
.legend-node {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    display: inline-block;
}

.legend-node.organization { background-color: #007bff; }
.legend-node.person { background-color: #28a745; }
.legend-node.location { background-color: #ffc107; }
.legend-node.identifier { background-color: #6f42c1; }

.legend-edge {
    width: 30px;
    height: 2px;
    display: inline-block;
    background-color: #6c757d;
}

.legend-edge.solid { border: none; }
.legend-edge.dashed { 
    background: repeating-linear-gradient(
        to right,
        #6c757d,
        #6c757d 5px,
        transparent 5px,
        transparent 10px
    );
}
.legend-edge.dotted { 
    background: repeating-linear-gradient(
        to right,
        #6c757d,
        #6c757d 2px,
        transparent 2px,
        transparent 6px
    );
}

/* 统计项样式 */
.stat-item {
    padding: 10px;
    border-radius: 8px;
    background: #f8f9fa;
    margin-bottom: 10px;
}

/* 响应式调整 */
@media (max-width: 768px) {
    #cy-container {
        height: 400px !important;
    }
    
    .card-body {
        max-height: 300px !important;
    }
}

/* Cytoscape容器样式 */
#cy-container {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

/* 控制面板样式 */
.form-label {
    font-weight: 600;
    color: #495057;
}

.btn-group .btn {
    flex: 1;
}
</style>

<!-- 引入Cytoscape.js - 使用备用CDN -->
<script src="https://cdn.jsdelivr.net/npm/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cytoscape-cose-bilkent@4.1.0/cytoscape-cose-bilkent.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cytoscape-cola@2.5.1/cytoscape-cola.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dagre@0.8.5/dist/dagre.min.js"></script>

<script>
// 全局变量
let cy = null;
let graphData = {
    nodes: [],
    edges: []
};
let loadingModal = null;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('知识图谱可视化页面加载完成');
    
    // 初始化模态框
    loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    
    // 注册Cytoscape扩展
    if (typeof cytoscape !== 'undefined') {
        // 注册布局扩展
        if (typeof cytoscapeCoseBilkent !== 'undefined') {
            cytoscape.use(cytoscapeCoseBilkent);
        }
        if (typeof cytoscapeCola !== 'undefined') {
            cytoscape.use(cytoscapeCola);
        }
        if (typeof cytoscapeDagre !== 'undefined') {
            cytoscape.use(cytoscapeDagre);
        }
        
        console.log('Cytoscape.js 及扩展加载完成');
        
        // 初始化Cytoscape容器
        initializeCytoscape();
        
        // 绑定事件监听器
        bindEvents();
        
        console.log('知识图谱可视化初始化完成');
    } else {
        console.error('Cytoscape.js 未加载');
        showError('图谱可视化库加载失败，请刷新页面重试');
    }
});

// 加载图谱可视化
async function loadVisualization() {
    const limit = document.getElementById('data-limit').value;
    const entityFilter = document.getElementById('entity-filter').value;
    
    try {
        // 显示加载提示
        showLoadingModal('正在加载知识图谱数据...', '准备中...');
        
        // 构建API参数
        const params = new URLSearchParams();
        params.append('limit', limit);
        if (entityFilter) {
            params.append('entity_type', entityFilter);
        }
        
        // 并行加载实体和关系数据
        updateLoadingProgress('正在获取实体数据...');
        const [entitiesResponse, relationsResponse] = await Promise.all([
            fetch(`/api/kg/falkor/entities?${params.toString()}`),
            fetch(`/api/kg/falkor/relations?${params.toString()}`)
        ]);
        
        if (!entitiesResponse.ok || !relationsResponse.ok) {
            throw new Error('API请求失败');
        }
        
        updateLoadingProgress('正在解析数据...');
        const entitiesData = await entitiesResponse.json();
        const relationsData = await relationsResponse.json();
        
        // 转换数据格式
        updateLoadingProgress('正在转换数据格式...');
        graphData = convertToGraphFormat(entitiesData.entities || [], relationsData.relations || []);
        
        // 初始化图谱
        updateLoadingProgress('正在初始化图谱...');
        initializeCytoscape();
        
        // 应用布局
        updateLoadingProgress('正在应用布局算法...');
        applyLayout();
        
        // 更新统计信息
        updateStatistics();
        
        // 隐藏加载提示
        hideLoadingModal();
        
        showSuccess(`图谱加载完成！节点: ${graphData.nodes.length}, 边: ${graphData.edges.length}`);
        
    } catch (error) {
        console.error('加载图谱失败:', error);
        hideLoadingModal();
        showError('加载图谱失败: ' + error.message);
    }
}

// 转换数据格式为Cytoscape格式
function convertToGraphFormat(entities, relations) {
    console.log('转换数据格式:', { entities: entities.length, relations: relations.length });
    
    // 创建实体ID到内部ID的映射
    const entityIdMap = new Map();
    const nodeIdSet = new Set();
    
    // 转换节点并建立ID映射
    const nodes = entities.map((entity, index) => {
        const originalId = String(entity.id);
        const internalId = `node_${index}`; // 使用统一的内部ID
        
        // 建立映射关系
        entityIdMap.set(originalId, internalId);
        nodeIdSet.add(internalId);
        
        return {
            data: {
                id: internalId,
                originalId: originalId,
                label: entity.label || entity.id,
                type: entity.type || 'UNKNOWN',
                confidence: entity.confidence || 0.9,
                graph_name: entity.graph_name,
                source_table: entity.source_table
            },
            classes: getNodeClass(entity.type)
        };
    });
    
    console.log('实体ID映射样例:', Array.from(entityIdMap.entries()).slice(0, 5));
    
    // 转换边，使用多种策略匹配节点
    const validEdges = [];
    const skippedEdges = [];
    
    relations.forEach((relation, index) => {
        let sourceId = null;
        let targetId = null;
        
        // 策略1: 直接ID匹配
        const subjectIdStr = String(relation.subject_id);
        const objectIdStr = String(relation.object_id);
        
        if (entityIdMap.has(subjectIdStr)) {
            sourceId = entityIdMap.get(subjectIdStr);
        }
        if (entityIdMap.has(objectIdStr)) {
            targetId = entityIdMap.get(objectIdStr);
        }
        
        // 策略2: 通过标签匹配（如果ID匹配失败）
        if (!sourceId && relation.subject_label) {
            for (const [originalId, internalId] of entityIdMap.entries()) {
                const entity = entities.find(e => String(e.id) === originalId);
                if (entity && entity.label === relation.subject_label) {
                    sourceId = internalId;
                    break;
                }
            }
        }
        
        if (!targetId && relation.object_label) {
            for (const [originalId, internalId] of entityIdMap.entries()) {
                const entity = entities.find(e => String(e.id) === originalId);
                if (entity && entity.label === relation.object_label) {
                    targetId = internalId;
                    break;
                }
            }
        }
        
        // 如果找到了有效的源和目标节点
        if (sourceId && targetId && nodeIdSet.has(sourceId) && nodeIdSet.has(targetId)) {
            validEdges.push({
                data: {
                    id: `edge_${index}`,
                    source: sourceId,
                    target: targetId,
                    label: relation.type || relation.predicate || 'UNKNOWN',
                    confidence: relation.confidence || 0.9,
                    graph_name: relation.graph_name,
                    subject_label: relation.subject_label,
                    object_label: relation.object_label,
                    original_subject_id: relation.subject_id,
                    original_object_id: relation.object_id
                },
                classes: getEdgeClass(relation.confidence || 0.9)
            });
        } else {
            skippedEdges.push({
                relation,
                reason: `源节点(${subjectIdStr}→${sourceId}) 或 目标节点(${objectIdStr}→${targetId}) 不存在`
            });
        }
    });
    
    console.log('数据转换完成:', { 
        nodes: nodes.length, 
        totalEdges: relations.length,
        validEdges: validEdges.length,
        skippedEdges: skippedEdges.length
    });
    
    // 输出前几个跳过的边用于调试
    if (skippedEdges.length > 0) {
        console.log('跳过的边样例:', skippedEdges.slice(0, 3));
    }
    
    return { nodes, edges: validEdges };
}

// 获取节点样式类
function getNodeClass(type) {
    const typeMap = {
        'ORGANIZATION': 'organization',
        'PERSON': 'person',
        'LOCATION': 'location',
        'IDENTIFIER': 'identifier'
    };
    return typeMap[type] || 'unknown';
}

// 获取边样式类
function getEdgeClass(confidence) {
    if (confidence >= 0.8) return 'strong-edge';
    if (confidence >= 0.5) return 'medium-edge';
    return 'weak-edge';
}

// 初始化Cytoscape实例
function initializeCytoscape() {
    const container = document.getElementById('cy-container');
    
    if (!container) {
        console.error('找不到图谱容器元素');
        return;
    }
    
    // 清空容器
    container.innerHTML = '';
    
    // 检查数据
    if (!graphData || !graphData.nodes || !graphData.edges) {
        console.warn('图谱数据为空，创建空实例');
        graphData = { nodes: [], edges: [] };
    }
    
    console.log('初始化Cytoscape，数据:', {
        nodes: graphData.nodes.length,
        edges: graphData.edges.length
    });
    
    // 创建Cytoscape实例
    try {
        cy = cytoscape({
            container: container,
            
            elements: [
                ...graphData.nodes,
                ...graphData.edges
            ],
        
        style: [
            // 节点样式
            {
                selector: 'node',
                style: {
                    'background-color': '#007bff',
                    'label': 'data(label)',
                    'color': '#333',
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'font-size': '12px',
                    'font-weight': 'bold',
                    'width': '30px',
                    'height': '30px',
                    'border-width': 2,
                    'border-color': '#fff',
                    'text-outline-width': 2,
                    'text-outline-color': '#fff'
                }
            },
            
            // 不同类型节点的颜色
            {
                selector: 'node.organization',
                style: { 'background-color': '#007bff' }
            },
            {
                selector: 'node.person',
                style: { 'background-color': '#28a745' }
            },
            {
                selector: 'node.location',
                style: { 'background-color': '#ffc107' }
            },
            {
                selector: 'node.identifier',
                style: { 'background-color': '#6f42c1' }
            },
            
            // 边样式
            {
                selector: 'edge',
                style: {
                    'width': 2,
                    'line-color': '#6c757d',
                    'target-arrow-color': '#6c757d',
                    'target-arrow-shape': 'triangle',
                    'curve-style': 'bezier',
                    'label': 'data(label)',
                    'font-size': '10px',
                    'color': '#495057',
                    'text-rotation': 'autorotate',
                    'text-margin-y': -10
                }
            },
            
            // 不同强度的边
            {
                selector: 'edge.strong-edge',
                style: {
                    'width': 3,
                    'line-color': '#28a745',
                    'target-arrow-color': '#28a745'
                }
            },
            {
                selector: 'edge.medium-edge',
                style: {
                    'width': 2,
                    'line-color': '#ffc107',
                    'target-arrow-color': '#ffc107',
                    'line-style': 'dashed'
                }
            },
            {
                selector: 'edge.weak-edge',
                style: {
                    'width': 1,
                    'line-color': '#6c757d',
                    'target-arrow-color': '#6c757d',
                    'line-style': 'dotted'
                }
            },
            
            // 选中状态
            {
                selector: 'node:selected',
                style: {
                    'border-width': 4,
                    'border-color': '#dc3545',
                    'background-color': '#dc3545'
                }
            },
            
            // 高亮状态
            {
                selector: 'node.highlighted',
                style: {
                    'border-width': 4,
                    'border-color': '#fd7e14',
                    'background-color': '#fd7e14'
                }
            }
        ],
        
        // 交互设置
        userZoomingEnabled: true,
        userPanningEnabled: true,
        boxSelectionEnabled: true,
        selectionType: 'single',
        
        // 初始视图
        zoom: 1,
        pan: { x: 0, y: 0 }
        });
        
        // 绑定事件
        bindCytoscapeEvents();
        
        console.log('Cytoscape实例初始化完成');
        
    } catch (error) {
        console.error('Cytoscape初始化失败:', error);
        showError('图谱初始化失败: ' + error.message);
        
        // 创建一个空的实例作为备用
        cy = cytoscape({
            container: container,
            elements: []
        });
    }
}

// 绑定Cytoscape事件
function bindCytoscapeEvents() {
    // 节点点击事件
    cy.on('tap', 'node', function(evt) {
        const node = evt.target;
        showNodeInfo(node.data());
        
        // 高亮相关节点
        highlightConnectedNodes(node);
    });
    
    // 边点击事件
    cy.on('tap', 'edge', function(evt) {
        const edge = evt.target;
        showEdgeInfo(edge.data());
    });
    
    // 背景点击事件
    cy.on('tap', function(evt) {
        if (evt.target === cy) {
            clearHighlight();
            clearNodeInfo();
        }
    });
    
    // 缩放事件
    cy.on('zoom', function() {
        updateZoomLevel();
    });
}

// 应用布局算法
function applyLayout() {
    const algorithm = document.getElementById('layout-algorithm').value;
    
    let layoutOptions = {
        name: algorithm,
        animate: true,
        animationDuration: 1000,
        fit: true,
        padding: 50
    };
    
    // 根据算法调整参数
    switch (algorithm) {
        case 'cose':
            layoutOptions = {
                ...layoutOptions,
                nodeRepulsion: 400000,
                nodeOverlap: 10,
                idealEdgeLength: 100,
                edgeElasticity: 100,
                nestingFactor: 5,
                gravity: 80,
                numIter: 1000,
                initialTemp: 200,
                coolingFactor: 0.95,
                minTemp: 1.0
            };
            break;
            
        case 'cola':
            layoutOptions = {
                ...layoutOptions,
                maxSimulationTime: 1500,
                ungrabifyWhileSimulating: false,
                fit: true,
                edgeLength: 100,
                nodeSpacing: 50
            };
            break;
            
        case 'dagre':
            layoutOptions = {
                ...layoutOptions,
                rankDir: 'TB',
                ranker: 'longest-path',
                nodeSep: 50,
                edgeSep: 10,
                rankSep: 100
            };
            break;
            
        case 'circle':
            layoutOptions = {
                ...layoutOptions,
                radius: Math.min(300, graphData.nodes.length * 5),
                spacing: 1.5
            };
            break;
            
        case 'grid':
            layoutOptions = {
                ...layoutOptions,
                rows: Math.ceil(Math.sqrt(graphData.nodes.length)),
                cols: Math.ceil(Math.sqrt(graphData.nodes.length)),
                spacing: 100
            };
            break;
    }
    
    const layout = cy.layout(layoutOptions);
    layout.run();
    
    console.log('应用布局算法:', algorithm);
}

// 显示节点信息
function showNodeInfo(nodeData) {
    const container = document.getElementById('node-info');
    
    const html = `
        <div class="node-details">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h5 class="mb-1">${nodeData.label}</h5>
                    <span class="badge bg-primary">${nodeData.type}</span>
                </div>
                <small class="text-muted">
                    置信度: ${(nodeData.confidence * 100).toFixed(1)}%
                </small>
            </div>
            
            <div class="mb-3">
                <h6>基本信息</h6>
                <table class="table table-sm">
                    <tr><td><strong>内部ID:</strong></td><td>${nodeData.id}</td></tr>
                    <tr><td><strong>原始ID:</strong></td><td>${nodeData.originalId || nodeData.id}</td></tr>
                    <tr><td><strong>标签:</strong></td><td>${nodeData.label}</td></tr>
                    <tr><td><strong>类型:</strong></td><td>${nodeData.type}</td></tr>
                    <tr><td><strong>置信度:</strong></td><td>${(nodeData.confidence * 100).toFixed(1)}%</td></tr>
                    <tr><td><strong>图谱来源:</strong></td><td>${nodeData.graph_name || '未知'}</td></tr>
                </table>
            </div>
            
            <div class="mb-3">
                <h6>连接统计</h6>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="stat-item">
                            <h5 class="text-primary" id="node-degree">-</h5>
                            <small>总连接数</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-item">
                            <h5 class="text-success" id="node-neighbors">-</h5>
                            <small>邻居节点</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="d-grid gap-2">
                <button class="btn btn-outline-primary btn-sm" onclick="focusOnNode('${nodeData.id}')">
                    <i class="fas fa-crosshairs"></i> 聚焦此节点
                </button>
                <button class="btn btn-outline-success btn-sm" onclick="showNeighbors('${nodeData.id}')">
                    <i class="fas fa-sitemap"></i> 显示邻居
                </button>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    
    // 更新连接统计
    const node = cy.getElementById(nodeData.id);
    const degree = node.degree();
    const neighbors = node.neighborhood().nodes().length;
    
    document.getElementById('node-degree').textContent = degree;
    document.getElementById('node-neighbors').textContent = neighbors;
}

// 显示边信息
function showEdgeInfo(edgeData) {
    const container = document.getElementById('node-info');
    
    const html = `
        <div class="edge-details">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h5 class="mb-1">${edgeData.label}</h5>
                    <span class="badge bg-success">关系</span>
                </div>
                <small class="text-muted">
                    置信度: ${(edgeData.confidence * 100).toFixed(1)}%
                </small>
            </div>
            
            <div class="mb-3">
                <h6>关系信息</h6>
                <table class="table table-sm">
                    <tr><td><strong>关系类型:</strong></td><td>${edgeData.label}</td></tr>
                    <tr><td><strong>源节点:</strong></td><td>${edgeData.source}</td></tr>
                    <tr><td><strong>目标节点:</strong></td><td>${edgeData.target}</td></tr>
                    <tr><td><strong>置信度:</strong></td><td>${(edgeData.confidence * 100).toFixed(1)}%</td></tr>
                    <tr><td><strong>图谱来源:</strong></td><td>${edgeData.graph_name || '未知'}</td></tr>
                </table>
            </div>
            
            <div class="alert alert-info">
                <strong>三元组表示:</strong><br>
                ${edgeData.source} → ${edgeData.label} → ${edgeData.target}
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

// 清空节点信息
function clearNodeInfo() {
    const container = document.getElementById('node-info');
    container.innerHTML = `
        <div class="text-center text-muted p-4">
            <i class="fas fa-mouse-pointer fa-2x"></i>
            <p class="mt-2">点击节点查看详细信息</p>
        </div>
    `;
}

// 高亮连接的节点
function highlightConnectedNodes(node) {
    // 清除之前的高亮
    cy.elements().removeClass('highlighted');
    
    // 高亮当前节点和其邻居
    const neighborhood = node.neighborhood();
    node.addClass('highlighted');
    neighborhood.nodes().addClass('highlighted');
    neighborhood.edges().addClass('highlighted');
    
    // 更新统计
    updateHighlightedCount(neighborhood.nodes().length + 1);
}

// 清除高亮
function clearHighlight() {
    cy.elements().removeClass('highlighted');
    updateHighlightedCount(0);
}

// 搜索节点
function searchNodes() {
    const query = document.getElementById('search-node').value.trim().toLowerCase();
    
    if (!query) {
        showError('请输入搜索关键词');
        return;
    }
    
    // 清除之前的高亮
    clearHighlight();
    
    // 搜索匹配的节点
    const matchedNodes = cy.nodes().filter(function(node) {
        const label = node.data('label').toLowerCase();
        const id = node.data('id').toLowerCase();
        return label.includes(query) || id.includes(query);
    });
    
    if (matchedNodes.length === 0) {
        showError('未找到匹配的节点');
        return;
    }
    
    // 高亮匹配的节点
    matchedNodes.addClass('highlighted');
    
    // 聚焦到第一个匹配的节点
    if (matchedNodes.length > 0) {
        cy.fit(matchedNodes, 50);
        showNodeInfo(matchedNodes[0].data());
    }
    
    showSuccess(`找到 ${matchedNodes.length} 个匹配的节点`);
    updateHighlightedCount(matchedNodes.length);
}

// 清除搜索
function clearSearch() {
    document.getElementById('search-node').value = '';
    clearHighlight();
    clearNodeInfo();
}

// 聚焦节点
function focusOnNode(nodeId) {
    const node = cy.getElementById(nodeId);
    if (node.length > 0) {
        cy.fit(node, 100);
        cy.center(node);
    }
}

// 显示邻居节点
function showNeighbors(nodeId) {
    const node = cy.getElementById(nodeId);
    const neighborhood = node.neighborhood();
    
    // 隐藏其他节点
    cy.elements().style('opacity', 0.1);
    
    // 显示当前节点和邻居
    node.style('opacity', 1);
    neighborhood.style('opacity', 1);
    
    // 聚焦到邻居网络
    cy.fit(node.union(neighborhood), 50);
    
    showSuccess(`显示了 ${neighborhood.nodes().length} 个邻居节点`);
}

// 适应屏幕
function fitToScreen() {
    cy.fit(cy.elements(), 50);
    cy.center();
}

// 重置缩放
function resetZoom() {
    cy.zoom(1);
    cy.center();
}

// 导出图片
function exportImage() {
    if (!cy) {
        showError('请先加载图谱');
        return;
    }
    
    const png64 = cy.png({
        output: 'base64uri',
        bg: 'white',
        full: true,
        scale: 2
    });
    
    // 创建下载链接
    const link = document.createElement('a');
    link.href = png64;
    link.download = `knowledge_graph_${new Date().toISOString().slice(0, 10)}.png`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showSuccess('图谱图片已导出');
}

// 更新统计信息
function updateStatistics() {
    document.getElementById('total-nodes').textContent = graphData.nodes.length;
    document.getElementById('total-edges').textContent = graphData.edges.length;
    document.getElementById('visible-nodes').textContent = graphData.nodes.length;
    document.getElementById('node-count').textContent = `节点: ${graphData.nodes.length}`;
    document.getElementById('edge-count').textContent = `边: ${graphData.edges.length}`;
    
    updateSelectedCount(0);
    updateHighlightedCount(0);
}

// 更新选中计数
function updateSelectedCount(count) {
    document.getElementById('selected-nodes').textContent = count;
}

// 更新高亮计数
function updateHighlightedCount(count) {
    document.getElementById('highlighted-nodes').textContent = count;
}

// 更新缩放级别
function updateZoomLevel() {
    if (cy) {
        const zoom = cy.zoom();
        console.log('当前缩放级别:', zoom.toFixed(2));
    }
}

// 显示加载模态框
function showLoadingModal(title, progress) {
    document.getElementById('loading-text').textContent = title;
    document.getElementById('loading-progress').textContent = progress;
    if (loadingModal) {
        loadingModal.show();
    }
}

// 更新加载进度
function updateLoadingProgress(progress) {
    document.getElementById('loading-progress').textContent = progress;
}

// 隐藏加载模态框
function hideLoadingModal() {
    if (loadingModal) {
        loadingModal.hide();
    }
}

// 工具函数
function showError(message) {
    console.error(message);
    alert('错误: ' + message);
}

function showSuccess(message) {
    console.log(message);
    // 可以替换为更好的通知组件
    const toast = document.createElement('div');
    toast.className = 'alert alert-success alert-dismissible fade show position-fixed';
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 3000);
}
</script>

{% endblock %}
